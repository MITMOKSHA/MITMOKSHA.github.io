<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"mitmoksha.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"hide","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Opportunities are ready for it, the more to beat action.">
<meta property="og:type" content="website">
<meta property="og:title" content="Moksha&#39;s Blog">
<meta property="og:url" content="https://mitmoksha.github.io/page/2/index.html">
<meta property="og:site_name" content="Moksha&#39;s Blog">
<meta property="og:description" content="Opportunities are ready for it, the more to beat action.">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Pishun Huang">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://mitmoksha.github.io/page/2/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Moksha's Blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Moksha's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Moksha's Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Pishun Huang</p>
  <div class="site-description" itemprop="description">Opportunities are ready for it, the more to beat action.</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">27</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://mitmoksha.github.io/2022/05/16/s081-lab2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Pishun Huang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Moksha's Blog">
      <meta itemprop="description" content="Opportunities are ready for it, the more to beat action.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Moksha's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/16/s081-lab2/" class="post-title-link" itemprop="url">MIT 6.S081 Lab2: System Calls</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-16 17:54:49" itemprop="dateCreated datePublished" datetime="2022-05-16T17:54:49+08:00">2022-05-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-05-18 09:16:19" itemprop="dateModified" datetime="2022-05-18T09:16:19+08:00">2022-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MIT-6-S081/" itemprop="url" rel="index"><span itemprop="name">MIT 6.S081</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <span id="more"></span>
<h1 id="mit-6.s081-lab2-system-calls">MIT 6.S081 Lab2: System Calls</h1>
<h2 id="system-call-tracing"><strong>1. System call tracing</strong></h2>
<h3 id="描述"><strong>1.1 描述</strong></h3>
<blockquote>
<p>In this assignment you will add a system call tracing feature that may help you when debugging later labs. You'll create a new trace system call that will control tracing. It should take one argument, an integer "mask", whose bits specify which system calls to trace. For example, to trace the fork system call, a program calls trace(1 &lt;&lt; SYS_fork), where SYS_fork is a syscall number from kernel/syscall.h. You have to modify the xv6 kernel to print out a line when each system call is about to return, if the system call's number is set in the mask. The line should contain the process id, the name of the system call and the return value; you don't need to print the system call arguments. The trace system call should enable tracing for the process that calls it and any children that it subsequently forks, but should not affect other processes.</p>
</blockquote>
<ul>
<li>将相应的文件添加到<em>user/user.h</em>和<em>user/usys.pl</em>中，向<em>kernel/syscall.h</em>文件中添加本实验所需要添加的系统调用号。</li>
<li>向<em>kernel/sysproc.c</em>中添加系统调用函数<em>sys_trace</em>，以及需要在进程的结构体中，新建一个变量Mask由低位开始偏移系统调用号个bit的值(通过观察<em>syscall.h</em>文件以及题目中给的case可以发现系统调用号对应二进制的bit)。</li>
<li>还需要再<em>kernel/proc.c/fork</em>函数中使得子进程继承父进程的Mask属性。</li>
<li>参照<em>kernel/syscall.c</em>中别的系统调用，通过阅读<em>user/trace.c</em>代码，使用<em>argint</em>函数来提取命令行中的第一个参数作为掩码赋给进程属性Mask，还需要定义系统调用号对应的系统调用名数组。</li>
<li>需要注意的点，a0作为返回值且a7作为系统调用号，在<em>trace</em>调用后打印信息时需要用到</li>
</ul>
<h3 id="实现"><strong>1.2 实现</strong></h3>
<p>这里贴出部分代码</p>
<p>kernel/syscall.c/syscall <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span></span></span><br><span class="line"><span class="function"><span class="title">syscall</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> num;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">proc</span> *p = <span class="built_in">myproc</span>();</span><br><span class="line"></span><br><span class="line">    num = p-&gt;trapframe-&gt;a7;</span><br><span class="line">    <span class="keyword">if</span>(num &gt; <span class="number">0</span> &amp;&amp; num &lt; <span class="built_in">NELEM</span>(syscalls) &amp;&amp; syscalls[num]) &#123;</span><br><span class="line">        p-&gt;trapframe-&gt;a0 = syscalls[num]();  <span class="comment">// reap return value.</span></span><br><span class="line">        <span class="keyword">if</span> ((<span class="number">1</span> &lt;&lt; num) &amp; p-&gt;mask)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d: syscall %s -&gt; %d\n&quot;</span>, p-&gt;pid, syscall_name[num], p-&gt;trapframe-&gt;a0);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d %s: unknown sys call %d\n&quot;</span>,</span><br><span class="line">                p-&gt;pid, p-&gt;name, num);</span><br><span class="line">        p-&gt;trapframe-&gt;a0 = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> kernel/sysproc.c/sys_trace <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">uint64</span></span><br><span class="line"><span class="function"><span class="title">sys_trace</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> mask;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">argint</span>(<span class="number">0</span>, &amp;mask) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="built_in">myproc</span>()-&gt;mask = mask;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> kernel/proc.c/fork <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">np-&gt;mask = p-&gt;mask;</span><br></pre></td></tr></table></figure></p>
<h2 id="sysinfo"><strong>2. Sysinfo</strong></h2>
<h3 id="描述-1"><strong>2.1 描述</strong></h3>
<blockquote>
<p>In this assignment you will add a system call, sysinfo, that collects information about the running system. The system call takes one argument: a pointer to a struct sysinfo (see kernel/sysinfo.h). The kernel should fill out the fields of this struct: the freemem field should be set to the number of bytes of free memory, and the nproc field should be set to the number of processes whose state is not UNUSED. We provide a test program sysinfotest; you pass this assignment if it prints "sysinfotest: OK".</p>
</blockquote>
<ul>
<li>类似trace系统调用将函数添加到相应文件中。</li>
<li>.需要参考函数<em>kernel/sysfile.c/sys_fstat</em>以及kernel/file.c/filestat中<em>copyout</em>函数的实现，即将内核数据复制到用户的虚拟地址空间。</li>
<li>需要在<em>kernel/kalloc.c</em>以及<em>kernel/proc.c</em>中添加函数，获取空闲内存的数量(字节为单位)，并获取状态为UNUSED状态的进程数，将两个函数的返回值分别赋给定义在<em>kernel/sysinfo.h</em>中sysinfo结构体的两个属性 <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">sysinfo</span> &#123;</span><br><span class="line">  uint64 freemem;   <span class="comment">// amount of free memory (bytes)</span></span><br><span class="line">  uint64 nproc;     <span class="comment">// number of process</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
<li>需要注意的是，在获取空闲内存的数量时，空闲链表的一个节点的大小为一个页的大小，遍历空闲链表即可获得结果。</li>
<li>该lab出现了比较少见的数组初始化方式Designated Initializers，详见<a target="_blank" rel="noopener" href="https://gcc.gnu.org/onlinedocs/gcc/Designated-Inits.html">此处</a></li>
</ul>
<h3 id="实现-1"><strong>2.2 实现</strong></h3>
<p>kernel/sysproc.c/sys_sysinfo <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">uint64</span></span><br><span class="line"><span class="function"><span class="title">sys_sysinfo</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    uint64 useraddr;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">argaddr</span>(<span class="number">0</span>, &amp;useraddr) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sysinfo</span> sys;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">proc</span>* p = <span class="built_in">myproc</span>();</span><br><span class="line">    sys.nproc = <span class="built_in">procnum</span>();</span><br><span class="line">    sys.freemem = <span class="built_in">freemem</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">copyout</span>(p-&gt;pagetable, useraddr, (<span class="type">char</span>*)&amp;sys, <span class="built_in">sizeof</span>(sys)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> kernel/kalloc.c/freemem <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">uint64</span></span><br><span class="line"><span class="function"><span class="title">freemem</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">run</span> *r;</span><br><span class="line">    uint64 n = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// every node of the freelist represent a page.</span></span><br><span class="line">    <span class="keyword">for</span> (r = kmem.freelist; r; r = r-&gt;next) &#123;</span><br><span class="line">        n += PGSIZE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> n;  <span class="comment">// return the bytes of free memory.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> kernel/proc/procnum <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">uint64 <span class="title">procnum</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">proc</span> *p;</span><br><span class="line">    uint64 num = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (p = proc; p &lt; &amp;proc[NPROC]; p++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (p-&gt;state != UNUSED)</span><br><span class="line">        num++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> num;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="总结">总结</h2>
<p>通过对lab2的学习，阅读了<em>kernel/proc.c</em>以及<em>kernel/proc.h</em>。通过熟悉进程的结构，从本质上理解了进程调度，进程上下文，并阅读了fork、exec等系统调用的源代码。lab2以动手实现系统调用形式，让我明白了其通过系统调用号进行索引，也了解了Designated Initializers的数组初始化形式。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://mitmoksha.github.io/2022/05/16/s081-lab1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Pishun Huang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Moksha's Blog">
      <meta itemprop="description" content="Opportunities are ready for it, the more to beat action.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Moksha's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/16/s081-lab1/" class="post-title-link" itemprop="url">MIT 6.S081 Lab1: Xv6 and Unix utilities</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-16 17:53:02" itemprop="dateCreated datePublished" datetime="2022-05-16T17:53:02+08:00">2022-05-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-05-18 09:16:14" itemprop="dateModified" datetime="2022-05-18T09:16:14+08:00">2022-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MIT-6-S081/" itemprop="url" rel="index"><span itemprop="name">MIT 6.S081</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <span id="more"></span>
<h1 id="mit-6.s081-lab1-xv6-and-unix-utilities">MIT 6.S081 Lab1: Xv6 and Unix utilities</h1>
<h2 id="sleep"><strong>1. sleep</strong></h2>
<h3 id="描述"><strong>1.1 描述</strong></h3>
<blockquote>
<p>Implement the UNIX program <strong><em>sleep</em></strong> for xv6; your <strong><em>sleep</em></strong> should pause for a user-specified number of ticks. A tick is a notion of time defined by the xv6 kernel, namely the time between two interrupts from the timer chip. Your solution should be in the file <strong><em>user/sleep.c</em></strong>.</p>
</blockquote>
<p>可以了解一下atoi的简单实现，参考一下user文件中的其他命令的实现。</p>
<h3 id="实现"><strong>1.2 实现</strong></h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/stat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user/user.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span></span></span><br><span class="line"><span class="function"><span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (argc &lt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="number">2</span>, <span class="string">&quot;usage: sleep second\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> i = <span class="built_in">atoi</span>(argv[<span class="number">1</span>]);</span><br><span class="line">  <span class="built_in">sleep</span>(i);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="pingpong"><strong>2. pingpong</strong></h2>
<h3 id="描述-1"><strong>2.1 描述</strong></h3>
<blockquote>
<p>Write a program that uses UNIX system calls to ''ping-pong'' a byte between two processes over a pair of pipes, one for each direction. The parent should send a byte to the child; the child should print "<pid>: received ping", where <pid> is its process ID, write the byte on the pipe to the parent, and exit; the parent should read the byte from the child, print "<pid>: received pong", and exit. Your solution should be in the file user/pingpong.c.</p>
</blockquote>
<p>需要熟悉fork、write、read、pipe等系统调用的使用，来实现父进程与子进程之间的通过管道的数据传输，应用在xv6中的实现的一组库函数(在user/user.h中)来实现本例。</p>
<h3 id="实现-1"><strong>2.2 实现</strong></h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/stat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user/user.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> buf[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span></span></span><br><span class="line"><span class="function"><span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">  <span class="type">int</span> p[<span class="number">2</span>];</span><br><span class="line">  <span class="built_in">pipe</span>(p);</span><br><span class="line">  <span class="type">int</span> pid = fork();</span><br><span class="line">  <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;  <span class="comment">// parent</span></span><br><span class="line">    <span class="built_in">close</span>(p[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">write</span>(p[<span class="number">1</span>], buf, <span class="built_in">sizeof</span>(buf)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">wait</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%d: received pong\n&quot;</span>, <span class="built_in">getpid</span>());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">close</span>(p[<span class="number">1</span>]);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;  <span class="comment">// child</span></span><br><span class="line">    <span class="built_in">close</span>(p[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">read</span>(p[<span class="number">0</span>], buf, <span class="built_in">sizeof</span>(buf)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%d: received ping\n&quot;</span>, <span class="built_in">getpid</span>());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">close</span>(p[<span class="number">0</span>]);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;  <span class="comment">// error</span></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="number">2</span>, <span class="string">&quot;error\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="primes"><strong>3. primes</strong></h2>
<h3 id="描述-2"><strong>3.1 描述</strong></h3>
<blockquote>
<p>Write a concurrent version of prime sieve using pipes. This idea is due to Doug McIlroy, inventor of Unix pipes. The picture halfway down this page and the surrounding text explain how to do it. Your solution should be in the file user/primes.c.</p>
</blockquote>
<p>应用埃氏筛法实现对素数的筛选，下面给出的是迭代实现，注意利用该条件终止迭代<em>Hint: read returns zero when the write-side of a pipe is closed.</em>。每次迭代创建一个管道，父进程通过将原始数据写管道，子进程在读阶段将数据中非素数筛出并保留筛出数据到缓冲区供下次传递使用，并打印数据</p>
<h3 id="实现-2"><strong>3.2 实现</strong></h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/stat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user/user.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span></span></span><br><span class="line"><span class="function"><span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> </span>&#123;</span><br><span class="line">  <span class="type">int</span> p[<span class="number">2</span>];</span><br><span class="line">  <span class="type">int</span> buf[<span class="number">36</span>];</span><br><span class="line">  <span class="type">int</span> pid = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// initialize.</span></span><br><span class="line">  <span class="type">int</span> index = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">2</span>; i &lt;= <span class="number">35</span>; ++i) &#123;</span><br><span class="line">    buf[index++] = i;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// use the sieve function 埃氏筛法</span></span><br><span class="line">  <span class="keyword">while</span> (index &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">pipe</span>(p);  <span class="comment">// Create pipe every valid loop.</span></span><br><span class="line">    <span class="keyword">if</span> ((pid = fork()) == <span class="number">0</span>) &#123;     <span class="comment">// child</span></span><br><span class="line">      <span class="comment">// sieve operation.</span></span><br><span class="line">      <span class="type">int</span> prime = <span class="number">0</span>;</span><br><span class="line">      <span class="type">int</span> index = <span class="number">-1</span>;</span><br><span class="line">      <span class="type">int</span> temp = <span class="number">0</span>;</span><br><span class="line">      <span class="built_in">close</span>(p[<span class="number">1</span>]);</span><br><span class="line">      <span class="keyword">while</span> (<span class="built_in">read</span>(p[<span class="number">0</span>], &amp;temp, <span class="built_in">sizeof</span>(temp)) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// handle to sieve prime numbers.</span></span><br><span class="line">        <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</span><br><span class="line">          prime = temp;</span><br><span class="line">          index++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (temp % prime != <span class="number">0</span>) buf[index++] = temp;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;prime %d\n&quot;</span>, prime);</span><br><span class="line">      <span class="built_in">close</span>(p[<span class="number">0</span>]);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;  <span class="comment">// parent</span></span><br><span class="line">      <span class="built_in">close</span>(p[<span class="number">0</span>]);</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; index; ++i) &#123;</span><br><span class="line">        <span class="built_in">write</span>(p[<span class="number">1</span>], &amp;buf[i], <span class="built_in">sizeof</span>(buf[i]);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">close</span>(p[<span class="number">1</span>]);</span><br><span class="line">      <span class="built_in">wait</span>(<span class="number">0</span>);   <span class="comment">// main process is waiting all child processes to quit.</span></span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>); </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">fprintf</span>(<span class="number">2</span>, <span class="string">&quot;fork failure.\n&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="find"><strong>4. find</strong></h2>
<h3 id="描述-3"><strong>4.1 描述</strong></h3>
<blockquote>
<p>Write a simple version of the UNIX find program: find all the files in a directory tree with a specific name. Your solution should be in the file user/find.c.</p>
</blockquote>
<p>参考<em>user/ls.c</em>文件了解如何读取目录，其实实现是类似的，只不过find命令需要实现递归。</p>
<h3 id="实现-3"><strong>4.2 实现</strong></h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/stat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user/user.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/fs.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief transmit the complete filename path to the filename eradicated dir.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param path complete filename path.</span></span><br><span class="line"><span class="comment"> * @return return the filename eradicated part behind the last slash &quot;/&quot;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">char</span>*</span></span><br><span class="line"><span class="function"><span class="title">fmtname</span><span class="params">(<span class="type">char</span>* path)</span> </span>&#123;</span><br><span class="line">  <span class="type">static</span> <span class="type">char</span> buf[DIRSIZ+<span class="number">1</span>];</span><br><span class="line">  <span class="type">char</span>* p;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (p = path+<span class="built_in">strlen</span>(path); p &gt;= path &amp;&amp; *p != <span class="string">&#x27;/&#x27;</span>; p--);</span><br><span class="line">  p++;  <span class="comment">// jump the slash.</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strlen</span>(p) &gt;= DIRSIZ)</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">  <span class="built_in">memmove</span>(buf, p, <span class="built_in">strlen</span>(p));</span><br><span class="line">  <span class="comment">/* fill the white space into the rest of the DIRSIZ that</span></span><br><span class="line"><span class="comment">   * guarantee the correctness of strcmp func.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="built_in">memset</span>(buf+<span class="built_in">strlen</span>(p), <span class="string">&#x27; &#x27;</span>, DIRSIZ-<span class="built_in">strlen</span>(p));</span><br><span class="line">  buf[<span class="built_in">strlen</span>(p)] = <span class="number">0</span>;   <span class="comment">// null-terminated string</span></span><br><span class="line">  <span class="keyword">return</span> buf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span></span></span><br><span class="line"><span class="function"><span class="title">find</span><span class="params">(<span class="type">char</span>* path, <span class="type">char</span>* name)</span> </span>&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">512</span>], *p;</span><br><span class="line">  <span class="type">int</span> fd;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">dirent</span> de;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">stat</span> st;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((fd = <span class="built_in">open</span>(path, <span class="number">0</span>)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="number">2</span>, <span class="string">&quot;find: cannot open %s\n&quot;</span>, path);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">fstat</span>(fd, &amp;st) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="number">2</span>, <span class="string">&quot;find: cannot open %s\n&quot;</span>, path);</span><br><span class="line">    <span class="built_in">close</span>(fd);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (st.type)</span><br><span class="line">  &#123;</span><br><span class="line">  <span class="keyword">case</span> T_FILE:</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name, <span class="built_in">fmtname</span>(path)))</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, path);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">case</span> T_DIR:</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strlen</span>(path)+<span class="number">1</span>+DIRSIZ+<span class="number">1</span> &gt; <span class="built_in">sizeof</span>(buf)) &#123;  <span class="comment">// the two &quot;1&quot; represent the null placeholder.</span></span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;find: path too long\n&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* buf store the complete path and hold the buf pointer in front of it that</span></span><br><span class="line"><span class="comment">     * is convenient to print the complete path which we expect to output.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="built_in">strcpy</span>(buf, path);</span><br><span class="line">    p = buf + <span class="built_in">strlen</span>(buf);</span><br><span class="line">    *p++ = <span class="string">&#x27;/&#x27;</span>;   <span class="comment">// i.e. *(p++) = &#x27;/&#x27;.</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">read</span>(fd, &amp;de, <span class="built_in">sizeof</span>(de)) == <span class="built_in">sizeof</span>(de)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (de.inum == <span class="number">0</span>)  <span class="comment">// inode number == 0.</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      <span class="built_in">memmove</span>(p, de.name, DIRSIZ);  <span class="comment">// move the dirname to p.</span></span><br><span class="line">      p[DIRSIZ] = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(de.name, <span class="string">&quot;.&quot;</span>) || !<span class="built_in">strcmp</span>(de.name, <span class="string">&quot;..&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">find</span>(buf, name);  <span class="comment">// recursive.</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">close</span>(fd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span></span></span><br><span class="line"><span class="function"><span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (argc &lt; <span class="number">3</span>) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="number">2</span>, <span class="string">&quot;usage: find path name...\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">2</span>; i &lt; argc; ++i) &#123;</span><br><span class="line">    <span class="built_in">find</span>(argv[<span class="number">1</span>], argv[i]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="xargs"><strong>5. xargs</strong></h2>
<h3 id="描述-4"><strong>5.1 描述</strong></h3>
<blockquote>
<p>Write a simple version of the UNIX xargs program: read lines from the standard input and run a command for each line, supplying the line as arguments to the command. Your solution should be in the file user/xargs.c.</p>
</blockquote>
<p>需要去了解linux中<a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man1/xargs.1.html">xargs</a>命令的实现，需要注意的是argv提取的是由xargs之后的参数。将管道一端的标准输出作为管道另一端的标准输入。通过read从标准输入读数据，将其中的参数由''和' '分割，并保存作为最终的参数数组由exec系统调用执行。xargs - build and execute command lines from standard input，完成了用标准输入的内容作为xargs的参数</p>
<h3 id="实现-4"><strong>5.2 实现</strong></h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user/user.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/param.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAXLINE 1024</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span></span></span><br><span class="line"><span class="function"><span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (argc &gt; MAXARG) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="number">2</span>, <span class="string">&quot;xargs: arg is too much\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">char</span>* param[MAXARG];</span><br><span class="line">  <span class="type">char</span> line[MAXLINE];</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> pid;</span><br><span class="line">  <span class="type">int</span> n;</span><br><span class="line">  <span class="type">int</span> arg_param = <span class="number">0</span>;</span><br><span class="line">  <span class="type">char</span>* cmd = argv[<span class="number">1</span>];</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; argc; ++i)</span><br><span class="line">    param[arg_param++] = argv[i];</span><br><span class="line">  <span class="keyword">if</span> ((pid=fork()) &gt; <span class="number">0</span>) &#123;   <span class="comment">// parent.</span></span><br><span class="line">    <span class="built_in">wait</span>(<span class="number">0</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;    <span class="comment">// child.</span></span><br><span class="line">    <span class="type">int</span> index = <span class="number">0</span>;  <span class="comment">// index the each line.</span></span><br><span class="line">    <span class="type">char</span>* arg = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">    <span class="comment">// read the STDIN that is before &quot;|&quot; to param array.</span></span><br><span class="line">    <span class="keyword">while</span>((n = <span class="built_in">read</span>(<span class="number">0</span>, line, MAXLINE)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (line[i] == <span class="string">&#x27; &#x27;</span> || line[i] == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">          arg[index] = <span class="number">0</span>;  <span class="comment">// &#x27;\0&#x27;</span></span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, arg);</span><br><span class="line">          index = <span class="number">0</span>;</span><br><span class="line">          param[arg_param++] = arg;</span><br><span class="line">          arg = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="type">char</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          arg[index++] = line[i];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">exec</span>(cmd, param);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="number">2</span>, <span class="string">&quot;fork error\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><strong>总结</strong></h2>
<p>通过完成lab1中xv6相应的命令函数的实现，以及相关代码的阅读，加深了了我对linux部分命令实现原理的理解，同时也熟悉了基本的系统调用函数。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://mitmoksha.github.io/2022/05/16/CS61B-GITLET-PROJECT/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Pishun Huang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Moksha's Blog">
      <meta itemprop="description" content="Opportunities are ready for it, the more to beat action.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Moksha's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/16/CS61B-GITLET-PROJECT/" class="post-title-link" itemprop="url">CS61B GITLET PROJECT</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-16 17:39:52" itemprop="dateCreated datePublished" datetime="2022-05-16T17:39:52+08:00">2022-05-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-05-18 09:15:26" itemprop="dateModified" datetime="2022-05-18T09:15:26+08:00">2022-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CS61B/" itemprop="url" rel="index"><span itemprop="name">CS61B</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <span id="more"></span>
<h1 id="cs61b-gitlet">CS61B Gitlet</h1>
<h2 id="project-2-getting-startedlab6"><strong>Project 2 Getting Started(Lab6)</strong></h2>
<h3 id="preperation"><strong>Preperation</strong></h3>
<p>首先使用<code>git submodule update --init --recursive</code>命令将21sp的library更新，再一并复制过来。记得再当前操作系统中设置<code>REPO_DIR</code>环境变量为所有projA、HW的根目录。切记要注意看文档, 以及其中给出的设置来实现相应的功能, 最后才发现FAQ也给了非常好的提示，另外比如说在我的机器上使用<code>python</code>而不是<code>python3</code>，<code>make check</code>是跑不通的，需要找到<code>Makefile</code>的第25行, 修改为<code>PYTHON = python</code>。 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">java capers.Main story <span class="string">&quot;Once upon a time, there was a beautiful dog.&quot;</span></span></span><br><span class="line">Once upon a time, there was a beautiful dog.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">java capers.Main story <span class="string">&quot;That dog was named Fjerf.&quot;</span></span></span><br><span class="line">Once upon a time, there was a beautiful dog.</span><br><span class="line">That dog was named Fjerf.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">java capers.Main story <span class="string">&quot;Fjerf loved to run and jump.&quot;</span></span></span><br><span class="line">Once upon a time, there was a beautiful dog.</span><br><span class="line">That dog was named Fjerf.</span><br><span class="line">Fjerf loved to run and jump.</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">java capers.Main dog Mammoth <span class="string">&quot;German Spitz&quot;</span> 10</span></span><br><span class="line">Woof! My name is Mammoth and I am a German Spitz! I am 10 years old! Woof!</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">java capers.Main dog Qitmir Saluki 3</span> </span><br><span class="line">Woof! My name is Qitmir and I am a Saluki! I am 3 years old! Woof!</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">java capers.Main birthday Qitmir</span></span><br><span class="line">Woof! My name is Qitmir and I am a Saluki! I am 4 years old! Woof!</span><br><span class="line">Happy birthday! Woof! Woof!</span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">java capers.Main birthday Qitmir</span></span><br><span class="line">Woof! My name is Qitmir and I am a Saluki! I am 5 years old! Woof!</span><br><span class="line">Happy birthday! Woof! Woof!</span><br></pre></td></tr></table></figure> 准备开始Gitlet:</p>
<h2 id="gitlet"><strong>Gitlet</strong></h2>
<h3 id="参考资料"><strong>参考资料</strong></h3>
<ul>
<li>Git pro book</li>
</ul>
<h3 id="note"><strong>Note</strong></h3>
<ul>
<li>往年课程的<a target="_blank" rel="noopener" href="https://cdn-uploads.piazza.com/attach/k5eevxebzpj25b/jqr7jm9igtc7l5/k97ipfmgmb3n/Gitlet_Slides.pdf">Slide</a>很好地以图片的形式介绍了<code>Gitlet</code>中的各个命令的实现。</li>
<li><a target="_blank" rel="noopener" href="https://paper.dropbox.com/doc/Gitlet-Persistence-zEnTGJhtUMtGr8ILYhoab">Gitlet Persistence</a></li>
<li><a target="_blank" rel="noopener" href="https://chinese.freecodecamp.org/news/git-internals-objects-branches-create-repo/#:~:text=%E5%9C%A8%20git%20%E4%B8%AD%EF%BC%8C%E6%96%87%E4%BB%B6%E7%9A%84,%E2%80%94%E2%80%94%E6%95%B0%E6%8D%AE%E7%9A%84%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%B5%81%E3%80%82">这里</a>有Git比较详细的图解。</li>
<li>仔细阅读<code>gitlet.Utils</code>中封装好的方法。</li>
<li>编写设计文档，<a target="_blank" rel="noopener" href="https://sp21.datastructur.es/materials/proj/proj2/design.html">规格</a>和<a target="_blank" rel="noopener" href="https://sp21.datastructur.es/materials/proj/proj2/capers-example">示例</a></li>
<li>Git的内部结构
<ul>
<li>blob(Binary Large Object): 文件的保存内容。一个文件可能对应多个blob：每个blob在不同的<code>Commit</code>中被跟踪。</li>
<li>Tree: 映射文件名称(name)到blob的reference，或者是映射文件名称到其他tree(子目录)的引用。</li>
<li>commits: 日志消息，其他元数据(提交日期、作者等), 对树的引用和对Parent Commit的引用。<code>repository</code>还维护了分支头到提交引用的映射(以便某些重要的提交具有符号名称)</li>
</ul></li>
<li>Gitlet简化的部分
<ul>
<li>将树合并到Commit中而不处理子目录</li>
<li>只能两个父级合并</li>
<li>元数据仅包含时间戳和日志消息，因此Commit将由<code>日志消息</code>, <code>时间戳</code>, <code>文件名</code>到<code>Blob</code>引用的映射，<code>父引用</code>, (用于Merge的)<code>第二个父引用</code>来组成。</li>
</ul></li>
<li>每个blob和每个commit都有一个唯一的整数id，用作该对象的<strong>引用</strong>。</li>
<li>当使用SHA-1哈希一个Commit时，会包括所有的数据和引用。</li>
<li>区分<code>Commit</code>和<code>Blob</code>的哈希值，一种方法是可以在两个类中各自定义一个属性字段来实现。</li>
<li>不应该在Main中做完所有事情，而是将需要实现的内容封装成一个函数到<code>Repository</code>类中去。</li>
<li>序列化最好使用<code>TreeMap</code>而不是<code>HashMap</code>。</li>
<li><code>Gitlet</code>不会出现<code>deteched head</code>(分离头部)的状态。指的是当前<code>HEAD</code>指向的Commit不表示任何一个分支。</li>
</ul>
<h3 id="注意事项"><strong>注意事项</strong></h3>
<ul>
<li>在<code>terminal</code>下出现了<code>Esc</code>无法退出<code>insert mode</code>而且还进入了<code>Itellij</code>的编辑界面。解决方案看<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/f1ae155cda6e">此处</a></li>
<li>暂存区包含两个区域, <code>stage for addition</code>和<code>stage for removal</code>。</li>
<li><code>gitlet</code>中一条命令对应运行一次程序，因此需要将用到的数据结构序列化为字节流后保存到文件中。</li>
<li>在实验一开始给的<code>Utils</code>类中， 不需要使用<code>createNewFile()</code>来创建文件, 因为<code>writeObject()</code>中会调用<code>WriteContent()</code>，若文件不存在则会自动创建，或者文件存在则覆盖掉它。</li>
<li>注意要在当前目录下执行<code>make check</code>，测试文件可能跑通(可能需要操作src/目录中的文件)。</li>
<li>注意每次更新数据时都需要序列化对象和反序列化文件, 保证更新的数据能够及时存储到文件中。</li>
<li>也需要将<code>blobs</code>的映射集合序列化存储起来(同样用TreeMap)，<code>checkout</code>命令要使用(用SHA-ID(文件名+文件内容)来作为文件名)。在<code>add</code>命令将blob和文件名映射放入<code>stage for addition</code>的同时，将blob和文件内容的映射放入<code>blobs</code>集合。</li>
<li><code>blob</code>生成<code>blobId</code>(sha-1 id)的时候，需要通过<code>文件名+文件内容(字节流)</code>生成。若只用文件内容生成<code>blobId</code>，不同名的两个文件内容都为空时，生成的<code>blobId</code>是一致的, 使用<code>文件名+文件对象</code>生成的sha-1哈希也是同样的结果。</li>
<li><code>mkdirs()</code>方法可以一同创建之前未存在的父目录。</li>
<li>注意写文件内容时用<code>writeContent()</code>而不是<code>writeObject()</code>。注意到<code>writeObject</code>会在调用<code>writeContent</code>前将第二个参数先序列化, 若将字节数组再序列化，可能会在内容中写入额外的信息。</li>
<li><code>Untracked file</code>，既没有被当前<code>commit</code>跟踪，也没有被放到<code>stage area</code>里。或者是已经被<code>stage for removal</code>但是又重新创建了。(考虑到我这里rm情况下没有将其从暂存区删除，仅仅是将它从<code>stage for removal</code>删除了而已)。</li>
<li>保证分支头只有一个, <code>get(0)</code>可以直接取(这里我将分支做所处的位置做成了一个目录，目录中是用分支名来命名的文件, 方便直接取头Commit)。</li>
<li>暂存区使用<code>blobId</code>映射<code>文件对象</code>不可取(序列化后提取的文件内容还是的却决于当前工作目录下的内容，不符合预期)，试试映射文件内容(字符串readContentsAsString)。经过调试发现必须得映射字节流，因为前面生成blobId中需要<code>文件名+文件内容(字节流)</code>。</li>
<li>注意<code>Utils</code>中的<code>restrictedDelete()</code>方法，是如果文件存在则删除, 如果文件对象不存在则删除未成功返回false, 给我们实现<code>rm</code>指令来删除当前工作目录中的文件提供了一个很好的帮助。</li>
<li>需要在每次<code>commit</code>命令执行时都更新分支头目录中的数据以及其对应<code>branches</code>目录中的数据。</li>
<li>除了<code>init</code>之外剩下的命令在处理之前都需要检测当前<code>.gitlet</code>目录是否存在, 若不存在则输出报错信息。</li>
<li>在开始项目任何一个功能前一定要有一个<code>Big picture</code>和整体思路，确保在实现过程中能够顺利进行。</li>
</ul>
<h3 id="测试"><strong>测试</strong></h3>
<ul>
<li>查看<code>tester.py</code>文档中一些相应的操作来对应测试文件。测试文件可以从<code>AG</code>中获取。</li>
</ul>
<h3 id="init"><strong>init</strong></h3>
<ul>
<li>创建<code>.gitlet</code>目录，并在其中新建一些文件来存储序列化信息。</li>
<li><code>init</code>会自动创建一个包含initial commit信息的<code>Commit</code>开始</li>
</ul>
<h3 id="add"><strong>add</strong></h3>
<ul>
<li>暂存已经暂存过的文件，会用新内容来覆盖先前的内容。</li>
<li>若当前需要暂存的文件与Commit跟踪的文件版本一致(包括其修改之后又还原内容的文件，blobId都是一致的)，则不对它进行处理。</li>
<li>若当前添加文件在<code>Stage for removal</code>中，则将它从里面删除。</li>
<li>gitlet一次只能添加一个文件。</li>
<li>维护一个<code>TreeMap</code>来存放<code>stage for addition</code>文件。</li>
</ul>
<h3 id="commit"><strong>commit</strong></h3>
<ul>
<li>需要考虑在当前跟踪的文件可能在新的Commit中未被跟踪，与rm指令将文件<code>Stage for removal</code>相关。</li>
<li>当前Commit跟踪的blob需要加上其父Commit跟踪的blob(前提是父Commit中跟踪的blob未被当前Commit跟踪的文件覆盖过)。</li>
<li><code>commmit</code>后将<code>stage area</code>清空，也就是<code>stage for add</code>和<code>stage for removal</code>。</li>
<li>若没有文件被暂存，或没有提交信息则中止。</li>
</ul>
<h3 id="rm"><strong>rm</strong></h3>
<ul>
<li>若当前文件正在<code>stage for addition</code>，则将它从里面移除。</li>
<li>若文件在当前<code>Commit</code>中被跟踪，则将其放入<code>stage for removal</code>暂存区中, 同时将本地目录文件删除。</li>
<li>只考虑被当前Commit跟踪的情况下</li>
<li>维护一个<code>TreeMap</code>来存放<code>stage for removal</code>文件。</li>
</ul>
<h3 id="log"><strong>log</strong></h3>
<ul>
<li>注意显示的是太平洋标准时间而不是UTC。</li>
<li>当前操作系统显示时间得调成英文显示，否则打印log会出现中文字样</li>
</ul>
<h3 id="find"><strong>find</strong></h3>
<ul>
<li>通过<code>Utils</code>类中给的方法<code>plainFilenamesIn</code>, 直接遍历<code>commit Id</code>所处的目录，若出现<code>commit</code>对象不同但提交信息一致的打印情况，分行打印各自的<code>commit id</code>。</li>
</ul>
<h3 id="status"><strong>status</strong></h3>
<ul>
<li><code>TreeMap</code>数据结构会按照字典序来排序。</li>
<li><code>Untrack file</code>，既未跟踪也未暂存。未跟踪将当前目录下的文件名和当前最新Commit中track的文件名做对比。若未包含则说明未跟踪。同样包括已经准备删除但又重新创建的文件(说明其还在<code>stage for removal</code>里，因为<code>stage area</code>只在commit时删除)。思考该该怎么标记? rm之后add的文件?</li>
<li><code>modified</code>, 同样与Commit中track对比，若文件名相同，但BlobId不同则说明被修改过。</li>
<li>遍历当前跟踪的文件，使用<code>exist</code>判断文件对象是否存在以及是否存在于<code>stage for removal</code>，就能判断文件是否被<code>delete</code>。</li>
</ul>
<h3 id="checkout"><strong>checkout</strong></h3>
<ul>
<li>有三类<code>checkuout</code>:
<ul>
<li>java gitlet.Main checkout -- [file name]</li>
<li>java gitlet.Main checkout [commit id] -- [file name]</li>
<li>java gitlet.Main checkout [branch name]</li>
</ul></li>
<li>若<code>checkout</code>切换分支，且当前目录下文件有文件未被跟踪，则打印提示信息并退出。</li>
<li>注意切换完成，将新分支放入<code>heads</code>目录的同时，从<code>heads</code>目录中删除先前的分支。</li>
<li><code>checkout filename</code>将当前文件从<code>head commit</code>中拿到当前工作目录。</li>
<li>切换到另一个分支要将暂存区清空。要将当前commit中跟踪了但切换到的分支commit中没有跟踪的文件删除(如果有则覆盖)。</li>
<li>考虑两种情况:
<ul>
<li><code>checkout</code>的目标分支跟踪的文件比当前目录的文件多，直接写就行了</li>
<li><code>checkout</code>的目标分支跟踪的文件比当前目录的文件少，需要删除本地目录中多余的文件</li>
<li>这两中情况都需要遍历当前目录中的所有文件名来确定。</li>
</ul></li>
<li>一个<strong>错误的策略</strong>是切换之前先将当前当前文件下所有的都删除，然后再将切换到的分支commit跟踪的文件写进CWD当前工作目录, 在后续将跟踪文件写入当前工作目录时，取不到文件对象了。</li>
<li><code>checkout branchName</code>时需要将暂存区清空。</li>
<li>后面还有一个<code>checkout shortid</code>的测试，需要包括通过commitid的前8就能切换到不同的分支。和commitId一样序列化到磁盘上的文件就行。</li>
<li>gitlet<strong>不允许</strong>删除提交。</li>
</ul>
<h3 id="reset"><strong>reset</strong></h3>
<ul>
<li>神似<code>checkout branchName</code>, 只是最后是将<code>当前branch</code>回退而不是切换分支。</li>
</ul>
<h3 id="branch"><strong>branch</strong></h3>
<ul>
<li>只新建一个分支(即在branches目录中新建一个序列化的分支Commit文件), 但是并未切换到新建的分支。</li>
</ul>
<h3 id="merge"><strong>merge</strong></h3>
<ul>
<li>将给定分支名为branchName的文件合并到当前分支中。</li>
<li>如何找到<code>split point</code>? 考虑到gitlet只支持两个分支合并，因此可以把新建分支的commit作为split point?! hhh笑死ucb学生视频里第一个提问和我想得一模一样。我感觉这种方法在gitlet中可行，但在多分支合并时就不行了。还是得去过一遍图的遍历这一节的slide。</li>
<li><strong>Latest common ancestor</strong>其实指的也就是<code>split point</code>。</li>
<li>如果给定分支是<code>split point</code>则不做任何处理。</li>
<li>无论是否发生冲突，<code>merge</code>结束后新建一个<code>Commit</code>。</li>
<li>如果当前分支是<code>split point</code>, 则<strong>切换</strong>到给定分支。</li>
<li>发生冲突且修改的内容不同只写当前分支的冲突文件。</li>
<li>需要复用<code>add</code>和<code>rm</code>以及<code>commit</code>命令。</li>
<li>git提交后的分布可以看作是个<code>direct graph</code>。</li>
<li>可以通过将从<code>init commit</code>到当前分支经过的commit放到一个list中，同时将要给定分支的路径也放到一个set中，再通过按指定顺序遍历(由当前分支开始)当前分支的list，使用<code>contains</code>方法来确定遍历经过的commit是否在分支路径的set中。需要使用BFS来遍历。</li>
<li>之前的策略是在切换分支(checkout, reset)时才将branches目录中的当前分支信息更新，这在这一步中获取当前分支对象是危险的，因此需要调整策略，在每一次commit更新HEAD目录时和reset时，都更新Branches中当前分支信息。这样就能保证当前分支在Head目录和Branches目录中的信息是同步一致的了。</li>
<li>注意Java中<code>null</code>在字符串比较时不能用<code>equals()</code>来比较。</li>
<li>别忘了改写冲突文件时需要生成新的<code>blobId</code>放入暂存区中在新的合并Commit中加入当前目录。</li>
</ul>
<h4 id="处理case"><strong>处理case</strong></h4>
<ul>
<li><img src="https://pic4.zhimg.com/80/v2-5b2470a6def367603e617ea9c709c231.png" title="fig:" alt="Image" /></li>
<li>想到了一个比较情况的好方法，将当前分支，给定分支以及split point三个集合中含有的文件名的并集放到集合里。比较时需要各个集合的BlobId和文件名的映射，以及BlobId和content的映射。</li>
<li>由两个值来区分所有情况分别是<code>isPresent</code>和<code>IsModified</code>。</li>
<li><code>Modifed</code>只需要通过当前分支分支或给定分支， 与<code>split point blobId</code>比较来区分就行了, 程序里我将不存在的文件的blobId赋值为空串。</li>
<li>当前分支和给定分支都modifed也就是case3还需要细分发生冲突，还是不发生冲突。直接通过比较当前分支和给定分支<code>commit Id</code>即可。</li>
<li><code>git pro</code>中的原话, 此时 Git 做了合并，但是没有自动地创建一个新的合并提交。 Git 会暂停下来，等待你去解决合并产生的冲突。 你可以在合并冲突后的任意时刻使用 git status 命令来查看那些因包含合并冲突而处于未合并（unmerged）状态的文件。这点与Gitlet还是不同的。</li>
<li>发生冲突的内容差异会自动写入冲突文件(按合理性来说只需要写入当前分支头即可)如, 需要解决冲突后，需要打印提示信息，合并的提交跟踪冲突文件: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD</span><br><span class="line">contents of file in current branch</span><br><span class="line">=======</span><br><span class="line">contents of file in given branch</span><br><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span><br></pre></td></tr></table></figure></li>
<li>处理好每个情况后将每个文件对应的result添加到暂存区等待新的Commit。result的内容为当前分支的内容也需要<code>stage for addition</code>, 但不需要放入<code>blobs</code>集合中。</li>
<li><code>getBytes</code>方法可以将字符串转化为字节数组(byte[])。</li>
</ul>
<figure>
<img src="https://pic4.zhimg.com/80/v2-de14f3c3a0f560d423afde1fdd05300b.png" alt="Image" /><figcaption aria-hidden="true">Image</figcaption>
</figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://mitmoksha.github.io/2022/05/16/CS61C-CPU-PROJECT/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Pishun Huang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Moksha's Blog">
      <meta itemprop="description" content="Opportunities are ready for it, the more to beat action.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Moksha's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/16/CS61C-CPU-PROJECT/" class="post-title-link" itemprop="url">CS61C CPU PROJECT</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-16 17:37:37" itemprop="dateCreated datePublished" datetime="2022-05-16T17:37:37+08:00">2022-05-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-05-18 09:15:29" itemprop="dateModified" datetime="2022-05-18T09:15:29+08:00">2022-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CS61C/" itemprop="url" rel="index"><span itemprop="name">CS61C</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <span id="more"></span>
<h1 id="cs61c-cpu-project"><strong>CS61C CPU PROJECT</strong></h1>
<h2 id="关于如何debug"><strong>关于如何Debug</strong></h2>
<p>相信前面的<code>lab5</code>和<code>lab6</code>已经奠定好了使用<code>logisim</code>的基础，前面相关内容同样奠定好了RISC-V ISA的知识基础。接下来Project中的一系列的task可以通过参考: - <code>61C Reference card</code> - <code>ROM</code>表 - 对应测试文件中的汇编代码和测试电路 - 通过<code>change value</code>来对电路中的bit位进行赋值，查看输入输出的值</p>
<p>需要将所有这些结合起来构建完整的<code>big picture</code>。</p>
<h2 id="alu"><strong>ALU</strong></h2>
<p>根据文档中给的功能类别通过门级电路来构造基本的ALU原件，个别功能的实现所用到的元器件还需要查看手册。 <img src="https://pic4.zhimg.com/80/v2-014bf51c0d29af49c1b904c3cb4a28e2.png" alt="ALU" /></p>
<h2 id="regfile"><strong>RegFile</strong></h2>
<p>需要用到<code>Multiplexer</code>和<code>Demultiplexer</code>，以及一些基本的逻辑，比较废鼠标... <img src="https://pic4.zhimg.com/80/v2-2bc53f743fb481fc3a22f8c141f95071.png" alt="Regfile" /></p>
<h2 id="immediate-generator"><strong>Immediate Generator</strong></h2>
<p>这一部分跟着61C绿卡里的指令编码表。以下显示的是所有含有imm部分的指令的实现。 <img src="https://pic4.zhimg.com/80/v2-f46d246882abfdf6f28e13266e41c363.png" alt="Imm-gen" /></p>
<h2 id="control-storeimplemented-by-rom"><strong>Control Store(Implemented by ROM)</strong></h2>
<p>通过分析绿卡上或者是文档里给的指令的功能，来初始化每条指令对应的微指令，需要结合数据通路中每个部分的实现以及PartA中我们已经构建好的ALU。Immsel以及个别控制信号可以自行设计(后面会有介绍修改<code>.csv</code>文件即可, 我这边是修改过后的)，建议PartB部分一开始就完善ROM表。 下面给出我的数据: <img src="https://pic4.zhimg.com/80/v2-3ffb5bc0653de42a33fba13bf38a868d.png" alt="ROM" /></p>
<p>完善ROM表后，将<code>ROM Output</code>复制到控制逻辑的ROM中。需要在控制逻辑电路中根据指令编码中的<code>opcode</code>, <code>fun3</code>, <code>fun7</code>字段来区分每个类型，甚至每条指令，再通过优先级别编码器来索引控存中的微指令, 产生对应的控制信号。 <img src="https://pic4.zhimg.com/80/v2-00828871fd39660bf6ddaf8a32ab38fa.png" alt="Control" /> <img src="https://pic4.zhimg.com/80/v2-ee25b2c060400847e6cf55d220704422.png" alt="Control" /> 因为优先级别编码器最多只能支持32bit, 但我们的指令有36条, 需拆拆分成两部分输入。剩下四条指令可以通过指令编码格式来各自区分，然后再找到指令编码格式中与前32条指令相异的bit作为控制信号来控制二选一MUX。<img src="https://pic4.zhimg.com/80/v2-4c10eb6557e75cdd3866bd188e5868ff.png" alt="Control" /></p>
<h2 id="branch-and-jump-instruction"><strong>Branch and Jump Instruction</strong></h2>
<p>通过<code>BrUn</code>信号来实现分支比较器产生对应<code>BrEq</code>和<code>BrLt</code>的控制信号决定分支是否发生跳转。 <img src="https://pic4.zhimg.com/80/v2-b4917e6611d7a6b8aa66d86f9d1362b5.png" alt="Branch Comp" /></p>
<p>B类指令和J类指令产生<code>PCsel</code>控制信号来决定是否修改<code>PC</code>, 同样也通过指令编码格式中的bit来区分jump发生还是branch发生 <img src="https://pic4.zhimg.com/80/v2-941f7fe17956fab75c7e74b1afa5fb17.png" alt="Control" /></p>
<h2 id="loading-and-storing"><strong>Loading and Storing</strong></h2>
<p>这部分需要细心一些，部分load和部分store无论是字节还是半字都要<strong>符号位拓展</strong>成字的大小。部分load相对部分store来说比较简单，因为部分load只需要考虑从存储器中读出来的数据位置不同即可，而部分store不仅需要将从寄存器中读来的数据分割，还需要将分割的数据存到对应存储器中字的偏移位置(这部分是由Mask来确定写入的位置的)。需要通过低两位来判断具体load的是当前字的哪一个部分。</p>
<h3 id="partial-load"><strong>Partial Load</strong></h3>
<p>如果不是取一个字的数据，则要根据当前指令lw来访问存储器的地址字段的低两位来产生控制信号，决定取当前数据字的哪一个部分的数据到寄存器中(通过splitter来划分)。由指令编码中的bit来作为控制信号区分，选择具体是<code>lw</code>还是<code>lh</code>, <code>lb</code>。 <img src="https://pic4.zhimg.com/80/v2-723ccb2b6671606fe4a6ac5b0cbf58c9.png" /></p>
<h3 id="partial-store"><strong>Partial Store</strong></h3>
<p>同样有指令编码格式来区分三种类型的store指令决定store到存储器中的数据。MemWriteMask有四个二进制bit组成，分别表示store到存储器中数据的位置, 实验中并未提到mask实现的细节。但是需要完成有指令编码和访问存储器的地址来生成mask。生成的mask需要通过指令编码格式中的bit和地址字段的低两位来区分, 额外在利用上优先级别编码器来索引。 生成的mask有<code>lb</code>的0001, 0010, 0100, 1000, 和<code>lh</code>的0011, 1100以及<code>lw</code>的1111, 七种组合。 <img src="https://pic4.zhimg.com/80/v2-1b3b6bfa9c35647d8b7df3225a1e2a6f.png" /></p>
<h2 id="datapath"><strong>Datapath</strong></h2>
<p>下面是流水过后的数据通路, 两级流水线挺好实现的，看了一下不需要考虑<code>Structure Hazards</code>以及<code>Data Hazards</code>，省去了很多数据通路上的麻烦。需要考虑的只有<code>Control Hazards</code>。当Branch或者Jump发生时，紧随其后进入流水线的只有一条指令，实验文档里解决的方案是插入一条NOP指令来防止冲突。什么时候插入NOP指令根据<code>PCsel</code>控制信号来决定即可。同时注意两个不同stage之间的差异(导致后面利用到PC的指令执行结果不正确)，需要通过在两个stage之间加流水线寄存器来存储一个时钟周期之内的信息(包括指令和PC值)。 <img src="https://pic4.zhimg.com/80/v2-55adeda8be6c453ab203579651619b65.png" alt="Datapath" /></p>
<h2 id="参考书目"><strong>参考书目</strong></h2>
<ul>
<li>Introduction to Computing Systems: From Bits &amp; Gates to C &amp; Beyond [3ed.]</li>
<li>P&amp;H [RISC-V 2ed.]</li>
<li>CAAQA [6ed.]</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://mitmoksha.github.io/2022/05/16/CSAPP-Lab2-Bomb-Lab/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Pishun Huang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Moksha's Blog">
      <meta itemprop="description" content="Opportunities are ready for it, the more to beat action.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Moksha's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/16/CSAPP-Lab2-Bomb-Lab/" class="post-title-link" itemprop="url">CSAPP Lab2: Bomb Lab</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-16 17:36:28" itemprop="dateCreated datePublished" datetime="2022-05-16T17:36:28+08:00">2022-05-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-05-18 09:15:48" itemprop="dateModified" datetime="2022-05-18T09:15:48+08:00">2022-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CMU15-213/" itemprop="url" rel="index"><span itemprop="name">CMU15-213</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <span id="more"></span>
<h1 id="csapp-lab2-bomb-lab">CSAPP Lab2: Bomb Lab</h1>
<h2 id="preparation"><strong>Preparation</strong></h2>
<p>建议在实验大致看一下lab相关的<a target="_blank" rel="noopener" href="http://www.cs.cmu.edu/afs/cs/academic/class/15213-f20/www/recitations/f20New/recitation02-bomblab.pdf">pdf</a>。使用<code>man</code>手册来查看库函数，<code>callq … &lt;_exit@plt&gt;</code>类型为C的库函数。注意商用的architecture是以字节为单位编址寻址。</p>
<p>参考CS61C所了解到的Tool, 做足了准备工作。安装<code>CGDB</code>, 相比较于<code>GDB</code>的<code>tui</code>在调试lab时显示不会出现乱码的情况。从<code>ubuntu</code>中<code>apt-get</code>下载到的版本较低，一些功能不适用。参考<a target="_blank" rel="noopener" href="https://cgdb.github.io/">CGDB官网</a>下载最新版本的<code>CGDB</code>, 简单浏览了一下<a target="_blank" rel="noopener" href="https://cgdb.github.io/docs/cgdb.pdf">CGDB官方手册</a>, 以及对应<code>CGDB</code>在<code>~/.cgdb/cgdbrc</code>文件中做了如下的配置足以满足调试需求: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">:set disasm</span><br><span class="line">:set hls</span><br><span class="line">:set syn=style</span><br></pre></td></tr></table></figure> 另外gdb相关内容再推荐这两本书籍 <code>Debugs Hacks</code>和<code>Debugging with GDB</code>。</p>
<p>需要用<code>chmod</code>命令修改一下<code>bomb</code>二进制文件的可执行权限</p>
<p>接下来可以愉快地开始<code>bomb lab</code>了~</p>
<p>运行<code>cgdb</code>且在对应phase打上断点后可以用一个放入输入信息的文本文件标准输入重定向到传递给主函数的参数中，这样就可以避免卡死在读取输入的systemcall上。更多关于<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/19467865/how-to-use-redirection-in-c-for-file-input">重定向</a> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb)run &lt; in</span><br></pre></td></tr></table></figure> ## <strong>Phase_1</strong> <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0000000000400ee0 &lt;phase_1&gt;:</span><br><span class="line">  400ee0:	<span class="number">48</span> <span class="number">83</span> ec <span class="number">08</span>          	<span class="keyword">sub</span>    <span class="number">$0</span>x8,%rsp                   # 开辟栈帧保存返回地址和写在文件中的字符串函数参数<span class="built_in">edi</span></span><br><span class="line">  400ee4:	be <span class="number">00</span> <span class="number">24</span> <span class="number">40</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>x402400,%esi</span><br><span class="line">  400ee9:	e8 4a <span class="number">04</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">401338</span> &lt;strings_not_equal&gt;  # <span class="built_in">edi</span>接着传给strings_not_equal</span><br><span class="line">  400eee:	<span class="number">85</span> c0                	<span class="keyword">test</span>   %eax,%eax                   # 若字符串相等，即函数返回<span class="number">0</span>，则Defuse炸弹</span><br><span class="line">  400ef0:	<span class="number">74</span> <span class="number">05</span>                	<span class="keyword">je</span>     400ef7 &lt;phase_1+<span class="number">0x17</span>&gt;</span><br><span class="line">  400ef2:	e8 <span class="number">43</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>       	callq  40143a &lt;explode_bomb&gt;</span><br><span class="line">  400ef7:	<span class="number">48</span> <span class="number">83</span> c4 <span class="number">08</span>          	<span class="keyword">add</span>    <span class="number">$0</span>x8,%rsp                   # 函数调用结束栈顶指针复原</span><br><span class="line">  400efb:	c3                   	retq </span><br></pre></td></tr></table></figure> 分析一下<code>strings_not_equal</code>，判断两个字符串是否相等。 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000000000401338</span> &lt;strings_not_equal&gt;:</span><br><span class="line">  <span class="number">401338</span>:	<span class="number">41</span> <span class="number">54</span>                	<span class="keyword">push</span>   %r12                             # callee save</span><br><span class="line">  40133a:	<span class="number">55</span>                   	<span class="keyword">push</span>   %rbp</span><br><span class="line">  40133b:	<span class="number">53</span>                   	<span class="keyword">push</span>   %rbx</span><br><span class="line">  40133c:	<span class="number">48</span> <span class="number">89</span> fb             	<span class="keyword">mov</span>    %rdi,%rbx                        # 将两个参数放入local中, 防止后续操作被覆盖</span><br><span class="line">  40133f:	<span class="number">48</span> <span class="number">89</span> f5             	<span class="keyword">mov</span>    %rsi,%rbp</span><br><span class="line">  <span class="number">401342</span>:	e8 d4 ff ff ff       	callq  40131b &lt;string_length&gt;           # 第一个参数<span class="built_in">rdi</span>传递给函数返回第一个字符串长度到<span class="built_in">eax</span>中</span><br><span class="line">  <span class="number">401347</span>:	<span class="number">41</span> <span class="number">89</span> c4             	<span class="keyword">mov</span>    %eax,%r12d</span><br><span class="line">  40134a:	<span class="number">48</span> <span class="number">89</span> ef             	<span class="keyword">mov</span>    %rbp,%rdi                        # 将当前函数的第二个参数传递给<span class="built_in">rdi</span></span><br><span class="line">  <span class="number">40134d</span>:	e8 c9 ff ff ff       	callq  40131b &lt;string_length&gt;           # 返回第二个字符串参数的长度</span><br><span class="line">  <span class="number">401352</span>:	ba <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>x1,%edx</span><br><span class="line">  <span class="number">401357</span>:	<span class="number">41</span> <span class="number">39</span> c4             	<span class="keyword">cmp</span>    %eax,%r12d                       # 两个参数的长度比较</span><br><span class="line">  40135a:	<span class="number">75</span> 3f                	<span class="keyword">jne</span>    40139b &lt;strings_not_equal+<span class="number">0x63</span>&gt;  # 字符串不相等则到转到restore并返回<span class="built_in">edx</span>中保存的<span class="number">1</span></span><br><span class="line">  40135c:	0f b6 <span class="number">03</span>             	movzbl (%rbx),%eax                      # 零拓展避免<span class="built_in">eax</span>高位出现杂乱数据, 字符为8bit，将其高位清<span class="number">0</span></span><br><span class="line">  40135f:	<span class="number">84</span> c0                	<span class="keyword">test</span>   %al,%al                          # 检测第一个参数是否遍历到terminator, 这种形式让<span class="built_in">al</span>与<span class="number">0</span>比较</span><br><span class="line">  <span class="number">401361</span>:	<span class="number">74</span> <span class="number">25</span>                	<span class="keyword">je</span>     <span class="number">401388</span> &lt;strings_not_equal+<span class="number">0x50</span>&gt;</span><br><span class="line">  <span class="number">401363</span>:	3a <span class="number">45</span> <span class="number">00</span>             	<span class="keyword">cmp</span>    <span class="number">0x0</span>(%rbp),%al</span><br><span class="line">  <span class="number">401366</span>:	<span class="number">74</span> 0a                	<span class="keyword">je</span>     <span class="number">401372</span> &lt;strings_not_equal+<span class="number">0x3a</span>&gt;</span><br><span class="line">  <span class="number">401368</span>:	eb <span class="number">25</span>                	<span class="keyword">jmp</span>    40138f &lt;strings_not_equal+<span class="number">0x57</span>&gt;</span><br><span class="line">  40136a:	3a <span class="number">45</span> <span class="number">00</span>             	<span class="keyword">cmp</span>    <span class="number">0x0</span>(%rbp),%al</span><br><span class="line">  <span class="number">40136d</span>:	0f 1f <span class="number">00</span>             	nopl   (%rax)</span><br><span class="line">  <span class="number">401370</span>:	<span class="number">75</span> <span class="number">24</span>                	<span class="keyword">jne</span>    <span class="number">401396</span> &lt;strings_not_equal+<span class="number">0x5e</span>&gt;</span><br><span class="line">  <span class="number">401372</span>:	<span class="number">48</span> <span class="number">83</span> c3 <span class="number">01</span>          	<span class="keyword">add</span>    <span class="number">$0</span>x1,%rbx                        # 移动读取两个字符串参数中的字符</span><br><span class="line">  <span class="number">401376</span>:	<span class="number">48</span> <span class="number">83</span> c5 <span class="number">01</span>          	<span class="keyword">add</span>    <span class="number">$0</span>x1,%rbp</span><br><span class="line">  40137a:	0f b6 <span class="number">03</span>             	movzbl (%rbx),%eax</span><br><span class="line">  <span class="number">40137d</span>:	<span class="number">84</span> c0                	<span class="keyword">test</span>   %al,%al                          # 检测第二个参数是否遍历到terminator</span><br><span class="line">  40137f:	<span class="number">75</span> e9                	<span class="keyword">jne</span>    40136a &lt;strings_not_equal+<span class="number">0x32</span>&gt;</span><br><span class="line">  <span class="number">401381</span>:	ba <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>x0,%edx                        # 两参数字符串相等，返回<span class="number">0</span></span><br><span class="line">  <span class="number">401386</span>:	eb <span class="number">13</span>                	<span class="keyword">jmp</span>    40139b &lt;strings_not_equal+<span class="number">0x63</span>&gt;</span><br><span class="line">  <span class="number">401388</span>:	ba <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>x0,%edx</span><br><span class="line">  <span class="number">40138d</span>:	eb 0c                	<span class="keyword">jmp</span>    40139b &lt;strings_not_equal+<span class="number">0x63</span>&gt;</span><br><span class="line">  40138f:	ba <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>x1,%edx</span><br><span class="line">  <span class="number">401394</span>:	eb <span class="number">05</span>                	<span class="keyword">jmp</span>    40139b &lt;strings_not_equal+<span class="number">0x63</span>&gt;</span><br><span class="line">  <span class="number">401396</span>:	ba <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>x1,%edx</span><br><span class="line">  40139b:	<span class="number">89</span> d0                	<span class="keyword">mov</span>    %edx,%eax                        # <span class="built_in">eax</span>作为返回值</span><br><span class="line">  <span class="number">40139d</span>:	5b                   	<span class="keyword">pop</span>    %rbx                             # restore</span><br><span class="line">  40139e:	<span class="number">5d</span>                   	<span class="keyword">pop</span>    %rbp</span><br><span class="line">  40139f:	<span class="number">41</span> 5c                	<span class="keyword">pop</span>    %r12</span><br><span class="line">  4013a1:	c3                   	retq </span><br></pre></td></tr></table></figure> 观察<code>phase_1</code>函数，需要进入函数<code>string_not_equal</code>，并通过该函数的返回结果来决定是否引爆炸弹。进入该函数后，可以发现在函数中比较的是<code>rdi</code>和<code>rsi</code>两个字符串参数。<code>rdi</code>是标准输入中输入的字符串。<code>string_length</code>的返回值保存在寄存器<code>eax</code>中为两字符串的长度。长度不相等即表示字符串肯定不相等，则返回寄存器<code>edx</code>中的1。初步可以判断<code>phase_1</code>要求比较的两个字符串要相等才能<code>defuse</code>。再仔细观察<code>phase_1</code>函数中<code>test %eax, %eax</code>测试寄存器<code>eax</code><strong>非0</strong>则跳转到<code>bomb</code>。因此要想不爆炸必须得保证存在于<code>($rdi)</code>, <code>($rsi)</code>中的两个字符串相等，即<code>strings_not_equal</code>的返回值为<strong>0</strong>。</p>
<p>用<code>x/s</code>查看对应<code>memory</code>中地址单元的的字符串内容, 使标准输入参数<code>rdi</code>等于下述字符串即可<code>defuse</code>。 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/s 0x402400</span><br><span class="line">0x402400:       &quot;Border relations with Canada have never been better.&quot;</span><br></pre></td></tr></table></figure> 经分析答案为: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Border relations with Canada have never been better.</span><br></pre></td></tr></table></figure></p>
<h2 id="phase_2"><strong>Phase_2</strong></h2>
<p><code>x86</code>ISA规定，当参数超过6个的时候就会使用栈来保存参数。<code>print (char*) 0x4025c3</code>打印由地址0x4025c3起始的字符串，显示的结果可以发现字符串为<code>"%d %d %d %d %d %d"</code>格式串。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">0000000000400efc &lt;phase_2&gt;:</span><br><span class="line">  400efc:	<span class="number">55</span>                   	<span class="keyword">push</span>   %rbp                       # callee save</span><br><span class="line">  400efd:	<span class="number">53</span>                   	<span class="keyword">push</span>   %rbx</span><br><span class="line">  400efe:	<span class="number">48</span> <span class="number">83</span> ec <span class="number">28</span>          	<span class="keyword">sub</span>    <span class="number">$0</span>x28,%rsp                 # <span class="built_in">rdi</span>为标准输入字符串的地址</span><br><span class="line">  400f02:	<span class="number">48</span> <span class="number">89</span> e6             	<span class="keyword">mov</span>    %rsp,%rsi                  # <span class="built_in">rsp</span>作为函数read_six_numbers的第二个参数, caller save</span><br><span class="line">  400f05:	e8 <span class="number">52</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>       	callq  40145c &lt;read_six_numbers&gt;  # 函数读取六个数字到栈空间上。</span><br><span class="line">  400f0a:	<span class="number">83</span> 3c <span class="number">24</span> <span class="number">01</span>          	cmpl   <span class="number">$0</span>x1,(%rsp)                # 取第一个数字</span><br><span class="line">  400f0e:	<span class="number">74</span> <span class="number">20</span>                	<span class="keyword">je</span>     400f30 &lt;phase_2+<span class="number">0x34</span>&gt;</span><br><span class="line">  400f10:	e8 <span class="number">25</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>       	callq  40143a &lt;explode_bomb&gt;</span><br><span class="line">  400f15:	eb <span class="number">19</span>                	<span class="keyword">jmp</span>    400f30 &lt;phase_2+<span class="number">0x34</span>&gt;</span><br><span class="line">  400f17:	8b <span class="number">43</span> fc             	<span class="keyword">mov</span>    -<span class="number">0x4</span>(%rbx),%eax           # 取接下来的数字</span><br><span class="line">  400f1a:	<span class="number">01</span> c0                	<span class="keyword">add</span>    %eax,%eax                 # double</span><br><span class="line">  400f1c:	<span class="number">39</span> <span class="number">03</span>                	<span class="keyword">cmp</span>    %eax,(%rbx)</span><br><span class="line">  400f1e:	<span class="number">74</span> <span class="number">05</span>                	<span class="keyword">je</span>     400f25 &lt;phase_2+<span class="number">0x29</span>&gt;     # 下一个参数的值需要为上一个参数值的两倍才能确保不发生爆炸</span><br><span class="line">  400f20:	e8 <span class="number">15</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>       	callq  40143a &lt;explode_bomb&gt;</span><br><span class="line">  400f25:	<span class="number">48</span> <span class="number">83</span> c3 <span class="number">04</span>          	<span class="keyword">add</span>    <span class="number">$0</span>x4,%rbx</span><br><span class="line">  400f29:	<span class="number">48</span> <span class="number">39</span> eb             	<span class="keyword">cmp</span>    %rbp,%rbx                 # 若读到第六个数字，则将局部变量所使用的寄存器restore到原来的值, <span class="keyword">pop</span>栈指针复原到调用前的位置, 否则继续<span class="keyword">loop</span></span><br><span class="line">  400f2c:	<span class="number">75</span> e9                	<span class="keyword">jne</span>    400f17 &lt;phase_2+<span class="number">0x1b</span>&gt;</span><br><span class="line">  400f2e:	eb 0c                	<span class="keyword">jmp</span>    400f3c &lt;phase_2+<span class="number">0x40</span>&gt;</span><br><span class="line">  400f30:	<span class="number">48</span> <span class="number">8d</span> 5c <span class="number">24</span> <span class="number">04</span>       	<span class="keyword">lea</span>    <span class="number">0x4</span>(%rsp),%rbx</span><br><span class="line">  400f35:	<span class="number">48</span> <span class="number">8d</span> 6c <span class="number">24</span> <span class="number">18</span>       	<span class="keyword">lea</span>    <span class="number">0x18</span>(%rsp),%rbp           # <span class="built_in">rsp</span>~<span class="built_in">rsp</span>-<span class="number">0x10</span>这部分为函数的返回地址和局部变量以及所用的栈空间</span><br><span class="line">  400f3a:	eb <span class="built_in">db</span>                	<span class="keyword">jmp</span>    400f17 &lt;phase_2+<span class="number">0x1b</span>&gt;</span><br><span class="line">  400f3c:	<span class="number">48</span> <span class="number">83</span> c4 <span class="number">28</span>          	<span class="keyword">add</span>    <span class="number">$0</span>x28,%rsp</span><br><span class="line">  400f40:	5b                   	<span class="keyword">pop</span>    %rbx</span><br><span class="line">  400f41:	<span class="number">5d</span>                   	<span class="keyword">pop</span>    %rbp</span><br><span class="line">  400f42:	c3                   	retq   </span><br></pre></td></tr></table></figure>
<p><code>read_six_numbers</code>中会调用C库函数<code>sscanf</code>，<code>man</code>手册中返回值的描述，返回输入数字匹配的个数。 &gt; On success, these functions return the number of input items success‐ fully matched and assigned; this can be fewer than provided for, or even zero, in the event of an early matching failure.</p>
<p>注意<code>x86</code>栈帧由低地址到高地址，先是返回地址，再到局部变量，再到save register。第1个参数在栈帧低地址 立即数为<code>32bit</code>, 按字节变址寻址, 函数参数为<code>caller save</code>。 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">000000000040145c &lt;read_six_numbers&gt;:</span><br><span class="line">  40145c:	<span class="number">48</span> <span class="number">83</span> ec <span class="number">18</span>          	<span class="keyword">sub</span>    <span class="number">$0</span>x18,%rsp                    # 开辟栈帧, <span class="built_in">rdi</span>为第一个参数</span><br><span class="line">  <span class="number">401460</span>:	<span class="number">48</span> <span class="number">89</span> f2             	<span class="keyword">mov</span>    %rsi,%rdx                     # 第<span class="number">3</span>个参数</span><br><span class="line">  <span class="number">401463</span>:	<span class="number">48</span> <span class="number">8d</span> 4e <span class="number">04</span>          	<span class="keyword">lea</span>    <span class="number">0x4</span>(%rsi),%rcx                # 第<span class="number">4</span>个参数</span><br><span class="line">  <span class="number">401467</span>:	<span class="number">48</span> <span class="number">8d</span> <span class="number">46</span> <span class="number">14</span>          	<span class="keyword">lea</span>    <span class="number">0x14</span>(%rsi),%rax               # 第<span class="number">8</span>个参数</span><br><span class="line">  40146b:	<span class="number">48</span> <span class="number">89</span> <span class="number">44</span> <span class="number">24</span> <span class="number">08</span>       	<span class="keyword">mov</span>    %rax,<span class="number">0x8</span>(%rsp)</span><br><span class="line">  <span class="number">401470</span>:	<span class="number">48</span> <span class="number">8d</span> <span class="number">46</span> <span class="number">10</span>          	<span class="keyword">lea</span>    <span class="number">0x10</span>(%rsi),%rax               # 第<span class="number">7</span>个参数</span><br><span class="line">  <span class="number">401474</span>:	<span class="number">48</span> <span class="number">89</span> <span class="number">04</span> <span class="number">24</span>          	<span class="keyword">mov</span>    %rax,(%rsp)</span><br><span class="line">  <span class="number">401478</span>:	4c <span class="number">8d</span> 4e 0c          	<span class="keyword">lea</span>    <span class="number">0xc</span>(%rsi),%r9                 # 第<span class="number">6</span>个参数</span><br><span class="line">  40147c:	4c <span class="number">8d</span> <span class="number">46</span> <span class="number">08</span>          	<span class="keyword">lea</span>    <span class="number">0x8</span>(%rsi),%r8                 # 第<span class="number">5</span>个参数</span><br><span class="line">  <span class="number">401480</span>:	be c3 <span class="number">25</span> <span class="number">40</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>x4025c3,%esi                # 第<span class="number">2</span>个参数，格式串</span><br><span class="line">  <span class="number">401485</span>:	b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>x0,%eax                     # 初始化返回值</span><br><span class="line">  40148a:	e8 <span class="number">61</span> f7 ff ff       	callq  400bf0 &lt;__isoc99_sscanf@plt&gt;</span><br><span class="line">  40148f:	<span class="number">83</span> f8 <span class="number">05</span>             	<span class="keyword">cmp</span>    <span class="number">$0</span>x5,%eax                     # 要求输入数字要大于<span class="number">5</span>个才不会引爆炸弹</span><br><span class="line">  <span class="number">401492</span>:	7f <span class="number">05</span>                	<span class="keyword">jg</span>     <span class="number">401499</span> &lt;read_six_numbers+<span class="number">0x3d</span>&gt;</span><br><span class="line">  <span class="number">401494</span>:	e8 a1 ff ff ff       	callq  40143a &lt;explode_bomb&gt;</span><br><span class="line">  <span class="number">401499</span>:	<span class="number">48</span> <span class="number">83</span> c4 <span class="number">18</span>          	<span class="keyword">add</span>    <span class="number">$0</span>x18,%rsp</span><br><span class="line">  <span class="number">40149d</span>:	c3                   	retq  </span><br></pre></td></tr></table></figure> 查看<code>0x4025c3</code>地址单元中的内容为格式串 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/s 0x4025c3</span><br><span class="line">0x4025c3:       &quot;%d %d %d %d %d %d&quot;</span><br></pre></td></tr></table></figure> 经分析答案为: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 2 4 8 16 32</span><br></pre></td></tr></table></figure></p>
<h2 id="phase_3"><strong>Phase_3</strong></h2>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">0000000000400f43 &lt;phase_3&gt;:</span><br><span class="line">  400f43:	<span class="number">48</span> <span class="number">83</span> ec <span class="number">18</span>          	<span class="keyword">sub</span>    <span class="number">$0</span>x18,%rsp</span><br><span class="line">  400f47:	<span class="number">48</span> <span class="number">8d</span> 4c <span class="number">24</span> 0c       	<span class="keyword">lea</span>    <span class="number">0xc</span>(%rsp),%rcx</span><br><span class="line">  400f4c:	<span class="number">48</span> <span class="number">8d</span> <span class="number">54</span> <span class="number">24</span> <span class="number">08</span>       	<span class="keyword">lea</span>    <span class="number">0x8</span>(%rsp),%rdx</span><br><span class="line">  400f51:	be cf <span class="number">25</span> <span class="number">40</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>x4025cf,%esi         # <span class="string">&quot;%d %d&quot;</span>需要两个无符号十进制数, 少于<span class="number">2</span>个会引爆炸弹</span><br><span class="line">  400f56:	b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>x0,%eax</span><br><span class="line">  400f5b:	e8 <span class="number">90</span> fc ff ff       	callq  400bf0 &lt;__isoc99_sscanf@plt&gt;</span><br><span class="line">  400f60:	<span class="number">83</span> f8 <span class="number">01</span>             	<span class="keyword">cmp</span>    <span class="number">$0</span>x1,%eax</span><br><span class="line">  400f63:	7f <span class="number">05</span>                	<span class="keyword">jg</span>     400f6a &lt;phase_3+<span class="number">0x27</span>&gt;</span><br><span class="line">  400f65:	e8 d0 <span class="number">04</span> <span class="number">00</span> <span class="number">00</span>       	callq  40143a &lt;explode_bomb&gt;</span><br><span class="line">  400f6a:	<span class="number">83</span> 7c <span class="number">24</span> <span class="number">08</span> <span class="number">07</span>       	cmpl   <span class="number">$0</span>x7,<span class="number">0x8</span>(%rsp)         # 第一个标准输入中的参数大于<span class="number">7</span>则会跳转发生爆炸</span><br><span class="line">  400f6f:	<span class="number">77</span> 3c                	<span class="keyword">ja</span>     400fad &lt;phase_3+<span class="number">0x6a</span>&gt;</span><br><span class="line">  400f71:	8b <span class="number">44</span> <span class="number">24</span> <span class="number">08</span>          	<span class="keyword">mov</span>    <span class="number">0x8</span>(%rsp),%eax</span><br><span class="line">  400f75:	ff <span class="number">24</span> c5 <span class="number">70</span> <span class="number">24</span> <span class="number">40</span> <span class="number">00</span> 	jmpq   *<span class="number">0x402470</span>(,%rax,<span class="number">8</span>)     # indirect jump, 跳转到<span class="number">0x402470</span>+<span class="built_in">rax</span>*<span class="number">8</span>的存储单元中存放的地址即<span class="number">0x400f83</span></span><br><span class="line">  400f7c:	b8 cf <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>xcf,%eax</span><br><span class="line">  400f81:	eb 3b                	<span class="keyword">jmp</span>    400fbe &lt;phase_3+<span class="number">0x7b</span>&gt;</span><br><span class="line">  400f83:	b8 c3 <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>x2c3,%eax</span><br><span class="line">  400f88:	eb <span class="number">34</span>                	<span class="keyword">jmp</span>    400fbe &lt;phase_3+<span class="number">0x7b</span>&gt;</span><br><span class="line">  400f8a:	b8 <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>x100,%eax</span><br><span class="line">  400f8f:	eb <span class="number">2d</span>                	<span class="keyword">jmp</span>    400fbe &lt;phase_3+<span class="number">0x7b</span>&gt;</span><br><span class="line">  400f91:	b8 <span class="number">85</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>x185,%eax</span><br><span class="line">  400f96:	eb <span class="number">26</span>                	<span class="keyword">jmp</span>    400fbe &lt;phase_3+<span class="number">0x7b</span>&gt;</span><br><span class="line">  400f98:	b8 ce <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>xce,%eax</span><br><span class="line">  400f9d:	eb 1f                	<span class="keyword">jmp</span>    400fbe &lt;phase_3+<span class="number">0x7b</span>&gt;</span><br><span class="line">  400f9f:	b8 aa <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>x2aa,%eax</span><br><span class="line">  400fa4:	eb <span class="number">18</span>                	<span class="keyword">jmp</span>    400fbe &lt;phase_3+<span class="number">0x7b</span>&gt;</span><br><span class="line">  400fa6:	b8 <span class="number">47</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>x147,%eax</span><br><span class="line">  400fab:	eb <span class="number">11</span>                	<span class="keyword">jmp</span>    400fbe &lt;phase_3+<span class="number">0x7b</span>&gt;</span><br><span class="line">  400fad:	e8 <span class="number">88</span> <span class="number">04</span> <span class="number">00</span> <span class="number">00</span>       	callq  40143a &lt;explode_bomb&gt;</span><br><span class="line">  400fb2:	b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>x0,%eax</span><br><span class="line">  400fb7:	eb <span class="number">05</span>                	<span class="keyword">jmp</span>    400fbe &lt;phase_3+<span class="number">0x7b</span>&gt;</span><br><span class="line">  400fb9:	b8 <span class="number">37</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>x137,%eax</span><br><span class="line">  400fbe:	3b <span class="number">44</span> <span class="number">24</span> 0c          	<span class="keyword">cmp</span>    <span class="number">0xc</span>(%rsp),%eax         # 第二个参数和覆写后的<span class="built_in">eax</span>相等才能跳过bomb</span><br><span class="line">  400fc2:	<span class="number">74</span> <span class="number">05</span>                	<span class="keyword">je</span>     400fc9 &lt;phase_3+<span class="number">0x86</span>&gt;</span><br><span class="line">  400fc4:	e8 <span class="number">71</span> <span class="number">04</span> <span class="number">00</span> <span class="number">00</span>       	callq  40143a &lt;explode_bomb&gt;</span><br><span class="line">  400fc9:	<span class="number">48</span> <span class="number">83</span> c4 <span class="number">18</span>          	<span class="keyword">add</span>    <span class="number">$0</span>x18,%rsp</span><br><span class="line">  400fcd:	c3                   	retq   </span><br></pre></td></tr></table></figure>
<p><code>jmp *Operand</code>为Indirect Jump, 跳转的target存放在寄存器中或者内存中。查看内存中存放的target: <img src="https://pic4.zhimg.com/80/v2-bd761cefa9fec00f19cf892677e0e12d.png" alt="Image" /> 再结合上面的汇编代码，可以得出8个答案: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">0 207</span><br><span class="line">1 311</span><br><span class="line">2 707</span><br><span class="line">3 256</span><br><span class="line">4 389</span><br><span class="line">5 206</span><br><span class="line">6 682</span><br><span class="line">7 327</span><br></pre></td></tr></table></figure> ## <strong>Phase_4</strong> <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">000000000040100c &lt;phase_4&gt;:</span><br><span class="line">  40100c:	<span class="number">48</span> <span class="number">83</span> ec <span class="number">18</span>          	<span class="keyword">sub</span>    <span class="number">$0</span>x18,%rsp</span><br><span class="line">  <span class="number">401010</span>:	<span class="number">48</span> <span class="number">8d</span> 4c <span class="number">24</span> 0c       	<span class="keyword">lea</span>    <span class="number">0xc</span>(%rsp),%rcx  # callee save</span><br><span class="line">  <span class="number">401015</span>:	<span class="number">48</span> <span class="number">8d</span> <span class="number">54</span> <span class="number">24</span> <span class="number">08</span>       	<span class="keyword">lea</span>    <span class="number">0x8</span>(%rsp),%rdx  # callee save</span><br><span class="line">  40101a:	be cf <span class="number">25</span> <span class="number">40</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>x4025cf,%esi  # 格式串, 需要两个十进制数, 因此可以断定标准输入为两个数</span><br><span class="line">  40101f:	b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>x0,%eax</span><br><span class="line">  <span class="number">401024</span>:	e8 c7 fb ff ff       	callq  400bf0 &lt;__isoc99_sscanf@plt&gt;</span><br><span class="line">  <span class="number">401029</span>:	<span class="number">83</span> f8 <span class="number">02</span>             	<span class="keyword">cmp</span>    <span class="number">$0</span>x2,%eax             # 需要在标准输入中传递两个参数(sscanf系统调用的返回值)，否则会引爆炸弹</span><br><span class="line">  40102c:	<span class="number">75</span> <span class="number">07</span>                	<span class="keyword">jne</span>    <span class="number">401035</span> &lt;phase_4+<span class="number">0x29</span>&gt;</span><br><span class="line">  40102e:	<span class="number">83</span> 7c <span class="number">24</span> <span class="number">08</span> 0e       	cmpl   <span class="number">$0</span>xe,<span class="number">0x8</span>(%rsp)        # 第一个参数若大于<span class="number">14</span>，则bomb</span><br><span class="line">  <span class="number">401033</span>:	<span class="number">76</span> <span class="number">05</span>                	<span class="keyword">jbe</span>    40103a &lt;phase_4+<span class="number">0x2e</span>&gt;</span><br><span class="line">  <span class="number">401035</span>:	e8 <span class="number">00</span> <span class="number">04</span> <span class="number">00</span> <span class="number">00</span>       	callq  40143a &lt;explode_bomb&gt;</span><br><span class="line">  40103a:	ba 0e <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>xe,%edx             # <span class="number">14</span>作为func4的第三个参数</span><br><span class="line">  40103f:	be <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>x0,%esi             # <span class="number">0</span>作为func4的第二个参数</span><br><span class="line">  <span class="number">401044</span>:	8b 7c <span class="number">24</span> <span class="number">08</span>          	<span class="keyword">mov</span>    <span class="number">0x8</span>(%rsp),%edi        # phase_4的第一个参数作为func4的第一个参数</span><br><span class="line">  <span class="number">401048</span>:	e8 <span class="number">81</span> ff ff ff       	callq  400fce &lt;func4&gt;</span><br><span class="line">  <span class="number">40104d</span>:	<span class="number">85</span> c0                	<span class="keyword">test</span>   %eax,%eax             # 若返回值<span class="built_in">eax</span>不为<span class="number">0</span>则bomb</span><br><span class="line">  40104f:	<span class="number">75</span> <span class="number">07</span>                	<span class="keyword">jne</span>    <span class="number">401058</span> &lt;phase_4+<span class="number">0x4c</span>&gt;</span><br><span class="line">  <span class="number">401051</span>:	<span class="number">83</span> 7c <span class="number">24</span> 0c <span class="number">00</span>       	cmpl   <span class="number">$0</span>x0,<span class="number">0xc</span>(%rsp)        # 若第二个标准输入参数不为<span class="number">0</span>则bomb, 因此可以确定第二个标准输入参数必须为<span class="number">0</span></span><br><span class="line">  <span class="number">401056</span>:	<span class="number">74</span> <span class="number">05</span>                	<span class="keyword">je</span>     <span class="number">40105d</span> &lt;phase_4+<span class="number">0x51</span>&gt;</span><br><span class="line">  <span class="number">401058</span>:	e8 <span class="built_in">dd</span> <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>       	callq  40143a &lt;explode_bomb&gt;</span><br><span class="line">  <span class="number">40105d</span>:	<span class="number">48</span> <span class="number">83</span> c4 <span class="number">18</span>          	<span class="keyword">add</span>    <span class="number">$0</span>x18,%rsp</span><br><span class="line">  <span class="number">401061</span>:	c3                   	retq   </span><br></pre></td></tr></table></figure> <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">0000000000400fce &lt;func4&gt;:</span><br><span class="line">  400fce:	<span class="number">48</span> <span class="number">83</span> ec <span class="number">08</span>          	<span class="keyword">sub</span>    <span class="number">$0</span>x8,%rsp              # stack frame</span><br><span class="line">  400fd2:	<span class="number">89</span> d0                	<span class="keyword">mov</span>    %edx,%eax</span><br><span class="line">  400fd4:	<span class="number">29</span> f0                	<span class="keyword">sub</span>    %esi,%eax</span><br><span class="line">  400fd6:	<span class="number">89</span> c1                	<span class="keyword">mov</span>    %eax,%ecx</span><br><span class="line">  400fd8:	c1 e9 1f             	<span class="keyword">shr</span>    <span class="number">$0</span>x1f,%ecx             # 取符号位</span><br><span class="line">  400fdb:	<span class="number">01</span> c8                	<span class="keyword">add</span>    %ecx,%eax</span><br><span class="line">  400fdd:	d1 f8                	<span class="keyword">sar</span>    %eax                   # <span class="built_in">eax</span>  除以<span class="number">2</span>向下取整, 最后的答案与之相关</span><br><span class="line">  400fdf:	<span class="number">8d</span> 0c <span class="number">30</span>             	<span class="keyword">lea</span>    (%rax,%rsi,<span class="number">1</span>),%ecx</span><br><span class="line">  400fe2:	<span class="number">39</span> f9                	<span class="keyword">cmp</span>    %edi,%ecx              # 直到<span class="built_in">ecx</span>小于等于第一个标准输入的参数<span class="built_in">edi</span>, 则跳转到<span class="number">0x400ff2</span></span><br><span class="line">  400fe4:	7e 0c                	<span class="keyword">jle</span>    400ff2 &lt;func4+<span class="number">0x24</span>&gt;</span><br><span class="line">  400fe6:	<span class="number">8d</span> <span class="number">51</span> ff             	<span class="keyword">lea</span>    -<span class="number">0x1</span>(%rcx),%edx</span><br><span class="line">  400fe9:	e8 e0 ff ff ff       	callq  400fce &lt;func4&gt;</span><br><span class="line">  400fee:	<span class="number">01</span> c0                	<span class="keyword">add</span>    %eax,%eax</span><br><span class="line">  400ff0:	eb <span class="number">15</span>                	<span class="keyword">jmp</span>    <span class="number">401007</span> &lt;func4+<span class="number">0x39</span>&gt;</span><br><span class="line">  400ff2:	b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>x0,%eax              # 此处很关键，要保证不bomb必须返回<span class="number">0</span></span><br><span class="line">  400ff7:	<span class="number">39</span> f9                	<span class="keyword">cmp</span>    %edi,%ecx  </span><br><span class="line">  400ff9:	<span class="number">7d</span> 0c                	<span class="keyword">jge</span>    <span class="number">401007</span> &lt;func4+<span class="number">0x39</span>&gt;    # 跳转到此处之后，要想此处跳转，条件必须是<span class="built_in">ecx</span>==<span class="built_in">edi</span></span><br><span class="line">  400ffb:	<span class="number">8d</span> <span class="number">71</span> <span class="number">01</span>             	<span class="keyword">lea</span>    <span class="number">0x1</span>(%rcx),%esi</span><br><span class="line">  400ffe:	e8 cb ff ff ff       	callq  400fce &lt;func4&gt;</span><br><span class="line">  <span class="number">401003</span>:	<span class="number">8d</span> <span class="number">44</span> <span class="number">00</span> <span class="number">01</span>          	<span class="keyword">lea</span>    <span class="number">0x1</span>(%rax,%rax,<span class="number">1</span>),%eax  # 执行到这一步无论<span class="built_in">rax</span>的值为什么都不可能为<span class="number">0</span></span><br><span class="line">  <span class="number">401007</span>:	<span class="number">48</span> <span class="number">83</span> c4 <span class="number">08</span>          	<span class="keyword">add</span>    <span class="number">$0</span>x8,%rsp</span><br><span class="line">  40100b:	c3                   	retq   </span><br></pre></td></tr></table></figure> 经过调试分析, 可得出四个答案, 除此之外可能还有其他答案就不另行分析了： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">7 0</span><br><span class="line">3 0</span><br><span class="line">1 0</span><br><span class="line">0 0</span><br></pre></td></tr></table></figure> ## <strong>Phase_5</strong> ASCII转化为十六进制时(因为所取数字的下标大于10)需要查看ASCII编码表。关于stack canary的解释可以参考<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/10325713/why-does-this-memory-address-fs0x28-fs0x28-have-a-random-value/10325915#10325915">文章</a>和<a target="_blank" rel="noopener" href="https://qastack.cn/unix/453749/what-sets-fs0x28-stack-canary">文章</a>使用rax寄存器作为间接传递的原因是因为x86中不存在内存到内存的mov指令。 <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000000000401062</span> &lt;phase_5&gt;:</span><br><span class="line">  <span class="number">401062</span>:	<span class="number">53</span>                   	<span class="keyword">push</span>   %rbx                     # callee save</span><br><span class="line">  <span class="number">401063</span>:	<span class="number">48</span> <span class="number">83</span> ec <span class="number">20</span>          	<span class="keyword">sub</span>    <span class="number">$0</span>x20,%rsp</span><br><span class="line">  <span class="number">401067</span>:	<span class="number">48</span> <span class="number">89</span> fb             	<span class="keyword">mov</span>    %rdi,%rbx                # 标准输入字符串参数</span><br><span class="line">  40106a:	<span class="number">64</span> <span class="number">48</span> 8b <span class="number">04</span> <span class="number">25</span> <span class="number">28</span> <span class="number">00</span> 	<span class="keyword">mov</span>    %fs:<span class="number">0x28</span>,%rax            # stack-canary</span><br><span class="line">  <span class="number">401071</span>:	<span class="number">00</span> <span class="number">00</span> </span><br><span class="line">  <span class="number">401073</span>:	<span class="number">48</span> <span class="number">89</span> <span class="number">44</span> <span class="number">24</span> <span class="number">18</span>       	<span class="keyword">mov</span>    %rax,<span class="number">0x18</span>(%rsp)</span><br><span class="line">  <span class="number">401078</span>:	<span class="number">31</span> c0                	<span class="keyword">xor</span>    %eax,%eax                # 对<span class="built_in">eax</span>清<span class="number">0</span></span><br><span class="line">  40107a:	e8 9c <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>       	callq  40131b &lt;string_length&gt;   # <span class="built_in">rdi</span>作为参数, 返回<span class="built_in">rdi</span>字符串的长度</span><br><span class="line">  40107f:	<span class="number">83</span> f8 <span class="number">06</span>             	<span class="keyword">cmp</span>    <span class="number">$0</span>x6,%eax                # 如果标准输入的字符串不为<span class="number">6</span>个字符，则bomb</span><br><span class="line">  <span class="number">401082</span>:	<span class="number">74</span> 4e                	<span class="keyword">je</span>     4010d2 &lt;phase_5+<span class="number">0x70</span>&gt;</span><br><span class="line">  <span class="number">401084</span>:	e8 b1 <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>       	callq  40143a &lt;explode_bomb&gt;</span><br><span class="line">  <span class="number">401089</span>:	eb <span class="number">47</span>                	<span class="keyword">jmp</span>    4010d2 &lt;phase_5+<span class="number">0x70</span>&gt;</span><br><span class="line">  40108b:	0f b6 0c <span class="number">03</span>          	movzbl (%rbx,%rax,<span class="number">1</span>),%ecx       # 取字符</span><br><span class="line">  40108f:	<span class="number">88</span> 0c <span class="number">24</span>             	<span class="keyword">mov</span>    %cl,(%rsp)               # 取最低字节大小的字符</span><br><span class="line">  <span class="number">401092</span>:	<span class="number">48</span> 8b <span class="number">14</span> <span class="number">24</span>          	<span class="keyword">mov</span>    (%rsp),%rdx</span><br><span class="line">  <span class="number">401096</span>:	<span class="number">83</span> e2 0f             	<span class="keyword">and</span>    <span class="number">$0</span>xf,%edx                # 将ASCII转化为对应的十六进制数作为索引</span><br><span class="line">  <span class="number">401099</span>:	0f b6 <span class="number">92</span> b0 <span class="number">24</span> <span class="number">40</span> <span class="number">00</span> 	movzbl <span class="number">0x4024b0</span>(%rdx),%edx      # <span class="number">0x4024b0</span>中存放了一串字符, 通过分析可以发现<span class="built_in">rdx</span>作为取字符串字符的索引</span><br><span class="line">  4010a0:	<span class="number">88</span> <span class="number">54</span> <span class="number">04</span> <span class="number">10</span>          	<span class="keyword">mov</span>    %dl,<span class="number">0x10</span>(%rsp,%rax,<span class="number">1</span>)    # 将取到的字符存入由<span class="built_in">rsp</span>+<span class="number">0x10</span>处的开始向高地址方向增长</span><br><span class="line">  4010a4:	<span class="number">48</span> <span class="number">83</span> c0 <span class="number">01</span>          	<span class="keyword">add</span>    <span class="number">$0</span>x1,%rax                # 减少迭代次数</span><br><span class="line">  4010a8:	<span class="number">48</span> <span class="number">83</span> f8 <span class="number">06</span>          	<span class="keyword">cmp</span>    <span class="number">$0</span>x6,%rax                # 迭代<span class="number">6</span>次</span><br><span class="line">  4010ac:	<span class="number">75</span> <span class="built_in">dd</span>                	<span class="keyword">jne</span>    40108b &lt;phase_5+<span class="number">0x29</span>&gt;</span><br><span class="line">  4010ae:	c6 <span class="number">44</span> <span class="number">24</span> <span class="number">16</span> <span class="number">00</span>       	movb   <span class="number">$0</span>x0,<span class="number">0x16</span>(%rsp)          # 在字符串后添加termimator, 作为字符串比较结束的标志</span><br><span class="line">  4010b3:	be 5e <span class="number">24</span> <span class="number">40</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>x40245e,%esi           # <span class="string">&quot;flyers&quot;</span></span><br><span class="line">  4010b8:	<span class="number">48</span> <span class="number">8d</span> 7c <span class="number">24</span> <span class="number">10</span>       	<span class="keyword">lea</span>    <span class="number">0x10</span>(%rsp),%rdi</span><br><span class="line">  4010bd:	e8 <span class="number">76</span> <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">401338</span> &lt;strings_not_equal&gt;    # 比较存放在<span class="number">0x40245e</span>中的字符串和标准输入转化后的字符串</span><br><span class="line">  4010c2:	<span class="number">85</span> c0                	<span class="keyword">test</span>   %eax,%eax</span><br><span class="line">  4010c4:	<span class="number">74</span> <span class="number">13</span>                	<span class="keyword">je</span>     4010d9 &lt;phase_5+<span class="number">0x77</span>&gt;</span><br><span class="line">  4010c6:	e8 6f <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>       	callq  40143a &lt;explode_bomb&gt;</span><br><span class="line">  4010cb:	0f 1f <span class="number">44</span> <span class="number">00</span> <span class="number">00</span>       	nopl   <span class="number">0x0</span>(%rax,%rax,<span class="number">1</span>)</span><br><span class="line">  4010d0:	eb <span class="number">07</span>                	<span class="keyword">jmp</span>    4010d9 &lt;phase_5+<span class="number">0x77</span>&gt;</span><br><span class="line">  4010d2:	b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>x0,%eax</span><br><span class="line">  4010d7:	eb b2                	<span class="keyword">jmp</span>    40108b &lt;phase_5+<span class="number">0x29</span>&gt;</span><br><span class="line">  4010d9:	<span class="number">48</span> 8b <span class="number">44</span> <span class="number">24</span> <span class="number">18</span>       	<span class="keyword">mov</span>    <span class="number">0x18</span>(%rsp),%rax  </span><br><span class="line">  4010de:	<span class="number">64</span> <span class="number">48</span> <span class="number">33</span> <span class="number">04</span> <span class="number">25</span> <span class="number">28</span> <span class="number">00</span> 	<span class="keyword">xor</span>    %fs:<span class="number">0x28</span>,%rax                 # 若stack canary未被破坏则跳过__stack_chk_fail</span><br><span class="line">  4010e5:	<span class="number">00</span> <span class="number">00</span> </span><br><span class="line">  4010e7:	<span class="number">74</span> <span class="number">05</span>                	<span class="keyword">je</span>     4010ee &lt;phase_5+<span class="number">0x8c</span>&gt;</span><br><span class="line">  4010e9:	e8 <span class="number">42</span> fa ff ff       	callq  400b30 &lt;__stack_chk_fail@plt&gt;</span><br><span class="line">  4010ee:	<span class="number">48</span> <span class="number">83</span> c4 <span class="number">20</span>          	<span class="keyword">add</span>    <span class="number">$0</span>x20,%rsp                    # restore</span><br><span class="line">  4010f2:	5b                   	<span class="keyword">pop</span>    %rbx</span><br><span class="line">  4010f3:	c3                   	retq </span><br></pre></td></tr></table></figure> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/s 0x4024b0</span><br><span class="line">0x4024b0 &lt;array.3449&gt;:  &quot;maduiersnfotvbylSo you think you can stop the bomb with ctrl-c, do you?&quot;</span><br></pre></td></tr></table></figure> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/s 0x40245e</span><br><span class="line">0x40245e:       &quot;flyers&quot;</span><br></pre></td></tr></table></figure> 输入正确结果后内存中存放的内容： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/s $rsp+0x10</span><br><span class="line">0x7fffffffdfc0: &quot;flyers&quot;</span><br></pre></td></tr></table></figure> 最后的答案为: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">9?&gt;567</span><br></pre></td></tr></table></figure> ## <strong>Phase_6</strong> <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">00000000004010f4 &lt;phase_6&gt;:</span><br><span class="line">  4010f4:	<span class="number">41</span> <span class="number">56</span>                	<span class="keyword">push</span>   %r14                         # callee save</span><br><span class="line">  4010f6:	<span class="number">41</span> <span class="number">55</span>                	<span class="keyword">push</span>   %r13</span><br><span class="line">  4010f8:	<span class="number">41</span> <span class="number">54</span>                	<span class="keyword">push</span>   %r12</span><br><span class="line">  4010fa:	<span class="number">55</span>                   	<span class="keyword">push</span>   %rbp</span><br><span class="line">  4010fb:	<span class="number">53</span>                   	<span class="keyword">push</span>   %rbx</span><br><span class="line">  4010fc:	<span class="number">48</span> <span class="number">83</span> ec <span class="number">50</span>          	<span class="keyword">sub</span>    <span class="number">$0</span>x50,%rsp                   # stack frame</span><br><span class="line">  <span class="number">401100</span>:	<span class="number">49</span> <span class="number">89</span> e5             	<span class="keyword">mov</span>    %rsp,%r13</span><br><span class="line">  <span class="number">401103</span>:	<span class="number">48</span> <span class="number">89</span> e6             	<span class="keyword">mov</span>    %rsp,%rsi</span><br><span class="line">  <span class="number">401106</span>:	e8 <span class="number">51</span> <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>       	callq  40145c &lt;read_six_numbers&gt;</span><br><span class="line">  40110b:	<span class="number">49</span> <span class="number">89</span> e6             	<span class="keyword">mov</span>    %rsp,%r14</span><br><span class="line">  40110e:	<span class="number">41</span> bc <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	<span class="keyword">mov</span>    <span class="number">$0</span>x0,%r12d                   # 迭代器</span><br><span class="line">  <span class="number">401114</span>:	4c <span class="number">89</span> ed             	<span class="keyword">mov</span>    %r13,%rbp</span><br><span class="line">  <span class="number">401117</span>:	<span class="number">41</span> 8b <span class="number">45</span> <span class="number">00</span>          	<span class="keyword">mov</span>    <span class="number">0x0</span>(%r13),%eax               # <span class="built_in">r13</span>中存放的数字放入<span class="built_in">eax</span>中</span><br><span class="line">  40111b:	<span class="number">83</span> e8 <span class="number">01</span>             	<span class="keyword">sub</span>    <span class="number">$0</span>x1,%eax                    # <span class="built_in">eax</span>大于<span class="number">5</span>则bomb, 一轮<span class="keyword">loop</span>之后观察可以推出六个数字的范围是<span class="number">1</span>到<span class="number">6</span>, 且相邻数字不能相同</span><br><span class="line">  40111e:	<span class="number">83</span> f8 <span class="number">05</span>             	<span class="keyword">cmp</span>    <span class="number">$0</span>x5,%eax</span><br><span class="line">  <span class="number">401121</span>:	<span class="number">76</span> <span class="number">05</span>                	<span class="keyword">jbe</span>    <span class="number">401128</span> &lt;phase_6+<span class="number">0x34</span>&gt;        # be无符号比较, 若参数数减去<span class="number">1</span>小于<span class="number">0</span>则会bomb，进而可以推出参数不能小于<span class="number">1</span></span><br><span class="line">  <span class="number">401123</span>:	e8 <span class="number">12</span> <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>       	callq  40143a &lt;explode_bomb&gt;</span><br><span class="line">  <span class="number">401128</span>:	<span class="number">41</span> <span class="number">83</span> c4 <span class="number">01</span>          	<span class="keyword">add</span>    <span class="number">$0</span>x1,%r12d </span><br><span class="line">  40112c:	<span class="number">41</span> <span class="number">83</span> fc <span class="number">06</span>          	<span class="keyword">cmp</span>    <span class="number">$0</span>x6,%r12d</span><br><span class="line">  <span class="number">401130</span>:	<span class="number">74</span> <span class="number">21</span>                	<span class="keyword">je</span>     <span class="number">401153</span> &lt;phase_6+<span class="number">0x5f</span>&gt;        # 外循环迭代次数到<span class="number">6</span>次则终止<span class="keyword">loop</span></span><br><span class="line">  <span class="number">401132</span>:	<span class="number">44</span> <span class="number">89</span> e3             	<span class="keyword">mov</span>    %r12d,%ebx</span><br><span class="line">  <span class="number">401135</span>:	<span class="number">48</span> <span class="number">63</span> c3             	movslq %ebx,%rax</span><br><span class="line">  <span class="number">401138</span>:	8b <span class="number">04</span> <span class="number">84</span>             	<span class="keyword">mov</span>    (%rsp,%rax,<span class="number">4</span>),%eax           # 取下一个数字放入<span class="built_in">eax</span></span><br><span class="line">  40113b:	<span class="number">39</span> <span class="number">45</span> <span class="number">00</span>             	<span class="keyword">cmp</span>    %eax,<span class="number">0x0</span>(%rbp)               # 若当前数字与下一个数字相等，则bomb</span><br><span class="line">  40113e:	<span class="number">75</span> <span class="number">05</span>                	<span class="keyword">jne</span>    <span class="number">401145</span> &lt;phase_6+<span class="number">0x51</span>&gt;</span><br><span class="line">  <span class="number">401140</span>:	e8 f5 <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>       	callq  40143a &lt;explode_bomb&gt;        # 六个数字出现连续相同的数字则发生bomb</span><br><span class="line">  <span class="number">401145</span>:	<span class="number">83</span> c3 <span class="number">01</span>             	<span class="keyword">add</span>    <span class="number">$0</span>x1,%ebx</span><br><span class="line">  <span class="number">401148</span>:	<span class="number">83</span> fb <span class="number">05</span>             	<span class="keyword">cmp</span>    <span class="number">$0</span>x5,%ebx                    # 若没遍历完六个数字中剩余的数字则<span class="keyword">loop</span></span><br><span class="line">  40114b:	7e e8                	<span class="keyword">jle</span>    <span class="number">401135</span> &lt;phase_6+<span class="number">0x41</span>&gt;</span><br><span class="line">  <span class="number">40114d</span>:	<span class="number">49</span> <span class="number">83</span> c5 <span class="number">04</span>          	<span class="keyword">add</span>    <span class="number">$0</span>x4,%r13                    # 取下一个数字</span><br><span class="line">  <span class="number">401151</span>:	eb c1                	<span class="keyword">jmp</span>    <span class="number">401114</span> &lt;phase_6+<span class="number">0x20</span>&gt;</span><br><span class="line">  <span class="number">401153</span>:	<span class="number">48</span> <span class="number">8d</span> <span class="number">74</span> <span class="number">24</span> <span class="number">18</span>       	<span class="keyword">lea</span>    <span class="number">0x18</span>(%rsp),%rsi              # null terminator, 第六个参数后面的字</span><br><span class="line">  <span class="number">401158</span>:	4c <span class="number">89</span> f0             	<span class="keyword">mov</span>    %r14,%rax</span><br><span class="line">  40115b:	b9 <span class="number">07</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>x7,%ecx</span><br><span class="line">  <span class="number">401160</span>:	<span class="number">89</span> ca                	<span class="keyword">mov</span>    %ecx,%edx</span><br><span class="line">  <span class="number">401162</span>:	2b <span class="number">10</span>                	<span class="keyword">sub</span>    (%rax),%edx                  # 将<span class="number">7</span>减去当前位置的参数数字的结果放回到当前位置, 即将六个数字结果都改为<span class="number">7</span>-当前数字</span><br><span class="line">  <span class="number">401164</span>:	<span class="number">89</span> <span class="number">10</span>                	<span class="keyword">mov</span>    %edx,(%rax)</span><br><span class="line">  <span class="number">401166</span>:	<span class="number">48</span> <span class="number">83</span> c0 <span class="number">04</span>          	<span class="keyword">add</span>    <span class="number">$0</span>x4,%rax                    # 往下移动一个数字的位置</span><br><span class="line">  40116a:	<span class="number">48</span> <span class="number">39</span> f0             	<span class="keyword">cmp</span>    %rsi,%rax                    # 若未移动到最后一个数字结束则继续<span class="keyword">loop</span></span><br><span class="line">  <span class="number">40116d</span>:	<span class="number">75</span> f1                	<span class="keyword">jne</span>    <span class="number">401160</span> &lt;phase_6+<span class="number">0x6c</span>&gt;</span><br><span class="line">  40116f:	be <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>x0,%esi</span><br><span class="line">  <span class="number">401174</span>:	eb <span class="number">21</span>                	<span class="keyword">jmp</span>    <span class="number">401197</span> &lt;phase_6+<span class="number">0xa3</span>&gt;        </span><br><span class="line">  <span class="number">401176</span>:	<span class="number">48</span> 8b <span class="number">52</span> <span class="number">08</span>          	<span class="keyword">mov</span>    <span class="number">0x8</span>(%rdx),%rdx               # 将当前<span class="built_in">rdx</span>中存放地址的下一个<span class="number">8</span>字节中存放地址的内容存放到<span class="built_in">rdx</span>中, 即遍历链表，取到对应的节点</span><br><span class="line">  40117a:	<span class="number">83</span> c0 <span class="number">01</span>             	<span class="keyword">add</span>    <span class="number">$0</span>x1,%eax</span><br><span class="line">  <span class="number">40117d</span>:	<span class="number">39</span> c8                	<span class="keyword">cmp</span>    %ecx,%eax                    </span><br><span class="line">  40117f:	<span class="number">75</span> f5                	<span class="keyword">jne</span>    <span class="number">401176</span> &lt;phase_6+<span class="number">0x82</span>&gt;        # 若<span class="built_in">eax</span>与做出变更的数字不相等则继续<span class="keyword">loop</span>, 实际上变更的数字为node号</span><br><span class="line">  <span class="number">401181</span>:	eb <span class="number">05</span>                	<span class="keyword">jmp</span>    <span class="number">401188</span> &lt;phase_6+<span class="number">0x94</span>&gt;</span><br><span class="line">  <span class="number">401183</span>:	ba d0 <span class="number">32</span> <span class="number">60</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>x6032d0,%edx               # <span class="number">0x6032d0</span>为node1</span><br><span class="line">  <span class="number">401188</span>:	<span class="number">48</span> <span class="number">89</span> <span class="number">54</span> <span class="number">74</span> <span class="number">20</span>       	<span class="keyword">mov</span>    %rdx,<span class="number">0x20</span>(%rsp,%rsi,<span class="number">2</span>)       # 将当前node的地址存放到$<span class="built_in">rsp</span>+<span class="number">0x20</span>开始，以<span class="number">8</span>字节为间隔的连续地址</span><br><span class="line">  <span class="number">40118d</span>:	<span class="number">48</span> <span class="number">83</span> c6 <span class="number">04</span>          	<span class="keyword">add</span>    <span class="number">$0</span>x4,%rsi                    # 移动到下一个变更后的参数</span><br><span class="line">  <span class="number">401191</span>:	<span class="number">48</span> <span class="number">83</span> fe <span class="number">18</span>          	<span class="keyword">cmp</span>    <span class="number">$0</span>x18,%rsi                   </span><br><span class="line">  <span class="number">401195</span>:	<span class="number">74</span> <span class="number">14</span>                	<span class="keyword">je</span>     4011ab &lt;phase_6+<span class="number">0xb7</span>&gt;        # 遍历完六个参数则跳转到target, 即取对应参数变更后的node号的地址放入内存中</span><br><span class="line">  <span class="number">401197</span>:	8b 0c <span class="number">34</span>             	<span class="keyword">mov</span>    (%rsp,%rsi,<span class="number">1</span>),%ecx           # 按顺序取做出变更后的参数</span><br><span class="line">  40119a:	<span class="number">83</span> f9 <span class="number">01</span>             	<span class="keyword">cmp</span>    <span class="number">$0</span>x1,%ecx                    # 若当前数字小于等于<span class="number">1</span>则，直接存放当前节点不需要遍历链表</span><br><span class="line">  <span class="number">40119d</span>:	7e e4                	<span class="keyword">jle</span>    <span class="number">401183</span> &lt;phase_6+<span class="number">0x8f</span>&gt;</span><br><span class="line">  40119f:	b8 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>x1,%eax</span><br><span class="line">  4011a4:	ba d0 <span class="number">32</span> <span class="number">60</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>x6032d0,%edx               # 传递的是地址, gdb调试可以发现存在一个链表, 比如<span class="number">0x6032d8</span>存储单元中存放着的是<span class="number">0x6032e0</span></span><br><span class="line">  4011a9:	eb cb                	<span class="keyword">jmp</span>    <span class="number">401176</span> &lt;phase_6+<span class="number">0x82</span>&gt;</span><br><span class="line">  4011ab:	<span class="number">48</span> 8b 5c <span class="number">24</span> <span class="number">20</span>       	<span class="keyword">mov</span>    <span class="number">0x20</span>(%rsp),%rbx              # node6的地址</span><br><span class="line">  4011b0:	<span class="number">48</span> <span class="number">8d</span> <span class="number">44</span> <span class="number">24</span> <span class="number">28</span>       	<span class="keyword">lea</span>    <span class="number">0x28</span>(%rsp),%rax               </span><br><span class="line">  4011b5:	<span class="number">48</span> <span class="number">8d</span> <span class="number">74</span> <span class="number">24</span> <span class="number">50</span>       	<span class="keyword">lea</span>    <span class="number">0x50</span>(%rsp),%rsi               </span><br><span class="line">  4011ba:	<span class="number">48</span> <span class="number">89</span> d9             	<span class="keyword">mov</span>    %rbx,%rcx                    </span><br><span class="line">  4011bd:	<span class="number">48</span> 8b <span class="number">10</span>             	<span class="keyword">mov</span>    (%rax),%rdx                  # node5的地址, 即指针</span><br><span class="line">  4011c0:	<span class="number">48</span> <span class="number">89</span> <span class="number">51</span> <span class="number">08</span>          	<span class="keyword">mov</span>    %rdx,<span class="number">0x8</span>(%rcx)               # 将node5的指针作为node6的next</span><br><span class="line">  4011c4:	<span class="number">48</span> <span class="number">83</span> c0 <span class="number">08</span>          	<span class="keyword">add</span>    <span class="number">$0</span>x8,%rax                    # node4指针的地址</span><br><span class="line">  4011c8:	<span class="number">48</span> <span class="number">39</span> f0             	<span class="keyword">cmp</span>    %rsi,%rax                    # 看一下是否遍历结束</span><br><span class="line">  4011cb:	<span class="number">74</span> <span class="number">05</span>                	<span class="keyword">je</span>     4011d2 &lt;phase_6+<span class="number">0xde</span>&gt;        </span><br><span class="line">  4011cd:	<span class="number">48</span> <span class="number">89</span> d1             	<span class="keyword">mov</span>    %rdx,%rcx</span><br><span class="line">  4011d0:	eb eb                	<span class="keyword">jmp</span>    4011bd &lt;phase_6+<span class="number">0xc9</span>&gt;        # <span class="keyword">loop</span></span><br><span class="line">  4011d2:	<span class="number">48</span> c7 <span class="number">42</span> <span class="number">08</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	<span class="keyword">movq</span>   <span class="number">$0</span>x0,<span class="number">0x8</span>(%rdx)               # 将尾节点node1的next指向空</span><br><span class="line">  4011d9:	<span class="number">00</span>                                                        # 应该是涉及pipeline优化的bubble </span><br><span class="line">  4011da:	bd <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	<span class="keyword">mov</span>    <span class="number">$0</span>x5,%ebp                    # 迭代器</span><br><span class="line">  4011df:	<span class="number">48</span> 8b <span class="number">43</span> <span class="number">08</span>          	<span class="keyword">mov</span>    <span class="number">0x8</span>(%rbx),%rax               # 将下一个node的地址赋给<span class="built_in">rax</span></span><br><span class="line">  4011e3:	8b <span class="number">00</span>                	<span class="keyword">mov</span>    (%rax),%eax                  # 取下一个node的值(即低32bit)赋给<span class="built_in">eax</span></span><br><span class="line">  4011e5:	<span class="number">39</span> <span class="number">03</span>                	<span class="keyword">cmp</span>    %eax,(%rbx)                  # 当前node的值若小于(&lt;)下一个node的值，则bomb，到这里可以猜测要将链表要按node值来构造递减序列</span><br><span class="line">  4011e7:	<span class="number">7d</span> <span class="number">05</span>                	<span class="keyword">jge</span>    4011ee &lt;phase_6+<span class="number">0xfa</span>&gt;        # 初步可以判断需要用<span class="number">7</span>-当前参数值来取node号</span><br><span class="line">  4011e9:	e8 4c <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>       	callq  40143a &lt;explode_bomb&gt;</span><br><span class="line">  4011ee:	<span class="number">48</span> 8b 5b <span class="number">08</span>          	<span class="keyword">mov</span>    <span class="number">0x8</span>(%rbx),%rbx               # 将当前node的next赋给<span class="built_in">rbx</span>, 即移动指针遍历到下一个node</span><br><span class="line">  4011f2:	<span class="number">83</span> ed <span class="number">01</span>             	<span class="keyword">sub</span>    <span class="number">$0</span>x1,%ebp                    # 减少迭代次数</span><br><span class="line">  4011f5:	<span class="number">75</span> e8                	<span class="keyword">jne</span>    4011df &lt;phase_6+<span class="number">0xeb</span>&gt;</span><br><span class="line">  4011f7:	<span class="number">48</span> <span class="number">83</span> c4 <span class="number">50</span>          	<span class="keyword">add</span>    <span class="number">$0</span>x50,%rsp</span><br><span class="line">  4011fb:	5b                   	<span class="keyword">pop</span>    %rbx</span><br><span class="line">  4011fc:	<span class="number">5d</span>                   	<span class="keyword">pop</span>    %rbp</span><br><span class="line">  4011fd:	<span class="number">41</span> 5c                	<span class="keyword">pop</span>    %r12</span><br><span class="line">  4011ff:	<span class="number">41</span> <span class="number">5d</span>                	<span class="keyword">pop</span>    %r13</span><br><span class="line">  <span class="number">401201</span>:	<span class="number">41</span> 5e                	<span class="keyword">pop</span>    %r14</span><br><span class="line">  <span class="number">401203</span>:	c3                   	retq   </span><br></pre></td></tr></table></figure> 查看0x6032d0处地址内容(gdb中的字默认为4字节， 而x86的字默认为2字节), 可以猜测出第一个8字节中高4字节为node号，低4字节为值域，第二个8字节为next指针域，下述示例传递的参数为<code>1 2 3 4 5 6</code>: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/12xg 0x6032d0</span><br><span class="line">0x6032d0 &lt;node1&gt;:       0x000000010000014c      0x0000000000000000</span><br><span class="line">0x6032e0 &lt;node2&gt;:       0x00000002000000a8      0x00000000006032d0</span><br><span class="line">0x6032f0 &lt;node3&gt;:       0x000000030000039c      0x00000000006032e0</span><br><span class="line">0x603300 &lt;node4&gt;:       0x00000004000002b3      0x00000000006032f0</span><br><span class="line">0x603310 &lt;node5&gt;:       0x00000005000001dd      0x0000000000603300</span><br><span class="line">0x603320 &lt;node6&gt;:       0x00000006000001bb      0x0000000000603310</span><br></pre></td></tr></table></figure> 6个node的值, 再将其由大到小排序： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">node1: 0x14c</span><br><span class="line">node2: 0x0a8</span><br><span class="line">node3: 0x39c</span><br><span class="line">node4: 0x2b3</span><br><span class="line">node5: 0x1dd</span><br><span class="line">node6: 0x1bb</span><br><span class="line">node3 &gt; node4 &gt; node5 &gt; node6 &gt; node1 &gt; node2</span><br></pre></td></tr></table></figure> 由7-nodeNumber得到答案为: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4 3 2 1 6 5</span><br></pre></td></tr></table></figure> <img src="https://pic4.zhimg.com/80/v2-77b2f6513b85ca11bed6e27cf04ea16d.png" alt="Defused" /></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://mitmoksha.github.io/2022/05/16/CSAPP-Lab1-Data-Lab/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Pishun Huang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Moksha's Blog">
      <meta itemprop="description" content="Opportunities are ready for it, the more to beat action.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Moksha's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/16/CSAPP-Lab1-Data-Lab/" class="post-title-link" itemprop="url">CSAPP Lab1: Data Lab</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-16 17:32:17" itemprop="dateCreated datePublished" datetime="2022-05-16T17:32:17+08:00">2022-05-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-05-18 09:15:45" itemprop="dateModified" datetime="2022-05-18T09:15:45+08:00">2022-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CMU15-213/" itemprop="url" rel="index"><span itemprop="name">CMU15-213</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <span id="more"></span>
<h1 id="csapp-lab1-data-lab">CSAPP Lab1: Data Lab</h1>
<h2 id="some-restriction"><strong>Some Restriction</strong></h2>
<h4 id="integer-coding-rules"><strong>Integer Coding Rules</strong></h4>
<ol type="1">
<li>Expr
<ol type="1">
<li>整型操作数的值被限制在范围[0, 255]。</li>
<li>不能使用全局变量</li>
<li>只能使用的一元操作<code>!</code>, <code>~</code></li>
<li>只能使用的二元操作<code>&amp;</code>, <code>^</code>, <code>|</code>, <code>+</code>, <code>&lt;&lt;</code>, <code>&gt;&gt;</code></li>
<li>一个表达式不会被限制拥有多个操作符</li>
</ol></li>
<li>Fobidden
<ol type="1">
<li>使用控制语句如<code>if</code>, <code>do</code>, <code>while</code>, <code>for</code>, <code>switch</code>等等</li>
<li>定义或使用任何宏</li>
<li>在当前文件中定义任何额外的函数</li>
<li>调用任何函数</li>
<li>使用其他操作</li>
<li>使用类型转换</li>
<li>使用除<code>int</code>之外的任何数据类型，使用<code>arrays</code>, <code>structs</code>, <code>unions</code></li>
</ol></li>
<li>假设机器的配置
<ol type="1">
<li>使用2的补码，<code>int</code>的表示为32-bit</li>
<li>执行算术右移</li>
<li>如果左移的位数小于0或者大于31则会出现未预测的行为。</li>
</ol></li>
</ol>
<h4 id="floating-point-coding-rules"><strong>Floating Point Coding Rules</strong></h4>
<ol type="1">
<li>Forbidden
<ol type="1">
<li>定义或使用任何宏</li>
<li>定义任何额外的函数</li>
<li>调用任何函数</li>
<li>使用任何形式的类型转换</li>
<li>使用<code>arrays</code>, <code>structs</code>, <code>unions</code></li>
</ol></li>
</ol>
<h4 id="notes"><strong>Notes</strong></h4>
<ol type="1">
<li>使用<code>dlc</code>(data tab checker)编译器来检查解决方案的合理性</li>
<li>使用<code>btest</code>来检查你的函数的正确性</li>
<li>使用<code>BDD checker</code>来正式地证实你的函数</li>
</ol>
<h4 id="lab-note"><strong>lab Note</strong></h4>
<ol type="1">
<li>64位机器上编译32位程序会出现错误<code>fatal error: bits/libc-header-start.h: 没有那个文件或目录</code>，是因为gcc没有安装<code>multilib</code>库，这个库可以在64位的机器上产生32位的程序<code>sudo apt install gcc-multilib</code></li>
</ol>
<h3 id="bitxor"><strong>1. bitXor</strong></h3>
<p>通过图中所给的与、非和或门构造的异或逻辑电路，再利用德摩根定律将所有的或门转化为与门可得。 <img src="https://pic4.zhimg.com/80/v2-3e52fb0d69b1220a809e2982919296bf.png" alt="XOR gate" /></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* bitXor - x^y using only ~ and &amp; </span></span><br><span class="line"><span class="comment"> *   Example: bitXor(4, 5) = 1</span></span><br><span class="line"><span class="comment"> *   Legal ops: ~ &amp;</span></span><br><span class="line"><span class="comment"> *   Max ops: 14</span></span><br><span class="line"><span class="comment"> *   Rating: 1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">bitXor</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> &#123; </span><br><span class="line">  <span class="keyword">return</span> ~((~(x&amp;(~y))) &amp; (~((~x)&amp;y)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="tmin"><strong>2. tmin</strong></h3>
<p>32位整型数<code>2's complement</code>的范围为<code>[-2^(n-1), 2^(n-1)-1</code>, 很容易得出结果 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * tmin - return minimum two&#x27;s complement integer </span></span><br><span class="line"><span class="comment"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *   Max ops: 4</span></span><br><span class="line"><span class="comment"> *   Rating: 1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">tmin</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span> &lt;&lt; <span class="number">31</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="istmax"><strong>3. isTmax</strong></h3>
<p>摸索了小一段时间，解法很多，<code>-1</code>可以通过取反<code>+1</code>来构造。假设x为<code>Tmax</code>, 对<code>Tmax</code>取反得到<code>Tmin</code>，再减1则会发生<code>underflow</code>会得到<code>Tmax</code>, 通过逻辑运算的结果与<code>x</code>本身异或，看结果是否为<code>0</code>来判断<code>Tmax</code>。这种情况下<code>-1</code>是需要排除的, 因为对<code>-1</code>的<code>2's Complement</code>取反得到<code>0</code>，减1之后会得到<code>-1</code>本身，因此异或结果还是<code>0</code>，需要排除(利用好<code>!!</code>,保证与的操作数要么是<code>0</code>或<code>1</code>)。排除直接让<code>x+1</code>判断即可，否则操作数会超出10个。 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * isTmax - returns 1 if x is the maximum, two&#x27;s complement number,</span></span><br><span class="line"><span class="comment"> *     and 0 otherwise </span></span><br><span class="line"><span class="comment"> *   Legal ops: ! ~ &amp; ^ | +</span></span><br><span class="line"><span class="comment"> *   Max ops: 10</span></span><br><span class="line"><span class="comment"> *   Rating: 1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">isTmax</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (!(((~x)+(~<span class="number">1</span>+<span class="number">1</span>))^x)) &amp; (!!(x+<span class="number">1</span>));</span><br><span class="line">&#125;:</span><br></pre></td></tr></table></figure></p>
<h3 id="alloddbits"><strong>4. allOddBits</strong></h3>
<p>根据题目给定的操作符数的限制，以及操作数值的限定，即可确定需要利用好<code>0xAA</code>。同样也花了一些时间去斟酌，很多细节需要把握住，得到最终的答案。 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * allOddBits - return 1 if all odd-numbered bits in word set to 1</span></span><br><span class="line"><span class="comment"> *   where bits are numbered from 0 (least significant) to 31 (most significant)</span></span><br><span class="line"><span class="comment"> *   Examples allOddBits(0xFFFFFFFD) = 0, allOddBits(0xAAAAAAAA) = 1</span></span><br><span class="line"><span class="comment"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *   Max ops: 12</span></span><br><span class="line"><span class="comment"> *   Rating: 2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">allOddBits</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> !((((x&amp;<span class="number">0xAA</span>)&amp;((x&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xAA</span>))&amp;(((x&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xAA</span>)&amp;((x&gt;&gt;<span class="number">24</span>)&amp;<span class="number">0xAA</span>)))^<span class="number">0xAA</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="negate"><strong>5. negate</strong></h3>
<p>很简单 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * negate - return -x </span></span><br><span class="line"><span class="comment"> *   Example: negate(1) = -1.</span></span><br><span class="line"><span class="comment"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *   Max ops: 5</span></span><br><span class="line"><span class="comment"> *   Rating: 2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">negate</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> ~x+<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="isasciidigit"><strong>6. isAsciiDigit</strong></h3>
<p>可以先将操作数限定在<code>0x3X</code>的范围内，再通过对<code>0x0A</code>取补得到<code>-10</code>，取低4位进行加法运算，得到的结果通过符号位，若符号位为<code>1</code>则为ASCII数字，否则不满足条件。可以通过提取从低位数起第五个bit即<code>0x10</code>来确定符号位。 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * isAsciiDigit - return 1 if 0x30 &lt;= x &lt;= 0x39 (ASCII codes for characters &#x27;0&#x27; to &#x27;9&#x27;)</span></span><br><span class="line"><span class="comment"> *   Example: isAsciiDigit(0x35) = 1.</span></span><br><span class="line"><span class="comment"> *            isAsciiDigit(0x3a) = 0.</span></span><br><span class="line"><span class="comment"> *            isAsciiDigit(0x05) = 0.</span></span><br><span class="line"><span class="comment"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *   Max ops: 15</span></span><br><span class="line"><span class="comment"> *   Rating: 3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">isAsciiDigit</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">  <span class="type">int</span> neg_A = ~<span class="number">0x0A</span>+<span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> ((!((x&gt;&gt;<span class="number">4</span>)^<span class="number">0x3</span>)) &amp; (!!(((x&amp;<span class="number">0xF</span>)+neg_A)&amp;(<span class="number">0x10</span>))));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> ### <strong>7. conditional</strong> 保证<code>x</code>非<code>0</code>即<code>1</code>，再利用<code>0</code>和<code>1</code>补码的特点, 构造全<code>1</code>和全<code>0</code>, 分别和<code>y</code>, <code>z</code>完成与运算来进行排除，这道题还是非常巧妙的。 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * conditional - same as x ? y : z</span></span><br><span class="line"><span class="comment"> *   Example: conditional(2,4,5) = 4</span></span><br><span class="line"><span class="comment"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *   Max ops: 16</span></span><br><span class="line"><span class="comment"> *   Rating: 3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">conditional</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, <span class="type">int</span> z)</span> &#123; </span><br><span class="line">  <span class="type">int</span> mask = ~(!!(x^<span class="number">0x0</span>))+<span class="number">1</span>; </span><br><span class="line">  <span class="keyword">return</span> (y&amp;mask) + (z&amp;(~mask));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> ### <strong>8. isLessOrEqual</strong> 根据两个参数<code>x</code>, <code>y</code>的符号位先分几种情况 1. 满足小于等于 1. 两数相等 2. <code>x&lt;0, y&gt;0</code>, 避免符号位相等时的溢出情况 3. 符号位相等比较。通过第一个操作数加上第二个操作数的取补的形式, 若结果小于0，则<code>x&lt;y</code> - 负负比较, 可能会出现对<code>Tmin</code>取补发生下溢出的特殊情况，因此需要排除第二个操作数为<code>Tmin</code>的情况，恰好该情况要么<strong>相等</strong>(已经判断过了), 要么就是<code>x&gt;y</code>(也判断了)。 - 正正比较 2. 不满足小于等于,即大于等于(<code>x&gt;0, y&lt;0</code>) <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * isLessOrEqual - if x &lt;= y  then return 1, else return 0 </span></span><br><span class="line"><span class="comment"> *   Example: isLessOrEqual(4,5) = 1.</span></span><br><span class="line"><span class="comment"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *   Max ops: 24</span></span><br><span class="line"><span class="comment"> *   Rating: 3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">isLessOrEqual</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> &#123;</span><br><span class="line">  <span class="type">int</span> x_sign_bit = ((x&gt;&gt;<span class="number">31</span>)&amp;<span class="number">0x01</span>);</span><br><span class="line">  <span class="type">int</span> y_sign_bit = ((y&gt;&gt;<span class="number">31</span>)&amp;<span class="number">0x01</span>);</span><br><span class="line">  <span class="type">int</span> Tmin = <span class="number">1</span> &lt;&lt; <span class="number">31</span>;</span><br><span class="line">  <span class="keyword">return</span> (!((~x_sign_bit)&amp;y_sign_bit)) &amp; ((!(x^y)) | (x_sign_bit&amp;(~y_sign_bit)) | ((((x+(~y+<span class="number">1</span>))&gt;&gt;<span class="number">31</span>)&amp;<span class="number">0x1</span>)&amp;(!!(y^Tmin))));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="logicalneg"><strong>9. logicalNeg</strong></h3>
<p>首先要将想一个办法将0和正数，负数区分开来。因为0和正数的符号位都是0，要区分开来恰好利用到了0的补码还是其本身的特性，正数取反加一后符号位由0变1，可以直接区分开来。再利用算数右移的特性，将0构造成全0，负数和正数构造成全1, 最后<code>+1</code>得到返回值。 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * logicalNeg - implement the ! operator, using all of </span></span><br><span class="line"><span class="comment"> *              the legal operators except !</span></span><br><span class="line"><span class="comment"> *   Examples: logicalNeg(3) = 0, logicalNeg(0) = 1</span></span><br><span class="line"><span class="comment"> *   Legal ops: ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *   Max ops: 12</span></span><br><span class="line"><span class="comment"> *   Rating: 4</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">logicalNeg</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> ((x&gt;&gt;<span class="number">31</span>)|((~x+<span class="number">1</span>)&gt;&gt;<span class="number">31</span>))+<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> ### <strong>10. howManyBits</strong> 坦白说这一题真的是卡了我好久，即便找到了最高bit位要想返回正确的结果几乎是很繁琐的，但肯定会超出操作符的限制。这道题参考了一下各路佬的思想，可以用二分法来实现。还需要注意负数需要按位取反(排除符号位的影响)，正数保持不变即可，可以通过<code>sign_bit</code>减<code>1</code>来构造全<code>0</code>和全<code>1</code>。可以通过右移<code>16</code>、<code>8</code>、<code>4</code>、<code>2</code>、<code>1</code>bit来找到最高的<code>bit 1</code>，这道题还是非常巧妙的。 判断右移<code>n bit</code>后是否为0 - 如果为0，说明需要的位在高<code>n-bit</code>(左半侧)，数则保持不变，故不记录<code>n</code>，继续进行二分搜索。 - 如果不为0，说明需要的位在低<code>n-bit</code>(右半侧), 数向右移动<code>n-bit</code>继续进行搜索，且记录<code>n</code>。 最后将所有移位得到的<code>n</code>都累加起来得到最后的结果 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* howManyBits  - return the minimum number of bits required to represent x in</span></span><br><span class="line"><span class="comment"> *             two&#x27;s complement</span></span><br><span class="line"><span class="comment"> *  Examples: howManyBits(12) = 5</span></span><br><span class="line"><span class="comment"> *            howManyBits(298) = 10</span></span><br><span class="line"><span class="comment"> *            howManyBits(-5) = 4</span></span><br><span class="line"><span class="comment"> *            howManyBits(0)  = 1</span></span><br><span class="line"><span class="comment"> *            howManyBits(-1) = 1</span></span><br><span class="line"><span class="comment"> *            howManyBits(0x80000000) = 32</span></span><br><span class="line"><span class="comment"> *  Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *  Max ops: 90</span></span><br><span class="line"><span class="comment"> *  Rating: 4</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">howManyBits</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">  <span class="type">int</span> b16, b8, b4, b2, b1, b0;</span><br><span class="line">  <span class="type">int</span> sign_bit = (x&gt;&gt;<span class="number">31</span>)&amp;<span class="number">0x1</span>;</span><br><span class="line">  <span class="type">int</span> flag = sign_bit+(~<span class="number">1</span>+<span class="number">1</span>);   <span class="comment">// neg -&gt; all 0,  not_neg -&gt; all 1</span></span><br><span class="line">  x = ((~flag)&amp;(~x))|(flag&amp;x);  <span class="comment">// if neg, reverse.</span></span><br><span class="line">  b16 = (!!(x&gt;&gt;<span class="number">16</span>))&lt;&lt;<span class="number">4</span>;</span><br><span class="line">  x &gt;&gt;= b16;</span><br><span class="line">  b8 = (!!(x&gt;&gt;<span class="number">8</span>))&lt;&lt;<span class="number">3</span>;</span><br><span class="line">  x &gt;&gt;= b8;</span><br><span class="line">  b4 = (!!(x&gt;&gt;<span class="number">4</span>))&lt;&lt;<span class="number">2</span>;</span><br><span class="line">  x &gt;&gt;= b4;</span><br><span class="line">  b2 = (!!(x&gt;&gt;<span class="number">2</span>))&lt;&lt;<span class="number">1</span>;</span><br><span class="line">  x &gt;&gt;= b2;</span><br><span class="line">  b1 = !!(x&gt;&gt;<span class="number">1</span>);</span><br><span class="line">  x &gt;&gt;= b1;</span><br><span class="line">  b0 = x;</span><br><span class="line">  <span class="keyword">return</span> b16 + b8 + b4 + b2 + b1 + b0 + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="floatscale2"><strong>11. floatScale2</strong></h3>
<p>描述里没有给<code>Infinity</code>的case，通过测试发现，与<code>Nan</code>返回值一致合并一起判断。需要判断几种情况: <code>NaN</code>, <code>Subnormal</code>, <code>+0</code>, <code>-0</code>, <code>Normalize</code>。<code>Normalize</code>的情况只需要对<code>Exponent</code>的最低位增加一个<code>bit</code>即可。注意<code>Subnormal</code>情况<code>Fraction</code>为全<code>1</code>时左移的结果不需要将<code>Exponent</code>清零，按测试用例应该是将<code>Subnormal</code>转化为<code>Normalize</code>了。强调一下移码的意义为<code>IEEE 754</code> Normalize表示部分2的指数部分。 <span class="math display">\[Bias = 2^{Exponent-1}-1\]</span> <span class="math display">\[Normalize = 1.Fraction \times 2^{Exponent + Bias} (1 \leq Exponent \leq 2^{Exponent} - 2)\]</span> <span class="math display">\[Subnormal = 0.Fraction \times 2^{1-Bias}\]</span> <span class="math display">\[Biased = Unsigned - Bias\]</span> <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * floatScale2 - Return bit-level equivalent of expression 2*f for</span></span><br><span class="line"><span class="comment"> *   floating point argument f.</span></span><br><span class="line"><span class="comment"> *   Both the argument and result are passed as unsigned int&#x27;s, but</span></span><br><span class="line"><span class="comment"> *   they are to be interpreted as the bit-level representation of</span></span><br><span class="line"><span class="comment"> *   single-precision floating point values.</span></span><br><span class="line"><span class="comment"> *   When argument is NaN, return argument</span></span><br><span class="line"><span class="comment"> *   Legal ops: Any integer/unsigned operations incl. ||, &amp;&amp;. also if, while</span></span><br><span class="line"><span class="comment"> *   Max ops: 30</span></span><br><span class="line"><span class="comment"> *   Rating: 4</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="title function_">floatScale2</span><span class="params">(<span class="type">unsigned</span> uf)</span> &#123;</span><br><span class="line">  <span class="type">int</span> exp_mask = <span class="number">0x7F800000</span>;          <span class="comment">// the eight bits of exponent is all 1.</span></span><br><span class="line">  <span class="type">int</span> Neg_zero = <span class="number">0x80000000</span>;</span><br><span class="line">  <span class="type">int</span> sign_mask = Neg_zero;</span><br><span class="line">  <span class="type">int</span> fraction_mask = <span class="number">0x007FFFFF</span>;</span><br><span class="line">  <span class="keyword">if</span> (!((uf &amp; exp_mask)^exp_mask)) &#123;       <span class="comment">// eliminate the case of NaN.</span></span><br><span class="line">    <span class="keyword">return</span> uf;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!uf) &#123;                     <span class="comment">// eliminate the case of +0.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!(Neg_zero^uf)) &#123;          <span class="comment">// eliminate the case of -0.</span></span><br><span class="line">    <span class="keyword">return</span> Neg_zero;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!(uf &amp; exp_mask)) &#123;              <span class="comment">// elinimate the case of subnormal.</span></span><br><span class="line">    <span class="keyword">return</span> (uf&amp;sign_mask) + (((uf&amp;fraction_mask)&lt;&lt;<span class="number">1</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  uf += (<span class="number">0x1</span>&lt;&lt;<span class="number">23</span>);               <span class="comment">// Normalize.</span></span><br><span class="line">  <span class="keyword">return</span> uf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="floatfloat2int"><strong>12. floatFloat2Int</strong></h3>
<p>实现到<code>IEEE754</code>单精度浮点数到定点整数的转换。题目中首先要考虑溢出的情况，早在最开始实验就假设机器左移的位数小于0或者大于31都会出现未知的行为，因此需要将这两种情况包含进去。由于<code>Normalize</code>的<code>M</code>部分是<span class="math inline">\(1.Fraction\)</span>因此需要将小数点前面的<code>1</code>提前加入<code>fraction</code>部分。实际上<code>fraction</code>右移<code>23位</code>可以和<span class="math inline">\(2^{Biased}\)</span>的指数部分进行相减<span class="math inline">\(2^{Biased-23}\)</span>，进行对应的移位操作完成<span class="math inline">\(2^n\)</span>幂次运算，最后得到对应的结果。 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * floatFloat2Int - Return bit-level equivalent of expression (int) f</span></span><br><span class="line"><span class="comment"> *   for floating point argument f.</span></span><br><span class="line"><span class="comment"> *   Argument is passed as unsigned int, but</span></span><br><span class="line"><span class="comment"> *   it is to be interpreted as the bit-level representation of a</span></span><br><span class="line"><span class="comment"> *   single-precision floating point value.</span></span><br><span class="line"><span class="comment"> *   Anything out of range (including NaN and infinity) should return</span></span><br><span class="line"><span class="comment"> *   0x80000000u.</span></span><br><span class="line"><span class="comment"> *   Legal ops: Any integer/unsigned operations incl. ||, &amp;&amp;. also if, while</span></span><br><span class="line"><span class="comment"> *   Max ops: 30</span></span><br><span class="line"><span class="comment"> *   Rating: 4</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">floatFloat2Int</span><span class="params">(<span class="type">unsigned</span> uf)</span> &#123;</span><br><span class="line">  <span class="type">int</span> bias = <span class="number">1</span>-(<span class="number">1</span>&lt;&lt;<span class="number">7</span>);</span><br><span class="line">  <span class="type">int</span> exp_mask = <span class="number">0x7F800000</span>;</span><br><span class="line">  <span class="type">int</span> fraction_mask = <span class="number">0x007FFFFF</span>;</span><br><span class="line">  <span class="type">int</span> fraction = (uf &amp; fraction_mask);</span><br><span class="line">  <span class="type">int</span> <span class="built_in">exp</span> = (uf &amp; exp_mask) &gt;&gt; <span class="number">23</span>;</span><br><span class="line">  <span class="type">int</span> sign_bit = (uf&gt;&gt;<span class="number">31</span>)&amp;<span class="number">0x1</span>;</span><br><span class="line">  <span class="type">int</span> biased = <span class="built_in">exp</span> + bias;</span><br><span class="line">  <span class="keyword">if</span> (!(<span class="built_in">exp</span>^exp_mask) || biased &gt; <span class="number">31</span>) &#123;  <span class="comment">// NaN and infinity</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0x80000000</span>u;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!uf || !(uf^<span class="number">0x80000000</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (biased &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;    </span><br><span class="line">  &#125;</span><br><span class="line">  fraction |= (<span class="number">1</span>&lt;&lt;<span class="number">23</span>);  <span class="comment">// 1.F</span></span><br><span class="line">  <span class="keyword">if</span> (biased &gt;= <span class="number">23</span>) &#123;</span><br><span class="line">    fraction &lt;&lt;= (biased<span class="number">-23</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    fraction &gt;&gt;= (<span class="number">23</span>-biased);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (sign_bit)</span><br><span class="line">    <span class="keyword">return</span> -fraction;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> fraction;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="floatpower2"><strong>13. floatPower2</strong></h3>
<p>给定argument为<code>Biased</code>，求出其对应无符号<code>IEEE 754</code>单精度浮点数的表示即可。求出exp的值之后，左移23到IEEE754规格的exponent域中。认真读题后还是蛮简单的。 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * floatPower2 - Return bit-level equivalent of the expression 2.0^x</span></span><br><span class="line"><span class="comment"> *   (2.0 raised to the power x) for any 32-bit integer x.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   The unsigned value that is returned should have the identical bit</span></span><br><span class="line"><span class="comment"> *   representation as the single-precision floating-point number 2.0^x.</span></span><br><span class="line"><span class="comment"> *   If the result is too small to be represented as a denorm, return</span></span><br><span class="line"><span class="comment"> *   0. If too large, return +INF.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> *   Legal ops: Any integer/unsigned operations incl. ||, &amp;&amp;. Also if, while </span></span><br><span class="line"><span class="comment"> *   Max ops: 30 </span></span><br><span class="line"><span class="comment"> *   Rating: 4</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="title function_">floatPower2</span><span class="params">(<span class="type">int</span> x)</span> &#123;</span><br><span class="line">    <span class="type">int</span> bias = <span class="number">127</span>;</span><br><span class="line">    <span class="type">int</span> <span class="built_in">exp</span> = (x + bias)&lt;&lt;<span class="number">23</span>;  <span class="comment">// x = exp - bias</span></span><br><span class="line">    <span class="type">int</span> f = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (x &lt; <span class="number">-127</span>) &#123;              <span class="comment">// too small(exp are all 0s that is Subnormal)</span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (x &gt; (<span class="number">255</span><span class="number">-127</span>)) &#123;  <span class="comment">// too large(the floating point number is larger than INF that exp are all 1s)</span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">0x7f800000</span>;         <span class="comment">// +INF</span></span><br><span class="line">    &#125;</span><br><span class="line">    f |= <span class="built_in">exp</span>;    <span class="comment">// normalize</span></span><br><span class="line">    <span class="keyword">return</span> f;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></p>
<h3 id="运行结果">运行结果</h3>
<p><img src="https://pic4.zhimg.com/80/v2-21774eab522096e708d883dc09a4aa25.png" alt="./btest" /> <img src="https://pic4.zhimg.com/80/v2-96d0c54113a6951eed5fe3cbfbba5b5a.png" alt="./dlc" /></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://mitmoksha.github.io/2022/05/16/6-NULL-Video-Note/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Pishun Huang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Moksha's Blog">
      <meta itemprop="description" content="Opportunities are ready for it, the more to beat action.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Moksha's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/16/6-NULL-Video-Note/" class="post-title-link" itemprop="url">6.NULL Video Note</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-16 17:26:09" itemprop="dateCreated datePublished" datetime="2022-05-16T17:26:09+08:00">2022-05-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-05-18 09:18:09" itemprop="dateModified" datetime="2022-05-18T09:18:09+08:00">2022-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/6-NULL/" itemprop="url" rel="index"><span itemprop="name">6.NULL</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <span id="more"></span>
<h1 id="null-video-note">6.NULL Video Note</h1>
<h2 id="video-1-the-shell"><strong>VIDEO 1</strong> The Shell</h2>
<ol type="1">
<li><code>cd -</code>将会在和上一次cd的目录来回切换</li>
<li><code>rm</code>命令默认非递归的删除，因此删除目录时需要加上-r参数(recursive)，才能完整地将目录下的文件删除;而rmdir只能删除空目录</li>
<li>解释一下常用命令的含义<code>pwd</code>(print work directory), <code>cd</code>(change directory)</li>
<li>-表示当前没有允许的权限。d表示目录，注意目录的x位表示当前能够访问该目录的内容，且需要保证当前目录的父目录都含有x位才能访问。</li>
<li>redirect, &lt; 表示重定向输入, &gt; 表示重定向输出. Some example: <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">missing:~$ <span class="built_in">echo</span> hello &gt; hello.txt</span><br><span class="line">missing:~$ <span class="built_in">cat</span> hello.txt</span><br><span class="line">hello</span><br><span class="line">missing:~$ <span class="built_in">cat</span> &lt; hello.txt</span><br><span class="line">hello</span><br><span class="line">missing:~$ <span class="built_in">cat</span> &lt; hello.txt &gt; hello2.txt</span><br><span class="line">missing:~$ <span class="built_in">cat</span> hello2.txt</span><br><span class="line">hello</span><br></pre></td></tr></table></figure> <code>&gt;&gt;</code>表示追加(append)</li>
<li><code>ctrl+L</code>清空终端的命令，返回到顶部。</li>
<li><code>tail -n</code>将数据中的末尾n行显示出来。</li>
<li>pipe，将两个不相关联的程序连接起来通过input/output连接起来,管道的左边作为一个input, 管道的右边作为一个output。</li>
<li><code>$</code>表示当前运行在用户模式下; <code>#</code>表示当前运行在系统模式下,可以通过命令<code>sudo su</code>来打开root下的terminal.</li>
<li>xdg-open命令可以打开文件对应的格式</li>
<li>double quotes: backslash, <code>\</code>前面加个<code>!</code>就不会被默认移除</li>
<li>shebang是由脚本开头的字符数字符号和感叹号<code>#!</code>组成的字符序列。当带有shebang的文本文件被用作类Unix操作系统的"可执行文件"时，程序加载器机制将文件初始行的其余部分解析为"解释器指令"。它告诉内核用什么来运行此脚本(比如说python or shell?)</li>
</ol>
<h2 id="video-2-shell-tools-and-scripting"><strong>VIDEO 2</strong> Shell Tools and Scripting</h2>
<ol type="1">
<li>different from the single quote<code>(')</code> and double quote<code>(")</code>. echo ""中解析出变量放变量(用<code>$</code>符号来表示)。而单引号不会解析变量。</li>
<li><ul>
<li><code>$1</code>到<code>$9</code>表示argv中第一个到第九个参数</li>
<li><code>$0</code>表示脚本的名字</li>
<li><code>$_</code>(undersocre)表示上一个command的最后一个参数</li>
<li><code>$?</code>(question mark)获取上一个command的error code(一般值为<code>0</code>表示ok, <code>1</code>表示执行出错)。</li>
<li><code>$#</code>(hash)表示参数的个数</li>
<li><code>$$</code>表示当前进程的ID</li>
<li><code>$@</code>表示所有参数。</li>
</ul></li>
<li><code>!!</code>(bang)代替上一次执行过的command，比如说创建一个目录<code>mkdir ..</code>没有权限，这时候只需要<code>sudo !!</code>, 就会默认表示<code>sudo mkdir ..</code>从而减少了一些重复性的工作。</li>
<li>;(semicolon)分号可以连接任何命令行。<code>false ; echo "haha"</code></li>
<li>脚本中变量用双引号引起来<code>"$1"</code>.</li>
<li>执行脚本<code>source ..</code></li>
<li>globbing, *(asterisk), {}(curly braces)</li>
<li><code>tldr</code>(too long, don't read), 精简版带example的man</li>
<li><code>test</code>, 查看man手册</li>
<li><strong>查找文件</strong>:</li>
</ol>
<ul>
<li><code>find</code>查看man手册 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查找所有名称为src的文件夹</span></span><br><span class="line">find . -name src -<span class="built_in">type</span> d</span><br><span class="line"><span class="comment"># 查找所有文件夹路径中包含test的python文件</span></span><br><span class="line">find . -path <span class="string">&#x27;*/test/*.py&#x27;</span> -<span class="built_in">type</span> f</span><br><span class="line"><span class="comment"># 查找前一天修改的所有文件</span></span><br><span class="line">find . -mtime -1</span><br><span class="line"><span class="comment"># 查找所有大小在500k至10M的tar.gz文件</span></span><br><span class="line">find . -size +500k -size -10M -name <span class="string">&#x27;*.tar.gz&#x27;</span></span><br><span class="line"><span class="comment"># 删除全部扩展名为.tmp 的文件</span></span><br><span class="line">find . -name <span class="string">&#x27;*.tmp&#x27;</span> -<span class="built_in">exec</span> <span class="built_in">rm</span> &#123;&#125; \;</span><br><span class="line"><span class="comment"># 查找全部的 PNG 文件并将其转换为 JPG</span></span><br><span class="line">find . -name <span class="string">&#x27;*.png&#x27;</span> -<span class="built_in">exec</span> convert &#123;&#125; &#123;&#125;.jpg \;</span><br></pre></td></tr></table></figure></li>
<li><a target="_blank" rel="noopener" href="https://github.com/sharkdp/fd">fd</a>, find的替代物</li>
<li><code>locate</code>, 只能通过文件名，但速度很快。locate(1)当您只是尝试按名称查找特定文件时会更好，该文件您知道存在，但您只是不记得它的确切位置。find(1)当您有一个重点领域需要检查时，或者当您需要其众多优势中的任何一个时，效果会更好</li>
</ul>
<ol start="11" type="1">
<li><code>shellcheck</code>检查shell脚本的语法。</li>
<li><strong>查找代码</strong>:
<ul>
<li><code>grep</code></li>
<li><a target="_blank" rel="noopener" href="https://beyondgrep.com/">awk</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/BurntSushi/ripgrep">rg</a>(ripgrep) <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查找所有使用了 requests 库的文件</span></span><br><span class="line">rg -t py <span class="string">&#x27;import requests&#x27;</span></span><br><span class="line"><span class="comment"># 查找所有没有写 shebang 的文件（包含隐藏文件）</span></span><br><span class="line">rg -u --files-without-match <span class="string">&quot;^#!&quot;</span></span><br><span class="line"><span class="comment"># 查找所有的foo字符串，并打印其之后的5行</span></span><br><span class="line">rg foo -A 5</span><br><span class="line"><span class="comment"># 打印匹配的统计信息（匹配的行和文件的数量）</span></span><br><span class="line">rg --stats PATTERN</span><br></pre></td></tr></table></figure></li>
</ul></li>
<li><strong>查找shell命令</strong>:</li>
</ol>
<ul>
<li><code>history</code></li>
<li><code>Ctrl+R</code>, backward search. 搭配<a target="_blank" rel="noopener" href="https://github.com/junegunn/fzf/wiki/Configuring-shell-key-bindings#ctrl-r">fzf</a></li>
</ul>
<ol start="14" type="1">
<li><strong>文件夹导航</strong>:
<ul>
<li><code>tree</code></li>
<li><code>broot</code></li>
<li><a target="_blank" rel="noopener" href="https://github.com/jarun/nnn">nnn</a>, 需要接下来去学习</li>
</ul></li>
<li>shell中使用变量需要加<code>""</code>(double quote), 当变量中含有命令时需要加括号比如<code>"$(pwd)"</code></li>
<li>进行比较时需要加<code>[[]]</code>双括号，比如说<code>if [[ n -eq 12 ]]; then</code>, <strong>注意</strong>括号左右要有空格否则出错。</li>
<li><a target="_blank" rel="noopener" href="https://linuxhint.com/bash_globbing_tutorial/">globbing</a></li>
</ol>
<h2 id="exercise2"><strong>Exercise2</strong></h2>
<ol type="1">
<li><p>ls</p>
<ol type="1">
<li>所有文件（包括隐藏文件<code>ls -a</code></li>
<li>文件打印以人类可以理解的格式输出 (例如，使用454M 而不是 454279954) <code>ls -hl</code></li>
<li>文件以最近访问顺序排序<code>ls -clt</code></li>
<li>以彩色文本显示输出结果<code>ls --color=always</code></li>
</ol></li>
<li><p>设计一个自动化shell。marco函数保存当前工作目录pwd到home目录的一个log文件中，polo函数通过打开log文件中的路径cd跳到之前所保存的目录中。</p>
<p>方法一: <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#! /usr/bin/env bash</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">marco</span></span>() &#123;</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;<span class="subst">$(pwd)</span>&quot;</span> &gt; <span class="string">&quot;<span class="variable">$HOME</span>/marco_history.log&quot;</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&quot;save pwd <span class="subst">$(pwd)</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">polo</span></span>() &#123;</span><br><span class="line">   <span class="built_in">cd</span> <span class="string">&quot;<span class="subst">$(cat $HOME/marco_history.log)</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure> <code>export</code>可以增加、修改或删除环境变量，仅效力于该次登陆的操作，和第一种方法的时效类似。</p>
<p>方法二: <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="function"><span class="title">marco</span></span>() &#123;</span><br><span class="line">   <span class="built_in">export</span> MARCO=$(<span class="built_in">pwd</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">polo</span></span>() &#123;</span><br><span class="line">   <span class="built_in">cd</span> <span class="string">&quot;<span class="variable">$MARCO</span>&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></li>
<li><p>shell表达式计算的格式为两个<code>(())</code>以及一些逻辑表达式的规范见<a target="_blank" rel="noopener" href="https://ss64.com/bash/syntax-brackets.html">此处</a>。关于给的test中的语句中<code>&gt;&amp;2</code>以及一些重定向的问题<a target="_blank" rel="noopener" href="https://askubuntu.com/questions/959066/what-does-mean-exactly-in-output-redirection">此处</a>给出了答案。<code>&gt;&amp;2</code>表示<code>2</code>是个文件描述符，不是<code>文件名</code>, 因为重定向的对象是文件名; <code>&amp;&gt;</code>则表示同时发送，比如<code>1&amp;&gt;2</code>表示标准输出和标准错误同时输出。</p>
<p>for循环的格式: <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#! /bin/bash</span></span><br><span class="line"></span><br><span class="line">count=1</span><br><span class="line"></span><br><span class="line"><span class="built_in">chmod</span> u=rwx ./test.sh</span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    ./test.sh 2&gt; out.log</span><br><span class="line">    <span class="keyword">if</span> [[ $? -ne 0 ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;failed after <span class="variable">$count</span> times&quot;</span></span><br><span class="line">        <span class="built_in">cat</span> out.log</span><br><span class="line">        <span class="built_in">break</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">   ((count++))</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure> shellcheck建议增加一行<code>mycmd=$?</code>, 用<code>mycmd</code>来代替<code>$?</code></p></li>
<li><p>利用xargs命令完成一些操作。xargs命令将标准输入的内容作为参数。<a target="_blank" rel="noopener" href="https://unix.stackexchange.com/questions/368753/what-does-this-command-with-a-backslash-at-the-end-do">此处</a>有关于<code>find</code>后的<code>/</code>的作用，目的是方便为了遇到换行符<code>\n</code>停止解析?? <code>tar</code>命令，压缩文件<code>tar -czvf</code>, 解压文件<code>tar -xzvf</code>, <code>-c</code>表示创建备份文件，<code>-x</code>表示从备份文件中还原文件。<code>-f</code>表示指定备份文件, <code>-v</code>表示显示verbose, <code>-z</code>表示<code>--gzip</code>或<code>--ungzip</code> 通过<code>gzip</code>指令处理备份文件。<code>xargs</code>的<code>-d</code>参数后面跟字符表示修改xargs的分隔符(默认为空白字符tab、空格、换行符)。</p>
<p>方法一, <code>xargs -d '\n'</code>指定输入遇到换行符结束:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find -name <span class="string">&#x27;*.html&#x27;</span> -<span class="built_in">type</span> f | xargs -d <span class="string">&#x27;\n&#x27;</span> tar -cxzf html.zip</span><br></pre></td></tr></table></figure>
<p>方法二, <code>find -print0</code>打印文件名到标准输出后后面自动跟个<code>null</code>; <code>xargs -0</code>输入遇到<code>null</code>则终止代替空格:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find -name <span class="string">&#x27;*.html&#x27;</span> -<span class="built_in">type</span> f -print0 | xargs -0 tar -cxzf html.zip</span><br></pre></td></tr></table></figure></li>
<li><p>找出当前文件夹下最近使用的文件, 并按照最近使用的时间列出文件 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find <span class="built_in">type</span> -f | xargs <span class="built_in">ls</span> -tl | head-1 </span><br></pre></td></tr></table></figure></p></li>
</ol>
<h2 id="video-3-editorsvim"><strong>VIDEO 3</strong> Editors(Vim)</h2>
<ol type="1">
<li><code>v</code>进入可视化模式; <code>V</code>进入可视化<strong>行模式</strong>; <code>^v</code>(<code>Ctrl + v</code>)进入可视化<strong>块模式</strong></li>
<li>Vim大量使用<code>Esc键</code>，因此建议将<code>大小写锁定键</code>设置为<code>Esc键</code>, 可以在ubuntu下使用<a target="_blank" rel="noopener" href="https://medium.com/@ahmaddynugroho/swap-caps-lock-and-escape-in-ubuntu-19-10-and-use-esc-easily-in-vim-vs-code-1d3d68f18764">gnome-tweaks</a>来配置交换修改大小写和Esc, 这里面同样介绍了VScode下的配置</li>
<li>Vim 会维护一系列打开的文件，称为“缓存<code>buffer</code>”。一个 Vim 会话包含一系列标签<code>tab</code>页，每个标签页包含 一系列窗口（分隔面板）。每个窗口显示一个缓存。</li>
<li><code>:qa</code>全部退出, <code>:wq</code>等价于<code>:x</code></li>
<li><code>:tabnew</code>;</li>
<li><code>:e &lt;文件名&gt;</code>打开要编辑的文件</li>
<li><ul>
<li><code>w</code>移动一个单词</li>
<li><code>b</code>回退一个单词</li>
<li><code>e</code>移动到单词末尾, 可以搭配<code>a</code>在光标之后插入文本。</li>
<li><code>^</code>移动到行首字符</li>
<li><code>$</code>移动到行尾字符</li>
<li><code>0</code>移动到行首字符前</li>
<li><code>^U</code>上翻页</li>
<li><code>^D</code>下翻页</li>
<li><code>gg</code>移动到最后一行</li>
<li>输入<code>number</code>+<code>G</code>则直接跳转到文件中的某一指定行。若不输入<code>number</code>则直接跳到文件第最后一行。</li>
<li><code>H</code>屏幕首行</li>
<li><code>M</code>屏幕中间</li>
<li><code>L</code>屏尾巴行</li>
</ul></li>
<li>[<code>f</code>|<code>F</code>|<code>t</code>|<code>T</code>][alpha], find和to功能来找到相应的字母</li>
<li><code>^g</code>显示当前编辑文件中当前光标所在行位置以及文件状态信息。</li>
<li><code>u</code>undo, <code>U</code>撤销在一行中做出的所有改动 ;<code>^r</code> redo</li>
<li><code>d</code>操作会将删除的内容放入vim中的寄存器中, 以便<code>p</code>操作时粘贴。
<ul>
<li><code>de</code>删除从光标处到单词尾</li>
<li><code>dw</code>删除一个单词</li>
<li><code>d</code>+上<code>hjkl</code>方向可以删除需要的内容</li>
</ul></li>
<li><code>c</code>change，功能类似于<code>d</code>，只是操作<code>c</code>会进入<code>insert</code>模式</li>
<li>在词尾插入<code>e</code>移动到词尾，随后<code>a</code>在当前词尾插入</li>
<li><code>x</code>删除当前光标所处的字符, 如果在可视模式下就删除选中部分</li>
<li><code>r</code>replace, 如<code>ra</code>将当前字符替换为a; <code>R</code>则可以连续替换多个字符。</li>
<li><code>y</code>yank, <code>p</code>paste, <code>yw</code> copy one word, 都可以搭配可视化<code>v</code>来使用。</li>
<li><code>~</code>改变字母的大小写</li>
<li><code>[num[h|j|k|l]</code>, 如<code>4j</code>向下移动四次</li>
<li>modifier, <code>i</code>指的是<code>inner</code>, <code>a</code>指的是<code>around</code>
<ul>
<li><code>ci(</code> 改变当前括号内的内容</li>
<li><code>ci[</code> 改变当前方括号内的内容</li>
<li><code>da'</code> 删除一个单引号字符串，包括周围的单引号</li>
</ul></li>
<li><code>%</code>在配对的括号(parenthese)如:<code>), ], &#125;</code>之间来回切换。在程序调试时用来找不配对的括号是很有用的。</li>
<li><code>/</code>后紧随一个字符串是在当前所编辑的文档中<code>正向查找</code>改字符串; <code>?</code>则与<code>/</code>相反，是反向查找。<code>:set ic</code>可以忽略大小写(<code>Ignore Case</code>)会在接下来的查找中持续, <code>:set noic</code>则忽略大小写; <code>:set hls</code>搜索时设置高亮显示, 移除匹配项的高亮显示<code>nohlsearch</code>; <code>:set is</code>(incsearch)查找短语时显示部分匹配, <code>:set noic</code>。</li>
<li><a target="_blank" rel="noopener" href="https://vimways.org/2019/">每日一个vim小技巧</a></li>
<li>安装并配置插件</li>
<li>Windows下映射CapsLock到ESC需要用到<code>autohotkey</code>脚本工具，添加语句<code>Capslock::Esc</code>即可</li>
<li><code>^o</code>回退到光标之前的位置，<code>^i</code>跳转到较新的位置。</li>
<li><code>s</code> is substitution. The first argument is search string, the second is replacement string.
<ul>
<li>输入<code>:s/old/new</code>则只将光标所在行的第一个串<code>old</code>修改为<code>new</code>-</li>
<li>输入<code>:s/old/new/g</code>则将全行的匹配串<code>old</code>修改为<code>new</code>。</li>
<li><code>:%s/old/new/g</code>则替换整个文件中的每个匹配串。</li>
<li><code>:%s/old/new/gc</code>则会在替换时询问。</li>
<li><code>:#,#s/old/new/g</code>其中<code>#, #</code>代表的是替换操作的若干行中首尾两行的行号</li>
</ul></li>
<li>在vim内执行外部命令的方法，输入<code>:!</code>然后紧接着输入外部的<code>shell</code>命令，如:<code>:!ls</code>，回车结束显示。</li>
<li>可以搭配可视模式将部分内容<code>:w &lt;filename&gt;</code>写到文件名中。</li>
<li>将磁盘文件内容提取到当前光标行<code>:r &lt;filename&gt;</code>.</li>
<li><code>:sp</code>分割窗口，<code>^w ^w</code>(double w)在窗口之间来回切换.</li>
<li><code>F1</code>或者<code>:help</code>打开帮助文档。下面这些参数可以得到该主题的帮助
<ul>
<li><code>:help w</code></li>
<li><code>:help c_CTRL-D</code></li>
<li><code>:help insert-index</code></li>
<li><code>:help user-manual</code>，阅读Vim的用户手册。</li>
</ul></li>
<li><code>.</code>(period)会完成重复性的工作。</li>
<li>vim命令的补全功能，例如输入<code>:e</code>, 然后按下<code>^D</code>键, Vim会显示以e开始的命令的列表, 接着按下<code>&lt;tab&gt;键</code>会自动自动补全命令。</li>
<li><code>q:</code> | <code>q?</code>查看vim中的历史命令</li>
<li>从vim8.0版本开始安装插件只需要将插件<code>git clone</code>到<code>~/.vim/pack/vendor/start/</code>文件里就行。</li>
</ol>
<h2 id="exercise3"><strong>Exercise3</strong></h2>
<ol type="1">
<li><code>vimtutor</code></li>
<li><ul>
<li>创建文件<code>~/.vimrc</code>能够获得更多的特性。了解更多信息可以输入<code>:help vimrc-intro</code></li>
<li>文件中注释使用<code>"</code></li>
<li><code>set nocompatible</code>从默认的<code>Vi</code>兼容模式切换到激活<code>Vim</code>的功能。如果<code>vimrc</code>文件存在它就会默认设置<code>nocompatible</code>, 包含这一条语句是为了以防以一些别的方式加载配置文件。</li>
<li><code>syntax on</code>打开语法高亮</li>
<li><code>set shortmess+=I</code>禁止Vim默认的启动信息<code>:intro</code>，也就是解释vim的版本，以及该如何使用。</li>
<li><code>set number</code>在vim中显示行数</li>
<li><code>set relativenumber</code>显示与当前行的行号和与其相对的行号，其实<code>set number</code>也可以不用加了</li>
<li><code>set laststatus=2</code>在vim底部显示当前状态。<code>2</code>表示不管存在几个窗口总是显示状态栏。</li>
<li><code>set backspace=indent,eol,start</code>。设置backspace的属性，感觉好像vim兼容了对默认情况，经过测试这一行语句似乎没有什么实质性的作用。</li>
<li><code>set hidden</code>可以告诉Vim你拥有未显示在屏幕上未保存的工作, 多一条提示信息。</li>
<li><code>set ignorecase</code>不区分大小写</li>
<li><code>set smartcase</code>只能在<code>ignorecase</code>，它会使得区分大小写更智能。</li>
<li><code>incsearch</code>使用<code>/</code>搜索时会实时搜索，而不是等到Enter键按下时才进行搜索。</li>
<li><code>nmap Q &lt;Nop&gt;</code>对按键Q的解绑操作，按键Q会进入Ex mode, <code>&lt;Nop&gt;</code>意为无操作, 且<code>nmap</code>和<code>nnoremap</code>是等价的。<code>nmap</code>是在Normal模式下使用，详情可见<code>:h map-modes</code>。</li>
<li><code>set noerrorbells visualbell t_vb=</code>, disable Vim的bell beeping。</li>
<li><code>set mouse+=a</code>鼠标支持, 方便进入可视化选择。<code>a</code>表示all previous modes。应用在vim中的所有五个模式。</li>
<li><code>nmap &lt;Left&gt; :echoe "Use h"&lt;CR&gt;</code>来使用户养成在Normal模式下使用h来左移的习惯。</li>
<li><code>imap &lt;Left&gt; &lt;ESC&gt;:echoe "Use h"&lt;CR&gt;</code>来使用户养成在Insert模式下使用h来左移的习惯，若在Insert模式下使用方向键Left，则回到Normal模式并提示信息"Use h"。因为Vim中的命令行换行是以<code>CR</code>来结尾的(也就是敲完命令需要敲回车换行)才能执行该echo命令回显信息, <code>echoe</code>回显的是错误信息，会加上红色高亮。</li>
</ul></li>
<li>如果创建多级目录的路径不存在则自动创建<code>mkdir -p</code>使用参数<code>p</code>。安装和配置插件内含帮助文档<a target="_blank" rel="noopener" href="https://github.com/ctrlpvim/ctrlp.vim/blob/master/readme.md">ctrlp.vim</a>
<ul>
<li><code>^P</code>打开模糊搜索</li>
<li><code>c-d</code>切换搜索路径和文件的模式</li>
<li><code>c-t</code>打开该文件作为新的tab; <code>c-v</code>打开该文件分割列; <code>c-x</code>打开该文件分割行; 个人认为这些tmux都可以替代。</li>
<li><code>c-n</code>和<code>c-p</code>选择next/previous在ctrlp中的搜索记录</li>
<li>在ctrlp中输入<code>:help ctrlp-mappings</code>查看更多映射的帮助</li>
<li>查找到文件后加<code>:25</code>即可跳到该文件的25行</li>
</ul></li>
<li>使用Chrome上的<code>vimium</code>有关Vim的插件。
<ul>
<li><code>j</code>和<code>k</code>上下移动网页, <code>d</code>和<code>u</code>以翻页的形式上下移动网页, <code>h</code>和<code>l</code>左右移动网页</li>
<li>同样可以像vim一样前缀加上数字，比如<code>4j</code>等。也可以<code>gg</code>跳至网页头和<code>G</code>跳至网页尾</li>
<li><code>f</code>通过标签打开当前网页超链接到当前的tab上，<code>F</code>则打开到新的tab上。</li>
<li>当前tab历史的前进<code>L</code>和回退<code>H</code></li>
<li>在打开的网页tab之间切换，上一个<code>J</code>, 下一个<code>K</code></li>
<li>关闭当前标签页<code>x</code>, <code>X</code>恢复关闭的tab</li>
<li>在历史标签中搜索<code>o</code>，<code>ESC</code>退出</li>
<li>若标签页太多,可以使用<code>T</code>在已有的标签之中搜索，<code>ESC</code>退出</li>
<li><code>?</code>打开<code>Vimium</code>的帮助文档。</li>
<li><code>r</code>(Reload)刷新当前网页</li>
<li><code>yy</code>将当前的URL复制到剪切板，<code>p</code>将剪切板上的URL在当前tab中打开，<code>P</code>则在新的tab中打开</li>
<li><code>gi</code>将光标焦距到当前网页的第一个输入栏(即搜索栏)</li>
<li><code>b</code>搜索书签打开到当前tab，<code>B</code>打开到新的tab中</li>
<li><code>/</code>在当前网页中使用匹配， 搭配<code>n</code>和<code>N</code></li>
<li><code>t</code>创建新的tab</li>
<li><code>alt+p</code>，pin和unpin当前tab</li>
<li><code>alt+m</code>, 静音和解除静音当前tab</li>
</ul></li>
<li>(待做)<code>XML</code>转<code>JSON</code> , <code>:wq</code>等价于<code>:x</code> ## <strong>VIDEO 4</strong> Data Wangling (TODO)</li>
<li>正则表达式通常以<code>/</code>开始和结束。正则表达式在线调试工具<a target="_blank" rel="noopener" href="https://regex101.com/r/qqbZqh/2">regex debugger</a>
<ul>
<li><code>.</code>除换行符之外的"任意单个字符"</li>
<li><code>*</code>匹配前面字符零次或多次</li>
<li><code>+</code>匹配前面字符一次或多次</li>
<li><code>[abc]</code>匹配<code>a</code>,<code>b</code>和<code>c</code>中任意一个, 在括号中使用<code>^</code>即为非</li>
<li><code>(RX1|RX2)</code>任何能够匹配<code>RX1</code>或<code>RX2</code>的结果</li>
<li><code>^</code>行首</li>
<li><code>$</code>行尾</li>
</ul></li>
<li><code>sed</code>命令
<ul>
<li><code>-E</code>参数支持对正则表达式的拓展</li>
</ul></li>
<li><code>uniq</code>命令去除重复行
<ul>
<li><code>-c</code>参数输出过滤后的行数</li>
</ul></li>
<li><code>sort</code>命令按照数字顺序对输入进行排序(默认情况下是按照字序列排序)
<ul>
<li><code>-r</code>参数进行倒序排序</li>
<li><code>-n</code>参数表示仅排序到第<code>n</code>个部分</li>
</ul></li>
<li><code>awk</code>编辑器, <code>awk</code>其实是一种编程语言具体可以查看<code>man awk</code>和<code>tldr awk</code></li>
<li>学习一下<a target="_blank" rel="noopener" href="https://regexone.com/lesson/introduction_abcs">交互式正则表达式教程</a></li>
</ol>
<h2 id="video-6-version-controlgit"><strong>VIDEO 6</strong> Version Control(Git)</h2>
<ol type="1">
<li>Git中的对象可以是blob(数据对象)、Tree或Commit</li>
<li>所有的snapshot都可以用<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/SHA-1">SHA-1哈希</a>(40位的十六进制字符)来标记，但显然<code>Reference</code>更方便。</li>
<li><code>HEAD</code>引用可以通过两种方式查看, <code>cat .git/HEAD</code>; <code>git symbolic-ref HEAD</code>。</li>
<li><strong>基础</strong>
<ul>
<li><code>git help &lt;command&gt;</code>:获取git命令的帮助信息</li>
<li><code>git init</code>:创建一个新的git仓库，其数据会存放在一个名为<code>.git</code>的目录下</li>
<li><code>git status</code>:显示当前仓库的状态</li>
<li><code>git add &lt;filename&gt;</code>:添加文件到暂存区(staging Area)</li>
<li><code>git commit</code>:创建一个新的提交; 如何编写<a target="_blank" rel="noopener" href="https://tbaggery.com/2008/04/19/a-note-about-git-commit-messages.html">良好的提交信息</a>, 为什么要<a target="_blank" rel="noopener" href="https://cbea.ms/git-commit/">编写良好的提交信息</a></li>
<li><code>git</code>的提交信息
<ol type="1">
<li>用空行将主体与主体分开</li>
<li>将主题行限制为50个字符</li>
<li>将主题行大写</li>
<li>不要以句点结束主题行</li>
<li>在主题行中使祈使句语句</li>
<li>将正文包裹在72个字符处</li>
<li>用正文来解释<code>what</code> <code>why</code> vs. <code>how</code></li>
</ol></li>
<li><code>git log</code>:显示日志历史</li>
<li><code>git log --all --graph --decorate</code>:可视化历史记录(有向无环图)</li>
<li><code>git diff &lt;filename&gt;</code>:显示与暂存区文件的差异</li>
<li><code>git diff &lt;revision&gt; &lt;filename&gt;</code>:显示某个文件两个版本之间的差异</li>
<li><code>git checkout &lt;revision&gt;</code>:更新HEAD和目前的分支</li>
</ul></li>
<li><strong>分支和合并</strong>
<ul>
<li><code>git branch</code>:显示分支</li>
<li><code>git branch &lt;name&gt;</code>:创建分支</li>
<li><code>git checkout -b &lt;name&gt;</code>:创建分支并切换到该分支, 相当于<code>git branch &lt;name&gt;; git checkout &lt;name&gt;</code></li>
<li><code>git merge &lt;revision&gt;</code>:合并到当前分支</li>
<li><code>git mergetool</code>:使用工具来处理合并冲突</li>
<li><code>git rebase &lt;name&gt;</code>:创建更线性的提交历史</li>
</ul></li>
<li><strong>远端操作</strong>
<ul>
<li><code>git remote</code>:列出远端</li>
<li><code>git remote add &lt;name&gt; &lt;url&gt;</code>:添加一个远端</li>
<li><code>git push &lt;remote&gt; &lt;local branch&gt;:&lt;remote branch&gt;</code>:将对象传送至远端并更新远端引用</li>
<li><code>git branch --set-upstream-to=&lt;remote&gt;/&lt;remote branch&gt;</code>:创建本地和远端分支关联关系</li>
<li><code>git fetch</code>:从远端获取对象</li>
<li><code>git pull</code>:相当于<code>git fetch; git merge</code></li>
<li><code>git clone &lt;url&gt; &lt;name&gt;</code>:从远端下载仓库并命名为name</li>
</ul></li>
<li><strong>撤销</strong>
<ul>
<li><code>git commit --amend</code>:编辑提交的内容或信息</li>
<li><code>git reset HEAD &lt;file&gt;</code>:恢复暂存的文件</li>
<li>`git checkout -- <file>:丢弃修改</li>
</ul></li>
<li><strong>Git高级操作</strong>
<ul>
<li><code>git config</code>:Git是一个<a target="_blank" rel="noopener" href="https://git-scm.com/docs/git-config">高度可定制</a>的工具</li>
<li><code>git clone --depth=1</code>:浅克隆(shallow clone), 不包括完整的版本历史信息</li>
<li><code>git add -p</code>:交互式暂存</li>
<li><code>git blame</code>:查看最后修改某行的人</li>
<li><code>git stash</code>:暂时移除工作目录下的修改内容</li>
<li><code>git stash pop</code>:恢复工作目录下的修改内容</li>
<li><code>git bisect</code>:通过二分查找搜索历史记录</li>
<li><code>.gitignore</code>:<a target="_blank" rel="noopener" href="https://git-scm.com/docs/gitignore">指定</a>故意不追踪的文件</li>
</ul></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://mitmoksha.github.io/2022/05/16/Makefile-Note/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Pishun Huang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Moksha's Blog">
      <meta itemprop="description" content="Opportunities are ready for it, the more to beat action.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Moksha's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/16/Makefile-Note/" class="post-title-link" itemprop="url">Makefile Note</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-16 17:24:07" itemprop="dateCreated datePublished" datetime="2022-05-16T17:24:07+08:00">2022-05-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-05-18 09:16:04" itemprop="dateModified" datetime="2022-05-18T09:16:04+08:00">2022-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Computer-Science-Notes/" itemprop="url" rel="index"><span itemprop="name">Computer Science Notes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <span id="more"></span>
<h1 id="makefile-note">Makefile Note</h1>
<p>参考<a target="_blank" rel="noopener" href="https://seisman.github.io/how-to-write-makefile/introduction.html">跟我一起写Makefile</a>做点笔记。 - 第一个<code>target</code>为<code>make</code>的默认目标 - <code>prerequisites</code>中如果有一个以上的文件比<code>target</code>文件要新的话，<code>command</code>所定义的命令就会被执行 <figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">target ... : prerequisites ...</span><br><span class="line">    command</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure> - 最开始的实例 <figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">edit : main.o kbd.o command.o display.o \</span><br><span class="line">        insert.o search.o files.o utils.o</span><br><span class="line">    cc -o edit main.o kbd.o command.o display.o \</span><br><span class="line">        insert.o search.o files.o utils.o</span><br><span class="line"></span><br><span class="line">main.o : main.c defs.h</span><br><span class="line">    cc -c main.c</span><br><span class="line">kbd.o : kbd.c defs.h command.h</span><br><span class="line">    cc -c kbd.c</span><br><span class="line">command.o : command.c defs.h command.h</span><br><span class="line">    cc -c command.c</span><br><span class="line">display.o : display.c defs.h buffer.h</span><br><span class="line">    cc -c display.c</span><br><span class="line">insert.o : insert.c defs.h buffer.h</span><br><span class="line">    cc -c insert.c</span><br><span class="line">search.o : search.c defs.h buffer.h</span><br><span class="line">    cc -c search.c</span><br><span class="line">files.o : files.c defs.h buffer.h command.h</span><br><span class="line">    cc -c files.c</span><br><span class="line">utils.o : utils.c defs.h</span><br><span class="line">    cc -c utils.c</span><br><span class="line">clean :</span><br><span class="line">    rm edit main.o kbd.o command.o display.o \</span><br><span class="line">        insert.o search.o files.o utils.o</span><br></pre></td></tr></table></figure> - 为了复用可以在<code>Makefile</code>中使用<code>shell</code>的变量 <figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">objects = main.o kbd.o command.o display.o \</span><br><span class="line">    insert.o search.o files.o utils.o</span><br><span class="line"></span><br><span class="line">edit : <span class="variable">$(objects)</span></span><br><span class="line">    cc -o edit <span class="variable">$(objects)</span></span><br><span class="line">main.o : main.c defs.h</span><br><span class="line">    cc -c main.c</span><br><span class="line">kbd.o : kbd.c defs.h command.h</span><br><span class="line">    cc -c kbd.c</span><br><span class="line">command.o : command.c defs.h command.h</span><br><span class="line">    cc -c command.c</span><br><span class="line">display.o : display.c defs.h buffer.h</span><br><span class="line">    cc -c display.c</span><br><span class="line">insert.o : insert.c defs.h buffer.h</span><br><span class="line">    cc -c insert.c</span><br><span class="line">search.o : search.c defs.h buffer.h</span><br><span class="line">    cc -c search.c</span><br><span class="line">files.o : files.c defs.h buffer.h command.h</span><br><span class="line">    cc -c files.c</span><br><span class="line">utils.o : utils.c defs.h</span><br><span class="line">    cc -c utils.c</span><br><span class="line">clean :</span><br><span class="line">    rm edit <span class="variable">$(objects)</span></span><br></pre></td></tr></table></figure> - <code>make</code>会自动推导命令，只要<code>Make</code>看到一个<code>.o</code>文件，它就会自动地把<code>.c</code>文件加在依赖关系中。并且command <code>cc -c xxx.c</code>也会被自动推导出来 <figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">objects = main.o kbd.o command.o display.o \</span><br><span class="line">    insert.o search.o files.o utils.o</span><br><span class="line"></span><br><span class="line">edit : <span class="variable">$(objects)</span></span><br><span class="line">    cc -o edit <span class="variable">$(objects)</span></span><br><span class="line"></span><br><span class="line">main.o : defs.h</span><br><span class="line">kbd.o : defs.h command.h</span><br><span class="line">command.o : defs.h command.h</span><br><span class="line">display.o : defs.h buffer.h</span><br><span class="line">insert.o : defs.h buffer.h</span><br><span class="line">search.o : defs.h buffer.h</span><br><span class="line">files.o : defs.h buffer.h command.h</span><br><span class="line">utils.o : defs.h</span><br><span class="line"></span><br><span class="line">.PHONY : clean</span><br><span class="line">clean :</span><br><span class="line">    rm edit <span class="variable">$(objects)</span></span><br></pre></td></tr></table></figure></p>
<ul>
<li>更稳健的<code>clean</code>写法: <figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.PHONY : clean <span class="comment"># `.PHONY`表示`clean`是个伪目标文件</span></span><br><span class="line">clean :</span><br><span class="line">    -rm edit <span class="variable">$(objects)</span></span><br></pre></td></tr></table></figure></li>
<li><code>Makefile</code>中主要包含的五部分:
<ul>
<li>显示规则, 显式规则说明了如何生成一个或多个目标文件。这是由Makefile的书写者明显指出要生成的文件、文件的依赖文件和生成的命令。</li>
<li>隐晦规则, 由于我们的make有自动推导的功能，所以隐晦的规则可以让我们比较简略地书写 Makefile，这是由make所支持的。</li>
<li>变量的定义</li>
<li>文件指示, 即<code>Makefile</code>可以使用<code>include</code>将其他makefile包含进来。<code>filename</code>可以用一个或多个空格隔开。如: <code>include foo.make a.mk b.mk c.mk e.mk f.mk</code>。</li>
<li>注释，和shell一样使用<code>#</code>。</li>
</ul></li>
<li><code>make</code>命令开始时，会寻找<code>include</code>所指出的其它<code>Makefile</code>，并把其内容安置在当前的位置。如果还没找到则在当前目录找。如果还是没找到则在以下几个目录找:
<ul>
<li>make命令开始时，会找寻 include 所指出的其它Makefile，并把其内容安置在当前的位置</li>
<li>如果目录 <prefix>/include （一般是： /usr/local/bin 或 /usr/include ）存在的话，make也会去找。</li>
</ul>
如果还没找到则会生成警告信息，随后报错。可以在前面加个减号<code>-include &lt;filename&gt;</code>来告诉make无论出现什么错误，都不要报错，继续执行。</li>
<li>GNU的make工作时的执行步骤:
<ol type="1">
<li>读入所有的Makefile。</li>
<li>读入被include的其它Makefile。</li>
<li>初始化文件中的变量。</li>
<li>推导隐晦规则，并分析所有规则。</li>
<li>为所有的目标文件创建依赖关系链。</li>
<li>根据依赖关系，决定哪些目标要重新生成。</li>
<li>执行生成命令。</li>
</ol></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://mitmoksha.github.io/2022/05/16/vim-vscode-tmux-gdb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Pishun Huang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Moksha's Blog">
      <meta itemprop="description" content="Opportunities are ready for it, the more to beat action.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Moksha's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/16/vim-vscode-tmux-gdb/" class="post-title-link" itemprop="url">vim+vscode+tmux+gdb</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-16 17:09:48" itemprop="dateCreated datePublished" datetime="2022-05-16T17:09:48+08:00">2022-05-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-05-18 09:16:36" itemprop="dateModified" datetime="2022-05-18T09:16:36+08:00">2022-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Computer-Science-Notes/" itemprop="url" rel="index"><span itemprop="name">Computer Science Notes</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <span id="more"></span>
<h1 id="vimvscodetmuxgdbgit">vim+vscode+tmux+gdb+git</h1>
<p>个人的一些认为比较常用以及不经常用到的的快捷操作 ## <strong>vscode</strong> 1. 查找文件ctrl+p， esc退出 2. 分割屏幕ctrl+，通过ctrl+1/2/3来切换分割屏幕的焦点 3. ctrl+` 打开/关闭终端 4. ctrl+tab, 在tab之间切换 5. 模糊查找当前工作目录下的所有文件ctrl+p, # 6. Ctrl + Shift + Tab 导航tab 7. alt + &lt;-/-&gt;切换tab</p>
<h2 id="vim"><strong>vim</strong></h2>
<ol type="1">
<li>跳转到指定行号n, ngg</li>
<li>复制整行 yy, 复制包括当前行接下来n行， nyy</li>
<li>复制指定行v模式下指定复制内容，然后y键复制。</li>
<li>粘贴 如复制内容不是一整行：p粘贴到当前光标处，P粘贴到当前行首。 如复制内容是一整行：p粘贴到当前行的下一行，P粘贴到当前行的上一行</li>
<li>剪切dd</li>
<li>在当前文件查找指定内容，/+内容</li>
<li>ctrl+] 跳转到函数的定义处，ctrl+t返回上一次光标处</li>
<li>u撤销，ctrl+r恢复</li>
<li><code>^y</code>向上移动一行, <code>^e</code>向下移动一行</li>
<li><code>^b</code>向上移动一页，<code>^f</code>向下移动一页</li>
<li>number + shift + G, 跳到第number行</li>
<li>在<code>tab</code>之间切换, <code>Alt</code>+<code>number</code>.</li>
<li>可视条件下选中后<code>&lt;</code>或<code>&gt;</code>完成缩进。</li>
<li>要想跳转到函数定义处，需要在项目目录中输入<code>ctags -R</code>命令。<code>ctrl+]</code>跳转, <code>ctrl+o</code>返回。</li>
<li>可视模式下注释+<code>d</code>。</li>
<li>替换变量名<code>:%s/foo/bar/g</code>将整个文件中的<code>foo</code>替换为<code>bar</code></li>
<li>在vim文件内使用shell命令<code>:! command</code></li>
<li>在当前文件中打开另一个文件<code>:e file</code></li>
<li>在Vim中编译代码<code>:!gcc %</code>, 编译并运行代码<code>:!gcc % || ./a.out</code></li>
</ol>
<h2 id="tmux"><strong>tmux</strong></h2>
<ol type="1">
<li>任何命令都需要加ctrl+b前缀</li>
<li>c创建窗口；n, p切换窗口</li>
<li>%垂直分屏, "水平分屏</li>
<li>x关闭窗口</li>
<li>o在窗口之间切换</li>
<li>PgUp开启tmux终端界面的翻页，q退出。</li>
</ol>
<h2 id="gdb"><strong>gdb</strong></h2>
<ol type="1">
<li>delete 删除所有断点</li>
<li>layout src/reg/asm 显示c源代码、寄存器和汇编，但未分屏；focus src/reg/asm在src、reg和asm的tui中来回切换</li>
<li>layout split获得c和asm的分屏。</li>
<li>info/i frame 查看栈帧, info/i args查看传递给main的参数, i locals显示当前的本地变量。</li>
<li>通过backtrace查看栈帧，frame n(n为bt结果的栈帧号)，然后i frame查看当前栈帧号的详细内容</li>
<li>print/p查看argv数据;print/p <em>argv(默认打印一个参数);可以通过print/p </em>argv@n 来选择argv数组中的n个元素即参数; p *argv@argc打印所有参数</li>
<li><code>print</code>是打印值，<code>x</code>是访问主存。</li>
<li><code>Ctrl + x</code>，再按1：单窗口模式，显示一个窗口</li>
<li><code>Ctrl + x</code>，再按2：双窗口模式，显示两个窗口</li>
<li><code>Ctrl + x</code>，再按a：回到传统模式，即退出layout，回到执行layout之前的调试窗口。</li>
<li><code>^x+a</code>关闭可视化</li>
<li><code>wa</code>跟踪某个变量(watch point)</li>
</ol>
<h2 id="gdb续"><strong>&lt;<Debug Hacks>&gt;(gdb续)</strong></h2>
<ol type="1">
<li><code>break/b</code>
<ul>
<li><code>break 函数名</code></li>
<li><code>break 行号</code></li>
<li><code>break 文件名:行号</code></li>
<li><code>break 文件名:函数名</code></li>
<li><code>break +偏移量</code></li>
<li><code>break -偏移量</code></li>
<li><code>break *地址</code></li>
<li><code>break 断点 if 条件</code></li>
<li>若不指定位置就默认在下一行代码上设置断点</li>
<li><code>info break</code>显示断点信息</li>
</ul></li>
<li><code>run/r</code>, 如果不加参数，执行到断点位置后暂停运行(和start命令一样的效果)</li>
<li><code>print/p</code>
<ul>
<li><code>p $eax</code>，显示寄存器(寄存器名前加$)</li>
</ul></li>
<li><code>p/格式 变量</code>, 显示寄存器可用的格式:
<ul>
<li>x, 显示为十六进制数</li>
<li>d, 显示为十进制数</li>
<li>u, 显示无符号十进制数</li>
<li>o, 显示八进制数</li>
<li>t, 显示二进制数(two)</li>
<li>a, 显示地址</li>
<li>c, 显示为字符</li>
<li>f, 浮点小数</li>
<li>s, 显示为字符串</li>
<li>i, 显示为机器语言</li>
</ul></li>
<li><code>x/NFU ADDR</code>, 显示内存的内容(eXamining):
<ul>
<li><code>N</code>为重复次数</li>
<li><code>F</code>为上述的P格式</li>
<li><code>U</code>代表的单位：
<ul>
<li>b, 字节</li>
<li>h, 半字</li>
<li>w, 字(4字节默认)</li>
<li>g, 双字</li>
</ul></li>
</ul></li>
</ol>
<h2 id="cgdb"><strong>cgdb</strong></h2>
<ol type="1">
<li>使用<code>i</code>切换到<code>GDB command</code>，<code>esc</code>切换到<code>source window</code>。</li>
<li>在<code>source window</code>下，可以像<code>vim</code>一样用<code>\</code>匹配内容， 且移动到指定行按下<code>space</code>可以可视化打断点。</li>
<li><code>q</code>或者<code>^c+d</code>退出<code>gdb</code></li>
<li>调整<code>source window</code>的大小, <code>-</code>缩小一行，<code>=</code>增加一行。</li>
<li>在<code>source window</code>下<code>^w</code>窗口水平竖直分割切换。</li>
<li><code>F5</code> = <code>run</code>, <code>F6</code> = <code>continue</code>, <code>F7</code> = <code>finish</code>, <code>F8</code> = <code>next</code>, <code>F10</code> = <code>step</code>。</li>
<li><code>CGDB</code>的配置, 在<code>~/.cgdb/</code>目录下创建<code>cgdbrc</code>文件并编辑。如果<code>cgdbrc</code>文件存在，<code>CGDB</code>就会执行该文件中的每一行。
<ul>
<li><code>:set disasm</code>，以汇编语言的形式显示。</li>
<li><code>:set hls</code>，高亮显示匹配到的字符串</li>
<li><code>:set syn=style</code>设置当前文件对应语法风格的高亮。</li>
</ul></li>
</ol>
<h2 id="git"><strong>git</strong></h2>
<ul>
<li><code>git clone -b branch XXX</code>克隆指定分支的代码</li>
<li><code>git reset --hard 1a703e</code>回滚到某个历史commit</li>
<li><code>git branch -m &lt;branchName&gt;</code>将当前分支名更改为branchName</li>
<li><code>git checkout -b &lt;newbranch&gt;</code>创建新分支并切换到新分支</li>
<li><code>git diff</code>查看修改的差异</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://mitmoksha.github.io/2022/05/16/cpp%20Note/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Pishun Huang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Moksha's Blog">
      <meta itemprop="description" content="Opportunities are ready for it, the more to beat action.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Moksha's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/05/16/cpp%20Note/" class="post-title-link" itemprop="url">Advanced Cpp Note</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-05-16 15:39:40" itemprop="dateCreated datePublished" datetime="2022-05-16T15:39:40+08:00">2022-05-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-05-18 09:15:22" itemprop="dateModified" datetime="2022-05-18T09:15:22+08:00">2022-05-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/PL/" itemprop="url" rel="index"><span itemprop="name">PL</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <span id="more"></span>
<h2 id="一stdfunction和bind绑定器">一、std::function和bind绑定器</h2>
<h3 id="可调用对象">可调用对象</h3>
<ul>
<li>是一个函数指针</li>
<li>是一个具有<code>operator()</code>成员函数的类对象（仿函数）</li>
<li>是一个可被转换为函数指针的类对象</li>
<li>是一个类成员（函数）指针</li>
</ul>
<h3 id="可调用对象包装器stdfuntion">可调用对象包装器std::funtion</h3>
<ul>
<li>头文件<code>&lt;functional&gt;</code></li>
<li>可以容纳除了类成员（函数）指针之外的所有可调用对象</li>
<li>可以用统一的方式处理函数、函数对象、函数指针，并允许保存和延迟执行它们</li>
<li><code>function</code>比普通函数指针更灵活和便利</li>
</ul>
<h3 id="stdbind绑定器">std::bind绑定器</h3>
<ul>
<li>头文件<code>&lt;functional&gt;</code></li>
<li>接受一个可调用对象，生成一个新的可调用对象</li>
<li><code>std::bind</code>用来将可调用对象与其参数一起进行绑定，绑定后的结果可以使用<code>std::function</code>进行保存，并延迟调用到任何我们需要的时候</li>
<li>作用
<ul>
<li>将可调用对象与其参数一起绑定成一个仿函数(functor)</li>
<li>将多元（参数个数为n）可调用对象转成一元或者（n-1）元可调用对象，却只绑定部分参数 <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">std::<span class="built_in">bind</span>(output, <span class="number">1</span>, <span class="number">2</span>)();  <span class="comment">// 输出：1 2</span></span><br><span class="line">std::<span class="built_in">bind</span>(output, std::placeholders::_1, <span class="number">2</span>)(<span class="number">1</span>);  <span class="comment">// 输出 ：1 2</span></span><br><span class="line">std::<span class="built_in">bind</span>(output, <span class="number">2</span>, std::placeholders::_1)(<span class="number">1</span>);  <span class="comment">// 输出 ：2 1</span></span><br></pre></td></tr></table></figure></li>
</ul></li>
<li><code>std::bind</code>的返回类型是一个stl内部定义的仿函数类型</li>
<li><code>std::placeholders::_1</code>是一个占位符，代表这个位置将在函数调用时被传入的第一个参数所替代</li>
<li>组合bind函数
<ul>
<li><code>std::bind(std::greater&lt;int&gt;(), std::placeholders::_1, 5);</code>
<ul>
<li>判断是否大于5的功能闭包</li>
</ul></li>
</ul></li>
</ul>
<h3 id="c11通过提供stdfunction和stdbind统一了可调用对象的各种操作">C++11通过提供std::function和std::bind统一了可调用对象的各种操作</h3>
<h2 id="二lambda表达式">二、lambda表达式</h2>
<h3 id="语法形式">语法形式</h3>
<ul>
<li><code>[ capture ] ( params ) opt -&gt; ret &#123; body; &#125;;</code></li>
<li>C++11允许省略lambda表达式返回值定义，这样编译器就会根据<code>return</code>语句自动推导出返回类型
<ul>
<li>初始化列表不能用于返回值的自动推导</li>
</ul></li>
<li>lambda表达式在没有参数列表时，参数列表是可以省略的</li>
</ul>
<h3 id="捕获列表">捕获列表</h3>
<ul>
<li><code>[]</code>不捕获任何变量</li>
<li><code>[&amp;]</code>捕获外部作用域中所有变量，并作为引用在函数体中使用（引用捕获）</li>
<li><code>[=]</code>捕获外部作用域中所有变量，并作为副本在函数体中使用（按值捕获）</li>
<li><code>[=, &amp;foo]</code>按值捕获外部作用域中所有变量，并按引用捕获foo变量</li>
<li><code>[bar]</code>按值捕获bar变量，同时不捕获其他变量</li>
<li><code>[this]</code>捕获当前类中的指针，让lambda表达式拥有和当前类成员函数同样的访问权限。如果已经使用了<code>&amp;</code>或者<code>=</code>，就默认添加此选项</li>
<li>如果希望去修改按值捕获的外部变量，需要显示指明lambda表达式为<code>mutable</code>，如：<code>auto f2 = [=]() mutable &#123;return a++; &#125;</code></li>
</ul>
<h3 id="可以认为它是个带有operator的类即仿函数">可以认为它是个带有operator()的类，即仿函数</h3>
<ul>
<li>可以使用<code>std::function</code>和<code>std::bind</code>来存储和操作lambda表达式 <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">std::function&lt;<span class="type">int</span>(<span class="type">int</span>)&gt; f1 = [](<span class="type">int</span> a)&#123; <span class="keyword">return</span> a; &#125;;</span><br><span class="line">std::function&lt;<span class="type">int</span>(<span class="type">void</span>)&gt; f2 = std::<span class="built_in">bind</span>([](<span class="type">int</span> a)&#123; <span class="keyword">return</span> a; &#125;, <span class="number">123</span>);</span><br></pre></td></tr></table></figure></li>
<li>对于没有捕获任何变量的lambda表达式，还可以被转换成一个普通的函数指针 <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> <span class="type">func_t</span> = <span class="built_in">int</span> (*)(<span class="type">int</span>);</span><br><span class="line"><span class="type">func_t</span> f = [](<span class="type">int</span>  a)&#123; <span class="keyword">return</span> a; &#125;;</span><br><span class="line"><span class="built_in">f</span>(<span class="number">123</span>);</span><br></pre></td></tr></table></figure></li>
<li>捕获变量的lambda表达式则不能转化为普通指针，若转换，lambda表达式本身的this指针就丢失掉了</li>
<li>lambda和<code>std::function</code>的效果是一样的，一般情况下可直接用lambda来代替<code>function</code></li>
</ul>
<h2 id="三tuple元组">三、tuple元组</h2>
<h3 id="定义">定义</h3>
<ul>
<li>可以把它当作一个通用的结构体来用，不需要创建结构体又获取结构体的特征</li>
<li>在某些情况下可以取代结构体，使程序更简洁、直观</li>
<li>如果用tuple来替代3个以上字段的结构体时就不太合适了，不直观，易读性降低（建议）</li>
</ul>
<h3 id="功能">功能</h3>
<ul>
<li>创建元组
<ul>
<li><code>tuple&lt;const char*, int&gt; tp = make_tuple(sendPack, nSendSize);</code></li>
<li><code>auto tp = return std::tie(1, "aa", 2);</code> // tp的实际类型是：std::tuple&lt;int&amp;, string&amp;, int&amp;&gt;</li>
</ul></li>
<li>获取元组的值 <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">char</span>* data = tp.<span class="built_in">get</span>&lt;<span class="number">0</span>&gt; ();  <span class="comment">// 获取第一个值</span></span><br><span class="line"><span class="type">int</span> len = tp.<span class="built_in">get</span>&lt;<span class="number">1</span>&gt; ();  <span class="comment">// 获取第二个值</span></span><br></pre></td></tr></table></figure>
<ul>
<li>通过<code>std::tie</code>解包tuple <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> x, y;</span><br><span class="line">string a;</span><br><span class="line">std::<span class="built_in">tie</span>(x, a, y) = tp;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果只想了解某个位置的值时，可以用<code>std::ignore</code>占位符来表示不解某个位置的值 <code>std::tie(std::ignore, std::ignore, y) = tp;</code> // 只解第3个值</li>
</ul></li>
</ul></li>
<li>创建右值引用元组
<ul>
<li><code>forward_as_tuple</code> <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">std::map&lt;<span class="type">int</span>, std::string&gt; m;</span><br><span class="line">m.<span class="built_in">emplace</span>(std::forward_as_tuple(<span class="number">10</span>, std::<span class="built_in">string</span>(<span class="number">20</span>, <span class="string">&#x27;a&#x27;</span>)));</span><br></pre></td></tr></table></figure>
<ul>
<li>创建了类似于<code>std::tuple&lt;int&amp;&amp;, std::string&amp;&amp;&gt;</code>类型的tuple</li>
</ul></li>
</ul></li>
<li>连接多个tuple
<ul>
<li><code>tuple_cat</code></li>
</ul></li>
</ul>
<h2 id="四shared_ptr共享的智能指针">四、shared_ptr共享的智能指针</h2>
<h3 id="概念">概念</h3>
<ul>
<li>希望多个智能指针管理同一个资源就用shared_ptr</li>
<li><code>std::shared_ptr</code>使用引用计数，每一个shared_ptr的拷贝都指向相同的内存</li>
<li>在最后一个shared_ptr析构的时候，内存才会被释放</li>
</ul>
<h3 id="基本用法">基本用法</h3>
<ul>
<li>初始化
<ul>
<li>可以通过使用构造函数、<code>std::make_shared&lt;int&gt;</code>辅助函数和<code>reset</code>方法来初始化shared_ptr <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::shared_ptr&lt;<span class="type">int</span>&gt; <span class="title">p</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>(<span class="number">1</span>))</span></span>;  <span class="comment">// 使用动态初始化，后加一个括号为值初始化</span></span><br><span class="line">std::shared_ptr&lt;<span class="type">int</span>&gt; p2 = p;</span><br><span class="line">std::shared_ptr&lt;<span class="type">int</span>&gt; ptr;</span><br><span class="line">ptr.<span class="built_in">reset</span>(<span class="keyword">new</span> <span class="built_in">int</span>(<span class="number">1</span>));</span><br></pre></td></tr></table></figure></li>
<li>不能将一个原始指针直接赋值给智能指针</li>
<li>当智能指针中有值的时候，调用reset会使引用计数减1</li>
</ul></li>
<li>获取原始指针
<ul>
<li>可以通过<code>get</code>方法来返回原始指针 <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::shared_ptr&lt;<span class="type">int</span>&gt; <span class="title">ptr</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>(<span class="number">1</span>))</span></span>;</span><br><span class="line"><span class="type">int</span>* p = ptr.<span class="built_in">get</span>();</span><br></pre></td></tr></table></figure></li>
</ul></li>
<li>指定删除器
<ul>
<li>智能指针初始化可以指定删除器</li>
<li>当p的<code>引用计数</code>为0时，自动调用删除器DeleteIntPtr来释放对象的内存 <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">DeleteIntPtr</span><span class="params">(<span class="type">int</span>* p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">delete</span> p;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">std::shared_ptr&lt;<span class="type">int</span>&gt; <span class="title">p</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>, DeleteIntPtr)</span></span>;</span><br></pre></td></tr></table></figure></li>
<li>也可以用lambda表达式指定删除器
<ul>
<li><code>std::shared_ptr&lt;int&gt; p(new int, [](int* p) &#123; delete p; &#125;);</code></li>
</ul></li>
<li>当我们用<code>shared_ptr</code>管理动态数组时，需要指定删除器，因为<code>std::shared_ptr</code>的默认删除器不支持数组对象</li>
<li>也可以将<code>std::default_delete</code>作为删除器</li>
</ul></li>
</ul>
<h3 id="注意事项">注意事项</h3>
<ul>
<li>1）不要用一个原始指针初始化多个shared_ptr</li>
<li>2）不要在函数实参中创建shared_ptr
<ul>
<li>可能会因为发生异常而泄露内存</li>
</ul></li>
<li>3）通过<code>shared_from_this()</code>返回this指针
<ul>
<li>因为this指针本质上是一个<code>裸指针</code>，因此这样可能会导致重复析构</li>
<li>解决方法
<ul>
<li>让目标类通过派生<code>std::enable_shared_from_this&lt;T&gt;</code>类，然后使用基类的成员函数<code>shared_from_this</code>来返回this的shared_ptr</li>
</ul></li>
</ul></li>
<li>4）要避免循环引用
<ul>
<li>智能指针最大的一个陷阱就是循环引用，循环引用会导致内存泄露</li>
<li>导致意外延长对象的生命期</li>
<li>解决方法
<ul>
<li>使用weak_ptr</li>
</ul></li>
</ul></li>
</ul>
<h2 id="五unique_ptr独占的智能指针">五、unique_ptr独占的智能指针</h2>
<h3 id="概念-1">概念</h3>
<ul>
<li>希望只有一个智能指针管理资源或者管理数组就用unique_ptr</li>
<li>unique_ptr是一个独占型的智能指针</li>
<li>它不允许其他的智能指针共享其内部的指针</li>
<li>不允许通过赋值将一个unique_ptr赋值给另外一个unique_ptr</li>
<li>可以通过<code>std::move</code>来转移到其他的unique_ptr <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">unique_ptr&lt;T&gt; <span class="title">myPtr</span><span class="params">(<span class="keyword">new</span> T)</span></span>;</span><br><span class="line">unique_ptr&lt;T&gt; myOtherPtr = std:: <span class="built_in">move</span>(myptr);</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="注意事项-1">注意事项</h3>
<ul>
<li>如果是数组，则判断是否是定长数组
<ul>
<li>若为定长数组则编译不通过（不能这样调用<code>make_unique&lt;T[10]&gt;(10)</code>)</li>
<li>若为非定长数组，则获取数组中的元素类型，再根据参数size创建动态数组的unique_ptr
<ul>
<li><code>unique_ptr&lt;int[]&gt; ptr5 = make_unique&lt;int[]&gt;(10);</code></li>
</ul></li>
</ul></li>
<li>unique_ptr可以指向数组（而shared_ptr这么做不合法） <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::unique_ptr&lt;<span class="type">int</span> []&gt; <span class="title">ptr</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>[<span class="number">10</span>])</span></span></span><br><span class="line"><span class="function">ptr[9] </span>= <span class="number">9</span>;         <span class="comment">// 设置最后一个元素值为9</span></span><br></pre></td></tr></table></figure></li>
<li>unique_ptr指定删除器的时候需要确定删除器的类型
<ul>
<li><code>std::unique_ptr&lt;int, void(*)(int*)&gt; ptr(new int (1), [](int* p) &#123; delete p; &#125;);</code></li>
<li>lambda表达式在没有捕获变量的情况下是可以直接转换为函数指针的，一旦捕获了就无法转换了
<ul>
<li><code>std::unique_ptr&lt;int, void(*)(int*)&gt; ptr(new int (1), [&amp;](int* p) &#123; delete p; &#125;);</code> // 错误，捕获了变量</li>
</ul></li>
<li>如果希望unique_ptr删除器支持lambda可以这么写
<ul>
<li><code>std::unique_ptr&lt;int, std::function&lt;void(int*)&gt;&gt; ptr(new int(1), [&amp;](int* p) &#123; delete p; &#125;</code></li>
</ul></li>
</ul></li>
</ul>
<h2 id="六weak_ptr弱引用的智能指针">六、weak_ptr弱引用的智能指针</h2>
<h3 id="概念-2">概念</h3>
<ul>
<li>weak_ptr是用来监视shared_ptr的，不会使引用计数加1</li>
<li>它不管理shared_ptr内部的指针，主要是为了监视shared_ptr的生命周期</li>
<li>它的构造不会增加引用计数，它的析构也不会减少引用计数</li>
</ul>
<h3 id="基本用法-1">基本用法</h3>
<ul>
<li>1）通过<code>use_count()</code>方法来获得当前观测资源的引用计数 <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">shared_ptr&lt;<span class="type">int</span>&gt; <span class="title">sp</span><span class="params">(<span class="keyword">new</span> <span class="type">int</span>(<span class="number">10</span>))</span></span>;</span><br><span class="line"><span class="function">weak_ptr&lt;<span class="type">int</span>&gt; <span class="title">wp</span><span class="params">(sp)</span></span>;</span><br><span class="line">cout &lt;&lt; wp.<span class="built_in">use_count</span>() &lt;&lt; endl;  <span class="comment">// 结果将输出1</span></span><br></pre></td></tr></table></figure></li>
<li>2）通过<code>expired()</code>方法来判断所观测的资源是否已经释放（true为无效） <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (wp.<span class="built_in">expired</span>())</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;weak_ptr无效，所监视的智能指针已经被释放&quot;</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;weak_ptr有效&quot;</span>;</span><br></pre></td></tr></table></figure></li>
<li>3）通过<code>lock()</code>方法来获取所监视的shared_ptr <figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> sp = std::<span class="built_in">make_shared</span>&lt;<span class="type">int</span>&gt; (<span class="number">42</span>);</span><br><span class="line">std::weak_ptr&lt;<span class="type">int</span>&gt; gw = sp;</span><br><span class="line"><span class="keyword">auto</span> spt = gw.<span class="built_in">lock</span>();  <span class="comment">// 获取所监视的shared_ptr</span></span><br><span class="line">cout &lt;&lt; *spt &lt;&lt; endl;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="weak_ptr返回this指针">weak_ptr返回this指针</h3>
<ul>
<li><code>std::enable_shared_from_this</code>类中有一个weak_ptr，这个weak_ptr用来观测this智能指针</li>
<li>调用<code>shared_from_this()</code>方法时，会调用内部这个weak_ptr的<code>lock()</code>方法，将所观测的shared_ptr返回</li>
<li>获取自身智能指针的函数仅在<code>shared_ptr&lt;T&gt;</code>的构造函数被调用之后才能使用，因为<code>enable_shared_from_this</code>内部的weak_ptr只有通过shared_ptr才能构造</li>
</ul>
<h3 id="可以通过weak_ptr解决循环引用问题">可以通过weak_ptr解决循环引用问题</h3>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Pishun Huang</span>
</div>

<!--
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>-->

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","//mhchem.github.io/MathJax-mhchem/ mhchem":false,"js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js","integrity":"sha256-r+3itOMtGGjap0x+10hu6jW/gZCzxHsoKrOd7gyRSGY="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
